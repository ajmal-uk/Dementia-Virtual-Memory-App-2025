{
  "lib": {
    "admin": {
      "caretaker": {
        "banned_caretakers.dart": {
          "_text": "import 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:flutter/material.dart';\nimport 'caretaker_detail.dart';\n\nclass BannedCaretakersScreen extends StatefulWidget {\n  const BannedCaretakersScreen({super.key});\n\n  @override\n  State<BannedCaretakersScreen> createState() => _BannedCaretakersScreenState();\n}\n\nclass _BannedCaretakersScreenState extends State<BannedCaretakersScreen> {\n  final TextEditingController _searchController = TextEditingController();\n  String _search = '';\n\n  @override\n  void initState() {\n    super.initState();\n\n    _searchController.addListener(\n      () => setState(() => _search = _searchController.text.toLowerCase()),\n    );\n  }\n\n  Stream<QuerySnapshot> _getBannedUsersStream() {\n    return FirebaseFirestore.instance\n        .collection('caretaker')\n        .orderBy('fullName')\n        .snapshots();\n  }\n\n  Future<void> _unbanUser(String id) async {\n    final confirm = await showDialog<bool>(\n      context: context,\n      builder: (context) => AlertDialog(\n        title: const Text('Unban Caretaker'),\n        content: const Text('Are you sure you want to unban this caretaker?'),\n        actions: [\n          TextButton(\n            onPressed: () => Navigator.pop(context, false),\n            child: const Text('Cancel'),\n          ),\n          ElevatedButton(\n            style: ElevatedButton.styleFrom(backgroundColor: Colors.green),\n            onPressed: () => Navigator.pop(context, true),\n            child: const Text('Unban'),\n          ),\n        ],\n      ),\n    );\n\n    if (confirm == true) {\n      await FirebaseFirestore.instance\n          .collection('caretaker')\n          .doc(id)\n          .update({'isBanned': false});\n\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('User unbanned')),\n        );\n      }\n    }\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: AppBar(title: const Text('Banned Caretakers')),\n      body: Column(\n        children: [\n          Padding(\n            padding: const EdgeInsets.all(16.0),\n            child: TextField(\n              controller: _searchController,\n              decoration: InputDecoration(\n                hintText: 'Search by username...',\n                filled: true,\n                fillColor: Colors.white,\n                border: OutlineInputBorder(\n                  borderRadius: BorderRadius.circular(12),\n                  borderSide: BorderSide.none,\n                ),\n                prefixIcon: const Icon(Icons.search, color: Colors.blueAccent),\n              ),\n            ),\n          ),\n\n          Expanded(\n            child: StreamBuilder<QuerySnapshot>(\n              stream: _getBannedUsersStream(),\n              builder: (context, snapshot) {\n                if (snapshot.connectionState == ConnectionState.waiting) {\n                  return const Center(child: CircularProgressIndicator());\n                }\n                if (snapshot.hasError) {\n                  return Center(child: Text('Error: ${snapshot.error}'));\n                }\n\n                final docs = snapshot.data?.docs ?? [];\n\n                final bannedDocs = docs.where((doc) {\n                  final data = doc.data() as Map<String, dynamic>;\n                  return data['isBanned'] == true;\n                }).toList();\n\n                final filteredDocs = bannedDocs.where((doc) {\n                  final data = doc.data() as Map<String, dynamic>;\n                  final username =\n                      (data['username'] as String?)?.toLowerCase() ?? '';\n                  return username.contains(_search);\n                }).toList();\n\n                if (filteredDocs.isEmpty) {\n                  return const Center(child: Text('No banned users'));\n                }\n\n                return ListView.builder(\n                  itemCount: filteredDocs.length,\n                  itemBuilder: (context, index) {\n                    final doc = filteredDocs[index];\n                    final data = doc.data() as Map<String, dynamic>;\n\n                    return Card(\n                      elevation: 3,\n                      margin: const EdgeInsets.symmetric(\n                        vertical: 6,\n                        horizontal: 12,\n                      ),\n                      shape: RoundedRectangleBorder(\n                        borderRadius: BorderRadius.circular(12),\n                      ),\n                      child: ListTile(\n                        leading: CircleAvatar(\n                          backgroundImage: (data['profileImageUrl'] != null &&\n                                  data['profileImageUrl'].isNotEmpty)\n                              ? NetworkImage(data['profileImageUrl'])\n                              : null,\n                          child: (data['profileImageUrl'] == null ||\n                                  data['profileImageUrl'].isEmpty)\n                              ? const Icon(Icons.person)\n                              : null,\n                        ),\n                        title: Text(data['fullName'] ?? 'Unnamed'),\n                        subtitle: Text('@${data['username'] ?? ''}'),\n                        trailing: IconButton(\n                          icon: const Icon(Icons.restore, color: Colors.green),\n                          onPressed: () => _unbanUser(doc.id),\n                        ),\n                        onTap: () => Navigator.push(\n                          context,\n                          MaterialPageRoute(\n                            builder: (context) =>\n                                CaretakerDetailScreen(caretakerId: doc.id),\n                          ),\n                        ),\n                      ),\n                    );\n                  },\n                );\n              },\n            ),\n          ),\n        ],\n      ),\n    );\n  }\n\n  @override\n  void dispose() {\n    _searchController.dispose();\n    super.dispose();\n  }\n}\n",
          "_encoding": "utf-8"
        },
        "caretaker_detail.dart": {
          "_text": "import 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:flutter/material.dart';\nimport '../../utils/notification_helper.dart';\n\nclass CaretakerDetailScreen extends StatefulWidget {\n  final String caretakerId;\n  const CaretakerDetailScreen({super.key, required this.caretakerId});\n\n  @override\n  State<CaretakerDetailScreen> createState() => _CaretakerDetailScreenState();\n}\n\nclass _CaretakerDetailScreenState extends State<CaretakerDetailScreen> {\n  Map<String, dynamic>? _caretakerData;\n  Map<String, dynamic>? _userData;\n  bool _isLoading = true;\n  bool _hasError = false;\n  final _firestore = FirebaseFirestore.instance;\n  final TextEditingController _titleController = TextEditingController();\n  final TextEditingController _messageController = TextEditingController();\n\n  @override\n  void initState() {\n    super.initState();\n    _loadCaretakerData();\n  }\n\n  Future<void> _loadCaretakerData() async {\n    setState(() {\n      _isLoading = true;\n      _hasError = false;\n    });\n\n    try {\n      final caretakerDoc = await _firestore.collection('caretaker').doc(widget.caretakerId).get();\n      if (caretakerDoc.exists) {\n        _caretakerData = caretakerDoc.data();\n        final connectionId = _caretakerData?['currentConnectionId'];\n        if (connectionId != null) {\n          final connectionDoc = await _firestore.collection('connections').doc(connectionId).get();\n          final userUid = connectionDoc.data()?['user_uid'];\n          if (userUid != null) {\n            final userDoc = await _firestore.collection('user').doc(userUid).get();\n            _userData = userDoc.data();\n          }\n        }\n      } else {\n        _hasError = true;\n      }\n    } catch (e) {\n      _hasError = true;\n    } finally {\n      setState(() => _isLoading = false);\n    }\n  }\n\n  Future<void> _unbindConnection() async {\n    final confirm = await showDialog<bool>(\n      context: context,\n      builder: (_) => AlertDialog(\n        title: const Text('Unbind Connection'),\n        content: const Text('Are you sure you want to unbind this caretaker from their user?'),\n        actions: [\n          TextButton(onPressed: () => Navigator.pop(context, false), child: const Text('Cancel')),\n          ElevatedButton(\n            style: ElevatedButton.styleFrom(backgroundColor: Colors.red),\n            onPressed: () => Navigator.pop(context, true),\n            child: const Text('Unbind'),\n          ),\n        ],\n      ),\n    );\n\n    if (confirm == true) {\n      try {\n        final connectionId = _caretakerData?['currentConnectionId'];\n        if (connectionId != null) {\n          await _firestore.collection('connections').doc(connectionId).update({'status': 'unbound'});\n          await _firestore.collection('caretaker').doc(widget.caretakerId).update({\n            'isConnected': false,\n            'currentConnectionId': null,\n          });\n          final userUid = _userData?['uid'];\n          if (userUid != null) {\n            await _firestore.collection('user').doc(userUid).update({\n              'isConnected': false,\n              'currentConnectionId': null,\n            });\n          }\n\n          final caretakerPlayerIds = List<String>.from(_caretakerData?['playerIds'] ?? []);\n          final userPlayerIds = List<String>.from(_userData?['playerIds'] ?? []);\n          await sendNotification(caretakerPlayerIds, 'Your connection has been unbound by admin.');\n          await sendNotification(userPlayerIds, 'Your connection has been unbound by admin.');\n\n          // Add to Firestore notifications\n          await _firestore.collection('caretaker').doc(widget.caretakerId).collection('notifications').add({\n            'type': 'admin',\n            'message': 'Your connection has been unbound by admin.',\n            'createdAt': Timestamp.now(),\n            'isRead': false,\n          });\n          if (userUid != null) {\n            await _firestore.collection('user').doc(userUid).collection('notifications').add({\n              'type': 'admin',\n              'message': 'Your connection has been unbound by admin.',\n              'createdAt': Timestamp.now(),\n              'isRead': false,\n            });\n          }\n\n          if (mounted) {\n            ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Connection unbound')));\n          }\n          _loadCaretakerData();\n        }\n      } catch (e) {\n        if (mounted) {\n          ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Error: $e')));\n        }\n      }\n    }\n  }\n\n  Future<void> _banCaretaker() async {\n    final reasonController = TextEditingController();\n    final confirm = await showDialog<bool>(\n      context: context,\n      builder: (_) => AlertDialog(\n        title: const Text('Ban Caretaker'),\n        content: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            const Text('Enter ban reason:'),\n            TextField(controller: reasonController, decoration: const InputDecoration(hintText: 'Reason')),\n          ],\n        ),\n        actions: [\n          TextButton(onPressed: () => Navigator.pop(context, false), child: const Text('Cancel')),\n          ElevatedButton(\n            style: ElevatedButton.styleFrom(backgroundColor: Colors.red),\n            onPressed: () => Navigator.pop(context, true),\n            child: const Text('Ban'),\n          ),\n        ],\n      ),\n    );\n\n    if (confirm == true) {\n      try {\n        await _firestore.collection('caretaker').doc(widget.caretakerId).update({'isBanned': true});\n        if (_caretakerData?['isConnected'] == true) {\n          _unbindConnection();\n        }\n        final caretakerPlayerIds = List<String>.from(_caretakerData?['playerIds'] ?? []);\n        await sendNotification(caretakerPlayerIds, 'Your account has been banned. Reason: ${reasonController.text}');\n        // Add to Firestore notifications\n        await _firestore.collection('caretaker').doc(widget.caretakerId).collection('notifications').add({\n          'type': 'admin',\n          'message': 'Your account has been banned. Reason: ${reasonController.text}',\n          'createdAt': Timestamp.now(),\n          'isRead': false,\n        });\n        if (mounted) {\n          ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Caretaker banned')));\n        }\n        _loadCaretakerData();\n      } catch (e) {\n        if (mounted) {\n          ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Error: $e')));\n        }\n      }\n    }\n  }\n\n  Future<void> _approveCaretaker() async {\n    await _firestore.collection('caretaker').doc(widget.caretakerId).update({'isApprove': true});\n    if (mounted) {\n      ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Caretaker approved')));\n    }\n    _loadCaretakerData();\n  }\n\n  Future<void> _sendNotification() async {\n    final confirm = await showDialog<bool>(\n      context: context,\n      builder: (_) => AlertDialog(\n        title: const Text('Send Notification'),\n        content: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            TextField(controller: _titleController, decoration: const InputDecoration(labelText: 'Title')),\n            TextField(controller: _messageController, decoration: const InputDecoration(labelText: 'Message')),\n          ],\n        ),\n        actions: [\n          TextButton(onPressed: () => Navigator.pop(context, false), child: const Text('Cancel')),\n          ElevatedButton(onPressed: () => Navigator.pop(context, true), child: const Text('Send')),\n        ],\n      ),\n    );\n\n    if (confirm == true) {\n      try {\n        final playerIds = List<String>.from(_caretakerData?['playerIds'] ?? []);\n        await sendNotification(playerIds, '${_titleController.text}: ${_messageController.text}');\n        // Add to Firestore notifications\n        await _firestore.collection('caretaker').doc(widget.caretakerId).collection('notifications').add({\n          'type': 'admin',\n          'message': '${_titleController.text}: ${_messageController.text}',\n          'createdAt': Timestamp.now(),\n          'isRead': false,\n        });\n        if (mounted) {\n          ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Notification sent')));\n        }\n      } catch (e) {\n        if (mounted) {\n          ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Error: $e')));\n        }\n      }\n    }\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    if (_isLoading) return const Scaffold(body: Center(child: CircularProgressIndicator()));\n    if (_hasError) return const Scaffold(body: Center(child: Text('Error loading caretaker data')));\n\n    return Scaffold(\n      appBar: AppBar(title: const Text('Caretaker Details'), actions: [\n        IconButton(icon: const Icon(Icons.notifications), onPressed: _sendNotification),\n        IconButton(icon: const Icon(Icons.block), onPressed: _banCaretaker),\n        if (_caretakerData?['isConnected'] == true)\n          IconButton(icon: const Icon(Icons.link_off), onPressed: _unbindConnection),\n        if (_caretakerData?['isApprove'] == false)\n          IconButton(icon: const Icon(Icons.check), onPressed: _approveCaretaker),\n      ]),\n      body: SingleChildScrollView(\n        padding: const EdgeInsets.all(16),\n        child: Column(\n          crossAxisAlignment: CrossAxisAlignment.start,\n          children: [\n            Text('Name: ${_caretakerData?['fullName']}'),\n            Text('Type: ${_caretakerData?['caregiverType']}'),\n            if (_userData != null) ...[\n              const SizedBox(height: 20),\n              const Text('Connected User:'),\n              Text('Name: ${_userData?['fullName']}'),\n            ],\n          ],\n        ),\n      ),\n    );\n  }\n}",
          "_encoding": "utf-8"
        },
        "caretakers_screen.dart": {
          "_text": "import 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:flutter/material.dart';\nimport 'caretaker_detail.dart';\nimport 'banned_caretakers.dart';\n\nclass CaretakersScreen extends StatefulWidget {\n  const CaretakersScreen({super.key});\n\n  @override\n  State<CaretakersScreen> createState() => _CaretakersScreenState();\n}\n\nclass _CaretakersScreenState extends State<CaretakersScreen> {\n  final TextEditingController _searchController = TextEditingController();\n  String _search = '';\n  String _selectedTab = 'Approved';\n\n  @override\n  void initState() {\n    super.initState();\n    _searchController.addListener(\n      () => setState(() => _search = _searchController.text.toLowerCase()),\n    );\n  }\n\n  Stream<QuerySnapshot> _getCaretakersStream() {\n    return FirebaseFirestore.instance\n        .collection('caretaker')\n        .orderBy('fullName')\n        .snapshots();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text('Caretakers'),\n        backgroundColor: Colors.blueAccent,\n        elevation: 0,\n        actions: [\n          IconButton(\n            icon: const Icon(Icons.block),\n            onPressed: () => Navigator.push(\n              context,\n              MaterialPageRoute(\n                builder: (context) => const BannedCaretakersScreen(),\n              ),\n            ),\n          ),\n        ],\n      ),\n      body: Container(\n        decoration: BoxDecoration(\n          gradient: LinearGradient(\n            begin: Alignment.topCenter,\n            end: Alignment.bottomCenter,\n            colors: [\n              Colors.blueAccent.withOpacity(0.1),\n              Colors.white,\n            ],\n          ),\n        ),\n        child: Column(\n          children: [\n            Padding(\n              padding: const EdgeInsets.all(16.0),\n              child: TextField(\n                controller: _searchController,\n                decoration: InputDecoration(\n                  hintText: 'Search by username...',\n                  filled: true,\n                  fillColor: Colors.white,\n                  border: OutlineInputBorder(\n                    borderRadius: BorderRadius.circular(12),\n                    borderSide: BorderSide.none,\n                  ),\n                  prefixIcon: const Icon(Icons.search, color: Colors.blueAccent),\n                ),\n              ),\n            ),\n            Row(\n              mainAxisAlignment: MainAxisAlignment.center,\n              children: [\n                ChoiceChip(\n                  label: const Text('Approved'),\n                  selected: _selectedTab == 'Approved',\n                  onSelected: (sel) {\n                    if (sel) setState(() => _selectedTab = 'Approved');\n                  },\n                ),\n                const SizedBox(width: 8),\n                ChoiceChip(\n                  label: const Text('Unapproved'),\n                  selected: _selectedTab == 'Unapproved',\n                  onSelected: (sel) {\n                    if (sel) setState(() => _selectedTab = 'Unapproved');\n                  },\n                ),\n              ],\n            ),\n            Expanded(\n              child: StreamBuilder<QuerySnapshot>(\n                stream: _getCaretakersStream(),\n                builder: (context, snapshot) {\n                  if (snapshot.connectionState == ConnectionState.waiting) {\n                    return const Center(child: CircularProgressIndicator());\n                  }\n                  if (snapshot.hasError) {\n                    return Center(child: Text('Error: ${snapshot.error}'));\n                  }\n\n                  final docs = snapshot.data?.docs ?? [];\n                  final approveFiltered = docs.where((doc) {\n                    final data = doc.data() as Map<String, dynamic>;\n                    return data['isApprove'] == (_selectedTab == 'Approved');\n                  }).toList();\n                  final filteredDocs = approveFiltered.where((doc) {\n                    final data = doc.data() as Map<String, dynamic>;\n                    final username =\n                        (data['username'] as String?)?.toLowerCase() ?? '';\n                    return username.contains(_search);\n                  }).toList();\n\n                  if (filteredDocs.isEmpty) {\n                    return const Center(child: Text('No caretakers found'));\n                  }\n\n                  return ListView.builder(\n                    itemCount: filteredDocs.length,\n                    itemBuilder: (context, index) {\n                      final doc = filteredDocs[index];\n                      final data = doc.data() as Map<String, dynamic>;\n\n                      return Card(\n                        elevation: 3,\n                        margin: const EdgeInsets.symmetric(\n                          vertical: 6,\n                          horizontal: 12,\n                        ),\n                        shape: RoundedRectangleBorder(\n                          borderRadius: BorderRadius.circular(12),\n                        ),\n                        child: ListTile(\n                          leading: CircleAvatar(\n                            backgroundImage: (data['profileImageUrl'] != null &&\n                                    data['profileImageUrl'].isNotEmpty)\n                                ? NetworkImage(data['profileImageUrl'])\n                                : null,\n                            child: (data['profileImageUrl'] == null ||\n                                    data['profileImageUrl'].isEmpty)\n                                ? const Icon(Icons.person)\n                                : null,\n                          ),\n                          title: Text(data['fullName'] ?? 'Unnamed'),\n                          subtitle: Text('@${data['username'] ?? ''}'),\n                          onTap: () => Navigator.push(\n                            context,\n                            MaterialPageRoute(\n                              builder: (context) =>\n                                  CaretakerDetailScreen(caretakerId: doc.id),\n                            ),\n                          ),\n                        ),\n                      );\n                    },\n                  );\n                },\n              ),\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  @override\n  void dispose() {\n    _searchController.dispose();\n    super.dispose();\n  }\n}\n",
          "_encoding": "utf-8"
        }
      },
      "user": {
        "banned_users.dart": {
          "_text": "import 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:flutter/material.dart';\nimport 'user_detail.dart';\n\nclass BannedUsersScreen extends StatefulWidget {\n  const BannedUsersScreen({super.key});\n\n  @override\n  State<BannedUsersScreen> createState() => _BannedUsersScreenState();\n}\n\nclass _BannedUsersScreenState extends State<BannedUsersScreen> {\n  final TextEditingController _searchController = TextEditingController();\n  String _search = '';\n\n  @override\n  void initState() {\n    super.initState();\n\n    _searchController.addListener(\n      () => setState(() => _search = _searchController.text.toLowerCase()),\n    );\n  }\n\n  Stream<QuerySnapshot> _getBannedUsersStream() {\n    return FirebaseFirestore.instance\n        .collection('user')\n        .orderBy('fullName')\n        .snapshots();\n  }\n\n  Future<void> _unbanUser(String id) async {\n    final confirm = await showDialog<bool>(\n      context: context,\n      builder: (BuildContext context) => AlertDialog(\n        title: const Text('Unban User'),\n        content: const Text('Are you sure you want to unban this user?'),\n        actions: [\n          TextButton(\n            onPressed: () => Navigator.pop(context, false),\n            child: const Text('Cancel'),\n          ),\n          ElevatedButton(\n            style: ElevatedButton.styleFrom(backgroundColor: Colors.green),\n            onPressed: () => Navigator.pop(context, true),\n            child: const Text('Unban'),\n          ),\n        ],\n      ),\n    );\n\n    if (confirm == true) {\n      await FirebaseFirestore.instance\n          .collection('user')\n          .doc(id)\n          .update({'isBanned': false});\n\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('User unbanned')),\n        );\n      }\n    }\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: AppBar(title: const Text('Banned Users')),\n      body: Column(\n        children: [\n          Padding(\n            padding: const EdgeInsets.all(16.0),\n            child: TextField(\n              controller: _searchController,\n              decoration: InputDecoration(\n                hintText: 'Search by username...',\n                filled: true,\n                fillColor: Colors.white,\n                border: OutlineInputBorder(\n                  borderRadius: BorderRadius.circular(12),\n                  borderSide: BorderSide.none,\n                ),\n                prefixIcon: const Icon(Icons.search, color: Colors.blueAccent),\n              ),\n            ),\n          ),\n\n          Expanded(\n            child: StreamBuilder<QuerySnapshot>(\n              stream: _getBannedUsersStream(),\n              builder: (context, snapshot) {\n                if (snapshot.connectionState == ConnectionState.waiting) {\n                  return const Center(child: CircularProgressIndicator());\n                }\n                if (snapshot.hasError) {\n                  return Center(child: Text('Error: ${snapshot.error}'));\n                }\n\n                final docs = snapshot.data?.docs ?? [];\n                final bannedDocs = docs.where((doc) {\n                  final data = doc.data() as Map<String, dynamic>;\n                  return data['isBanned'] == true;\n                }).toList();\n\n                final filteredDocs = bannedDocs.where((doc) {\n                  final data = doc.data() as Map<String, dynamic>;\n                  final username =\n                      (data['username'] as String?)?.toLowerCase() ?? '';\n                  return username.contains(_search);\n                }).toList();\n\n                if (filteredDocs.isEmpty) {\n                  return const Center(child: Text('No banned users'));\n                }\n\n                return ListView.builder(\n                  itemCount: filteredDocs.length,\n                  itemBuilder: (context, index) {\n                    final doc = filteredDocs[index];\n                    final data = doc.data() as Map<String, dynamic>;\n\n                    return Card(\n                      elevation: 3,\n                      margin: const EdgeInsets.symmetric(\n                        vertical: 6,\n                        horizontal: 12,\n                      ),\n                      shape: RoundedRectangleBorder(\n                        borderRadius: BorderRadius.circular(12),\n                      ),\n                      child: ListTile(\n                        leading: CircleAvatar(\n                          backgroundImage: (data['profileImageUrl'] != null &&\n                                  data['profileImageUrl'].isNotEmpty)\n                              ? NetworkImage(data['profileImageUrl'])\n                              : null,\n                          child: (data['profileImageUrl'] == null ||\n                                  data['profileImageUrl'].isEmpty)\n                              ? const Icon(Icons.person)\n                              : null,\n                        ),\n                        title: Text(data['fullName'] ?? 'Unnamed'),\n                        subtitle: Text('@${data['username'] ?? ''}'),\n                        trailing: IconButton(\n                          icon: const Icon(Icons.restore, color: Colors.green),\n                          onPressed: () => _unbanUser(doc.id),\n                        ),\n                        onTap: () => Navigator.push(\n                          context,\n                          MaterialPageRoute(\n                            builder: (context) =>\n                                UserDetailScreen(userId: doc.id),\n                          ),\n                        ),\n                      ),\n                    );\n                  },\n                );\n              },\n            ),\n          ),\n        ],\n      ),\n    );\n  }\n\n  @override\n  void dispose() {\n    _searchController.dispose();\n    super.dispose();\n  }\n}\n",
          "_encoding": "utf-8"
        },
        "user_detail.dart": {
          "_text": "import 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:flutter/material.dart';\nimport 'package:intl/intl.dart';\nimport '../../utils/notification_helper.dart';\n\nclass UserDetailScreen extends StatefulWidget {\n  final String userId;\n  const UserDetailScreen({super.key, required this.userId});\n\n  @override\n  State<UserDetailScreen> createState() => _UserDetailScreenState();\n}\n\nclass _UserDetailScreenState extends State<UserDetailScreen> {\n  Map<String, dynamic>? _userData;\n  Map<String, dynamic>? _caretakerData;\n  bool _isLoading = true;\n  bool _hasError = false;\n  final _firestore = FirebaseFirestore.instance;\n  final TextEditingController _titleController = TextEditingController();\n  final TextEditingController _messageController = TextEditingController();\n\n  @override\n  void initState() {\n    super.initState();\n    _loadUserData();\n  }\n\n  Future<void> _loadUserData() async {\n    setState(() {\n      _isLoading = true;\n      _hasError = false;\n    });\n\n    try {\n      final userDoc = await _firestore.collection('user').doc(widget.userId).get();\n      if (userDoc.exists) {\n        _userData = userDoc.data();\n        final connectionId = _userData?['currentConnectionId'];\n        if (connectionId != null) {\n          final connectionDoc = await _firestore.collection('connections').doc(connectionId).get();\n          final caretakerUid = connectionDoc.data()?['caretaker_uid'];\n          if (caretakerUid != null) {\n            final caretakerDoc = await _firestore.collection('caretaker').doc(caretakerUid).get();\n            _caretakerData = caretakerDoc.data();\n          }\n        }\n      } else {\n        _hasError = true;\n      }\n    } catch (e) {\n      _hasError = true;\n    } finally {\n      setState(() => _isLoading = false);\n    }\n  }\n\n  Future<void> _unbindConnection() async {\n    final confirm = await showDialog<bool>(\n      context: context,\n      builder: (_) => AlertDialog(\n        title: const Text('Unbind Connection'),\n        content: const Text('Are you sure you want to unbind this user from their caretaker?'),\n        actions: [\n          TextButton(onPressed: () => Navigator.pop(context, false), child: const Text('Cancel')),\n          ElevatedButton(\n            style: ElevatedButton.styleFrom(backgroundColor: Colors.red),\n            onPressed: () => Navigator.pop(context, true),\n            child: const Text('Unbind'),\n          ),\n        ],\n      ),\n    );\n\n    if (confirm == true) {\n      try {\n        final connectionId = _userData?['currentConnectionId'];\n        if (connectionId != null) {\n          await _firestore.collection('connections').doc(connectionId).update({'status': 'unbound'});\n          await _firestore.collection('user').doc(widget.userId).update({\n            'isConnected': false,\n            'currentConnectionId': null,\n          });\n          final caretakerUid = _caretakerData?['uid'];\n          if (caretakerUid != null) {\n            await _firestore.collection('caretaker').doc(caretakerUid).update({\n              'isConnected': false,\n              'currentConnectionId': null,\n            });\n          }\n\n          // Notify both via push\n          final userPlayerIds = List<String>.from(_userData?['playerIds'] ?? []);\n          final caretakerPlayerIds = List<String>.from(_caretakerData?['playerIds'] ?? []);\n          await sendNotification(userPlayerIds, 'Your connection has been unbound by admin.');\n          await sendNotification(caretakerPlayerIds, 'Your connection has been unbound by admin.');\n\n          // Add to Firestore notifications\n          await _firestore.collection('user').doc(widget.userId).collection('notifications').add({\n            'type': 'admin',\n            'message': 'Your connection has been unbound by admin.',\n            'createdAt': Timestamp.now(),\n            'isRead': false,\n          });\n          if (caretakerUid != null) {\n            await _firestore.collection('caretaker').doc(caretakerUid).collection('notifications').add({\n              'type': 'admin',\n              'message': 'Your connection has been unbound by admin.',\n              'createdAt': Timestamp.now(),\n              'isRead': false,\n            });\n          }\n\n          ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Connection unbound')));\n          _loadUserData();\n        }\n      } catch (e) {\n        ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Error: $e')));\n      }\n    }\n  }\n\n  Future<void> _banUser() async {\n    final reasonController = TextEditingController();\n    final confirm = await showDialog<bool>(\n      context: context,\n      builder: (_) => AlertDialog(\n        title: const Text('Ban User'),\n        content: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            const Text('Enter ban reason:'),\n            TextField(controller: reasonController, decoration: const InputDecoration(hintText: 'Reason')),\n          ],\n        ),\n        actions: [\n          TextButton(onPressed: () => Navigator.pop(context, false), child: const Text('Cancel')),\n          ElevatedButton(\n            style: ElevatedButton.styleFrom(backgroundColor: Colors.red),\n            onPressed: () => Navigator.pop(context, true),\n            child: const Text('Ban'),\n          ),\n        ],\n      ),\n    );\n\n    if (confirm == true) {\n      try {\n        await _firestore.collection('user').doc(widget.userId).update({'isBanned': true});\n        // Unbind if connected\n        if (_userData?['isConnected'] == true) {\n          _unbindConnection();\n        }\n        // Notify user via push\n        final userPlayerIds = List<String>.from(_userData?['playerIds'] ?? []);\n        await sendNotification(userPlayerIds, 'Your account has been banned. Reason: ${reasonController.text}');\n        // Add to Firestore notifications\n        await _firestore.collection('user').doc(widget.userId).collection('notifications').add({\n          'type': 'admin',\n          'message': 'Your account has been banned. Reason: ${reasonController.text}',\n          'createdAt': Timestamp.now(),\n          'isRead': false,\n        });\n        ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('User banned')));\n        _loadUserData();\n      } catch (e) {\n        ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Error: $e')));\n      }\n    }\n  }\n\n  Future<void> _sendNotification() async {\n    final confirm = await showDialog<bool>(\n      context: context,\n      builder: (_) => AlertDialog(\n        title: const Text('Send Notification'),\n        content: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            TextField(controller: _titleController, decoration: const InputDecoration(labelText: 'Title')),\n            TextField(controller: _messageController, decoration: const InputDecoration(labelText: 'Message')),\n          ],\n        ),\n        actions: [\n          TextButton(onPressed: () => Navigator.pop(context, false), child: const Text('Cancel')),\n          ElevatedButton(onPressed: () => Navigator.pop(context, true), child: const Text('Send')),\n        ],\n      ),\n    );\n\n    if (confirm == true) {\n      try {\n        final playerIds = List<String>.from(_userData?['playerIds'] ?? []);\n        await sendNotification(playerIds, '${_titleController.text}: ${_messageController.text}');\n        // Add to Firestore notifications\n        await _firestore.collection('user').doc(widget.userId).collection('notifications').add({\n          'type': 'admin',\n          'message': '${_titleController.text}: ${_messageController.text}',\n          'createdAt': Timestamp.now(),\n          'isRead': false,\n        });\n        ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Notification sent')));\n      } catch (e) {\n        ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Error: $e')));\n      }\n    }\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    if (_isLoading) return const Scaffold(body: Center(child: CircularProgressIndicator()));\n    if (_hasError) return const Scaffold(body: Center(child: Text('Error loading user data')));\n\n    return Scaffold(\n      appBar: AppBar(title: const Text('User Details'), actions: [\n        IconButton(icon: const Icon(Icons.notifications), onPressed: _sendNotification),\n        IconButton(icon: const Icon(Icons.block), onPressed: _banUser),\n        if (_userData?['isConnected'] == true)\n          IconButton(icon: const Icon(Icons.link_off), onPressed: _unbindConnection),\n      ]),\n      body: SingleChildScrollView(\n        padding: const EdgeInsets.all(16),\n        child: Column(\n          crossAxisAlignment: CrossAxisAlignment.start,\n          children: [\n            // User details\n            Text('Name: ${_userData?['fullName']}'),\n            Text('Username: ${_userData?['username']}'),\n            Text('Email: ${_userData?['email']}'),\n            Text('Phone: ${_userData?['phoneNo']}'),\n            Text('DOB: ${_userData?['dob'] != null ? DateFormat('yyyy-MM-dd').format(_userData?['dob'].toDate()) : ''}'),\n            Text('Gender: ${_userData?['gender']}'),\n            Text('Bio: ${_userData?['bio']}'),\n            Text('Locality: ${_userData?['locality']}'),\n            Text('City: ${_userData?['city']}'),\n            Text('State: ${_userData?['state']}'),\n            if (_caretakerData != null) ...[\n              const SizedBox(height: 20),\n              const Text('Connected Caretaker:'),\n              Text('Name: ${_caretakerData?['fullName']}'),\n              Text('Type: ${_caretakerData?['caregiverType']}'),\n            ],\n          ],\n        ),\n      ),\n    );\n  }\n}",
          "_encoding": "utf-8"
        },
        "users_screen.dart": {
          "_text": "import 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:flutter/material.dart';\nimport 'user_detail.dart';\nimport 'banned_users.dart';\n\nclass UsersScreen extends StatefulWidget {\n  const UsersScreen({super.key});\n\n  @override\n  State<UsersScreen> createState() => _UsersScreenState();\n}\n\nclass _UsersScreenState extends State<UsersScreen> {\n  final TextEditingController _searchController = TextEditingController();\n  String _search = '';\n\n  @override\n  void initState() {\n    super.initState();\n    _searchController.addListener(\n      () => setState(() => _search = _searchController.text.toLowerCase()),\n    );\n  }\n\n  Stream<QuerySnapshot> _getUsersStream() {\n    return FirebaseFirestore.instance\n        .collection('user')\n        .orderBy('fullName')\n        .snapshots();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text('Users'),\n        backgroundColor: Colors.blueAccent,\n        elevation: 0,\n        actions: [\n          IconButton(\n            icon: const Icon(Icons.block),\n            onPressed: () => Navigator.push(\n              context,\n              MaterialPageRoute(\n                builder: (context) => const BannedUsersScreen(),\n              ),\n            ),\n          ),\n        ],\n      ),\n      body: Container(\n        decoration: BoxDecoration(\n          gradient: LinearGradient(\n            begin: Alignment.topCenter,\n            end: Alignment.bottomCenter,\n            colors: [Colors.blueAccent.withOpacity(0.1), Colors.white],\n          ),\n        ),\n        child: Column(\n          children: [\n            Padding(\n              padding: const EdgeInsets.all(16.0),\n              child: TextField(\n                controller: _searchController,\n                decoration: InputDecoration(\n                  hintText: 'Search by username...',\n                  filled: true,\n                  fillColor: Colors.white,\n                  border: OutlineInputBorder(\n                    borderRadius: BorderRadius.circular(12),\n                    borderSide: BorderSide.none,\n                  ),\n                  prefixIcon:\n                      const Icon(Icons.search, color: Colors.blueAccent),\n                ),\n              ),\n            ),\n            Expanded(\n              child: StreamBuilder<QuerySnapshot>(\n                stream: _getUsersStream(),\n                builder: (context, snapshot) {\n                  if (snapshot.connectionState == ConnectionState.waiting) {\n                    return const Center(child: CircularProgressIndicator());\n                  }\n                  if (snapshot.hasError) {\n                    return Center(child: Text('Error: ${snapshot.error}'));\n                  }\n\n                  final docs = snapshot.data?.docs ?? [];\n\n                  final filteredDocs = docs.where((doc) {\n                    final data = doc.data() as Map<String, dynamic>;\n                    final username =\n                        (data['username'] as String?)?.toLowerCase() ?? '';\n                    return username.contains(_search);\n                  }).toList();\n\n                  if (filteredDocs.isEmpty) {\n                    return const Center(child: Text('No users found'));\n                  }\n\n                  return ListView.builder(\n                    itemCount: filteredDocs.length,\n                    itemBuilder: (context, index) {\n                      final doc = filteredDocs[index];\n                      final data = doc.data() as Map<String, dynamic>;\n                      final profileImageUrl = data['profileImageUrl'] as String?;\n\n                      return Card(\n                        elevation: 3,\n                        shape: RoundedRectangleBorder(\n                          borderRadius: BorderRadius.circular(12),\n                        ),\n                        child: ListTile(\n                          leading: CircleAvatar(\n                            backgroundImage: (profileImageUrl != null &&\n                                    profileImageUrl.isNotEmpty)\n                                ? NetworkImage(profileImageUrl)\n                                : null,\n                            child: (profileImageUrl == null ||\n                                    profileImageUrl.isEmpty)\n                                ? const Icon(Icons.person)\n                                : null,\n                          ),\n                          title: Text(data['fullName'] ?? 'Unnamed'),\n                          subtitle: Text('@${data['username'] ?? ''}'),\n                          onTap: () => Navigator.push(\n                            context,\n                            MaterialPageRoute(\n                              builder: (context) =>\n                                  UserDetailScreen(userId: doc.id),\n                            ),\n                          ),\n                        ),\n                      );\n                    },\n                  );\n                },\n              ),\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  @override\n  void dispose() {\n    _searchController.dispose();\n    super.dispose();\n  }\n}\n",
          "_encoding": "utf-8"
        }
      },
      "admin_bottom_nav.dart": {
        "_text": "// New file: lib/admin/admin_bottom_nav.dart\nimport 'package:flutter/material.dart';\nimport 'user/users_screen.dart';\nimport 'caretaker/caretakers_screen.dart';\nimport 'reports_screen.dart';\nimport 'notifications_screen.dart';\nimport 'settings_screen.dart';\n\nclass AdminBottomNav extends StatefulWidget {\n  const AdminBottomNav({super.key});\n\n  @override\n  State<AdminBottomNav> createState() => _AdminBottomNavState();\n}\n\nclass _AdminBottomNavState extends State<AdminBottomNav> {\n  int _selectedIndex = 0;\n\n  final List<Widget> _pages = [\n    const UsersScreen(),\n    const CaretakersScreen(),\n    const ReportsScreen(),\n    const AdminNotificationsScreen(),\n    const AdminSettingsScreen(),\n  ];\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      body: _pages[_selectedIndex],\n      bottomNavigationBar: BottomNavigationBar(\n        currentIndex: _selectedIndex,\n        onTap: (index) => setState(() => _selectedIndex = index),\n        type: BottomNavigationBarType.fixed,\n        selectedItemColor: Colors.blueAccent,\n        unselectedItemColor: Colors.grey,\n        items: const [\n          BottomNavigationBarItem(icon: Icon(Icons.people), label: 'Users'),\n          BottomNavigationBarItem(icon: Icon(Icons.manage_accounts), label: 'Caretakers'),\n          BottomNavigationBarItem(icon: Icon(Icons.report), label: 'Reports'),\n          BottomNavigationBarItem(icon: Icon(Icons.notifications), label: 'Notifications'),\n          BottomNavigationBarItem(icon: Icon(Icons.settings), label: 'Settings'),\n        ],\n      ),\n    );\n  }\n}",
        "_encoding": "utf-8"
      },
      "notifications_screen.dart": {
        "_text": "import 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:flutter/material.dart';\nimport '../utils/notification_helper.dart';\n\nclass AdminNotificationsScreen extends StatefulWidget {\n  const AdminNotificationsScreen({super.key});\n\n  @override\n  State<AdminNotificationsScreen> createState() => _AdminNotificationsScreenState();\n}\n\nclass _AdminNotificationsScreenState extends State<AdminNotificationsScreen> {\n  bool _isIndividual = true;\n  bool _isUser = true;\n  bool _isPatient = true;\n  bool _isCaretaker = false;\n  final TextEditingController _titleController = TextEditingController();\n  final TextEditingController _messageController = TextEditingController();\n  final TextEditingController _usernameController = TextEditingController();\n\n  Future<void> _send() async {\n    if (_titleController.text.trim().isEmpty || _messageController.text.trim().isEmpty) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Title and message required')));\n      }\n      return;\n    }\n\n    List<String> playerIds = [];\n    final message = '${_titleController.text}: ${_messageController.text}';\n\n    if (_isIndividual) {\n      final coll = _isUser ? 'user' : 'caretaker';\n      final snap = await FirebaseFirestore.instance.collection(coll).where('username', isEqualTo: _usernameController.text.trim()).get();\n      if (snap.docs.isEmpty) {\n        if (mounted) {\n          ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('User not found')));\n        }\n        return;\n      }\n      playerIds = List<String>.from(snap.docs.first.data()['playerIds'] ?? []);\n      // Add to Firestore notifications for individual\n      await snap.docs.first.reference.collection('notifications').add({\n        'type': 'admin',\n        'message': message,\n        'createdAt': Timestamp.now(),\n        'isRead': false,\n      });\n    } else {\n      if (_isPatient) {\n        final snap = await FirebaseFirestore.instance.collection('user').get();\n        for (var doc in snap.docs) {\n          playerIds.addAll(List<String>.from(doc.data()['playerIds'] ?? []));\n          // Add to Firestore notifications for each user\n          await doc.reference.collection('notifications').add({\n            'type': 'admin',\n            'message': message,\n            'createdAt': Timestamp.now(),\n            'isRead': false,\n          });\n        }\n      }\n      if (_isCaretaker) {\n        final snap = await FirebaseFirestore.instance.collection('caretaker').get();\n        for (var doc in snap.docs) {\n          playerIds.addAll(List<String>.from(doc.data()['playerIds'] ?? []));\n          // Add to Firestore notifications for each caretaker\n          await doc.reference.collection('notifications').add({\n            'type': 'admin',\n            'message': message,\n            'createdAt': Timestamp.now(),\n            'isRead': false,\n          });\n        }\n      }\n    }\n\n    await sendNotification(playerIds, message);\n    if (mounted) {\n      ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Notification sent')));\n    }\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: AppBar(title: const Text('Send Notifications')),\n      body: Padding(\n        padding: const EdgeInsets.all(16),\n        child: Column(\n          children: [\n            Row(\n              children: [\n                ChoiceChip(label: const Text('Individual'), selected: _isIndividual, onSelected: (sel) => setState(() => _isIndividual = sel)),\n                ChoiceChip(label: const Text('All'), selected: !_isIndividual, onSelected: (sel) => setState(() => _isIndividual = !sel)),\n              ],\n            ),\n            if (_isIndividual) ...[\n              Row(\n                children: [\n                  ChoiceChip(label: const Text('User'), selected: _isUser, onSelected: (sel) => setState(() => _isUser = sel)),\n                  ChoiceChip(label: const Text('Caretaker'), selected: !_isUser, onSelected: (sel) => setState(() => _isUser = !sel)),\n                ],\n              ),\n              TextField(controller: _usernameController, decoration: const InputDecoration(labelText: 'Username')),\n            ] else ...[\n              CheckboxListTile(title: const Text('Patients'), value: _isPatient, onChanged: (val) => setState(() => _isPatient = val!)),\n              CheckboxListTile(title: const Text('Caretakers'), value: _isCaretaker, onChanged: (val) => setState(() => _isCaretaker = val!)),\n            ],\n            TextField(controller: _titleController, decoration: const InputDecoration(labelText: 'Title')),\n            TextField(controller: _messageController, decoration: const InputDecoration(labelText: 'Message')),\n            ElevatedButton(onPressed: _send, child: const Text('Send')),\n          ],\n        ),\n      ),\n    );\n  }\n}",
        "_encoding": "utf-8"
      },
      "reports_screen.dart": {
        "_text": "import 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:flutter/material.dart';\n\nclass ReportsScreen extends StatefulWidget {\n  const ReportsScreen({super.key});\n\n  @override\n  State<ReportsScreen> createState() => _ReportsScreenState();\n}\n\nclass _ReportsScreenState extends State<ReportsScreen> {\n  String _selectedTab = 'Unseen';\n\n  /// Fetch all reports ordered by created_at (descending).\n  /// We filter in code to avoid composite index requirement.\n  Stream<QuerySnapshot> _getReportsStream() {\n    return FirebaseFirestore.instance\n        .collection('reports')\n        .orderBy('created_at', descending: true)\n        .snapshots();\n  }\n\n  /// Mark a report as seen\n  Future<void> _markAsSeen(String id) async {\n    await FirebaseFirestore.instance\n        .collection('reports')\n        .doc(id)\n        .update({'seen': true});\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: AppBar(title: const Text('Reports')),\n      body: Column(\n        children: [\n          /// Tab selector (Unseen / Seen)\n          Row(\n            children: [\n              ChoiceChip(\n                label: const Text('Unseen'),\n                selected: _selectedTab == 'Unseen',\n                onSelected: (selected) {\n                  if (selected) {\n                    setState(() => _selectedTab = 'Unseen');\n                  }\n                },\n              ),\n              const SizedBox(width: 8),\n              ChoiceChip(\n                label: const Text('Seen'),\n                selected: _selectedTab == 'Seen',\n                onSelected: (selected) {\n                  if (selected) {\n                    setState(() => _selectedTab = 'Seen');\n                  }\n                },\n              ),\n            ],\n          ),\n\n          /// Reports list\n          Expanded(\n            child: StreamBuilder<QuerySnapshot>(\n              stream: _getReportsStream(),\n              builder: (context, snapshot) {\n                if (snapshot.connectionState == ConnectionState.waiting) {\n                  return const Center(child: CircularProgressIndicator());\n                }\n                if (snapshot.hasError) {\n                  return Center(child: Text('Error: ${snapshot.error}'));\n                }\n\n                final docs = snapshot.data?.docs ?? [];\n\n                // Filter in code based on 'seen' status\n                final filteredDocs = docs.where((doc) {\n                  final data = doc.data() as Map<String, dynamic>;\n                  final seen = data['seen'] as bool? ?? false;\n                  return (_selectedTab == 'Unseen') ? !seen : seen;\n                }).toList();\n\n                if (filteredDocs.isEmpty) {\n                  return const Center(child: Text('No reports'));\n                }\n\n                return ListView.builder(\n                  itemCount: filteredDocs.length,\n                  itemBuilder: (context, index) {\n                    final doc = filteredDocs[index];\n                    final data = doc.data() as Map<String, dynamic>;\n\n                    return Card(\n                      margin: const EdgeInsets.symmetric(\n                        vertical: 6,\n                        horizontal: 12,\n                      ),\n                      child: ListTile(\n                        title: Text(data['title'] ?? 'No title'),\n                        subtitle: Text(data['description'] ?? 'No description'),\n                        trailing: IconButton(\n                          icon: const Icon(Icons.check),\n                          onPressed: () => _markAsSeen(doc.id),\n                        ),\n                      ),\n                    );\n                  },\n                );\n              },\n            ),\n          ),\n        ],\n      ),\n    );\n  }\n}\n",
        "_encoding": "utf-8"
      },
      "settings_screen.dart": {
        "_text": "// New file: lib/admin/settings_screen.dart\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:flutter/material.dart';\nimport '../welcome_page.dart';\n\nclass AdminSettingsScreen extends StatelessWidget {\n  const AdminSettingsScreen({super.key});\n\n  Future<void> _logout(BuildContext context) async {\n    await FirebaseAuth.instance.signOut();\n    Navigator.pushReplacement(context, MaterialPageRoute(builder: (context) => const WelcomePage()));\n  }\n\n  Future<void> _addAdmin(BuildContext context) async {\n    final emailController = TextEditingController();\n    final passwordController = TextEditingController();\n\n    await showDialog(\n      context: context,\n      builder: (_) => AlertDialog(\n        title: const Text('Add Admin'),\n        content: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            TextField(controller: emailController, decoration: const InputDecoration(labelText: 'Email')),\n            TextField(controller: passwordController, decoration: const InputDecoration(labelText: 'Password'), obscureText: true),\n          ],\n        ),\n        actions: [\n          TextButton(onPressed: () => Navigator.pop(context), child: const Text('Cancel')),\n          ElevatedButton(\n            onPressed: () async {\n              try {\n                final credential = await FirebaseAuth.instance.createUserWithEmailAndPassword(\n                  email: emailController.text.trim(),\n                  password: passwordController.text.trim(),\n                );\n                final uid = credential.user?.uid;\n                if (uid != null) {\n                  await FirebaseFirestore.instance.collection('admin').doc(uid).set({\n                    'email': emailController.text.trim(),\n                    'createdAt': Timestamp.now(),\n                  });\n                  ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Admin added')));\n                }\n              } catch (e) {\n                ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Error: $e')));\n              }\n              Navigator.pop(context);\n            },\n            child: const Text('Add'),\n          ),\n        ],\n      ),\n    );\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: AppBar(title: const Text('Settings')),\n      body: ListView(\n        children: [\n          ListTile(\n            leading: const Icon(Icons.logout),\n            title: const Text('Logout'),\n            onTap: () => _logout(context),\n          ),\n          ListTile(\n            leading: const Icon(Icons.add),\n            title: const Text('Add Admin'),\n            onTap: () => _addAdmin(context),\n          ),\n        ],\n      ),\n    );\n  }\n}",
        "_encoding": "utf-8"
      }
    },
    "careTaker": {
      "caretaker_bottom_nav.dart": {
        "_text": "import 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/material.dart';\nimport 'user_screen.dart';\nimport 'profile_screen.dart';\nimport 'notifications_screen.dart';\n\nclass CareTaker extends StatefulWidget {\n  const CareTaker({super.key});\n\n  @override\n  State<CareTaker> createState() => _CareTakerState();\n}\n\nclass _CareTakerState extends State<CareTaker> {\n  int _selectedIndex = 0;\n\n  final List<Widget> _pages = [\n    UserScreen(),\n    const NotificationsScreen(), \n    const Profile(),\n  ];\n\n  void _onItemTapped(int index) {\n    setState(() {\n      _selectedIndex = index;\n    });\n  }\n\n  Future<void> _checkBanned() async {\n    final uid = FirebaseAuth.instance.currentUser?.uid;\n    if (uid == null) return;\n\n    final doc = await FirebaseFirestore.instance\n        .collection('caretaker')\n        .doc(uid)\n        .get();\n\n    if (doc.data()?['isBanned'] == true) {\n      if (!mounted) return;\n      showDialog(\n        context: context,\n        builder: (_) => AlertDialog(\n          title: const Text('Account Banned'),\n          content: const Text('Your account has been banned.'),\n          actions: [\n            TextButton(\n              onPressed: () async {\n                await FirebaseAuth.instance.signOut();\n                if (!mounted) return;\n                Navigator.pushReplacementNamed(context, '/welcome');\n              },\n              child: const Text('Logout'),\n            ),\n          ],\n        ),\n      );\n    }\n  }\n\n  @override\n  void initState() {\n    super.initState();\n    _checkBanned();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      body: _pages[_selectedIndex],\n      bottomNavigationBar: BottomNavigationBar(\n        currentIndex: _selectedIndex,\n        onTap: _onItemTapped,\n        selectedItemColor: Colors.blue,\n        unselectedItemColor: Colors.grey,\n        items: const [\n          BottomNavigationBarItem(icon: Icon(Icons.person), label: 'User'),\n          BottomNavigationBarItem(\n            icon: Icon(Icons.notifications),\n            label: 'Notification',\n          ),\n          BottomNavigationBarItem(icon: Icon(Icons.person), label: 'Profile'),\n        ],\n      ),\n    );\n  }\n}\n",
        "_encoding": "utf-8"
      },
      "caretaker_map_screen.dart": {
        "_text": "import 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:flutter/material.dart';\nimport 'package:google_maps_flutter/google_maps_flutter.dart';\n\nclass CaretakerMapScreen extends StatefulWidget {\n  final String patientId;\n\n  const CaretakerMapScreen({super.key, required this.patientId});\n\n  @override\n  State<CaretakerMapScreen> createState() => _CaretakerMapScreenState();\n}\n\nclass _CaretakerMapScreenState extends State<CaretakerMapScreen> {\n  GoogleMapController? _mapController;\n  LatLng? _patientLocation;\n  Set<Marker> _markers = {};\n\n  // 🌍 Default camera (India)\n  static const CameraPosition _initialCamera = CameraPosition(\n    target: LatLng(20.5937, 78.9629),\n    zoom: 4,\n  );\n\n  @override\n  void initState() {\n    super.initState();\n    // Initial fetch can be handled in StreamBuilder\n  }\n\n  void _recenter() {\n    if (_patientLocation != null && _mapController != null) {\n      _mapController!.animateCamera(\n        CameraUpdate.newLatLngZoom(_patientLocation!, 16),\n      );\n    }\n  }\n\n  Marker _buildPatientMarker(LatLng position) {\n    return Marker(\n      markerId: const MarkerId(\"patient\"),\n      position: position,\n      infoWindow: const InfoWindow(title: \"Patient Location\"),\n      icon: BitmapDescriptor.defaultMarkerWithHue(BitmapDescriptor.hueAzure),\n    );\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text(\"Patient Map\"),\n        actions: [\n          IconButton(\n            icon: const Icon(Icons.my_location),\n            onPressed: _recenter,\n          ),\n        ],\n      ),\n      body: StreamBuilder<DocumentSnapshot>(\n        stream: FirebaseFirestore.instance.collection('user').doc(widget.patientId).snapshots(),\n        builder: (context, snapshot) {\n          if (snapshot.hasError) {\n            return Center(child: Text('Error: ${snapshot.error}'));\n          }\n          if (snapshot.connectionState == ConnectionState.waiting || !snapshot.hasData) {\n            return const Center(child: CircularProgressIndicator());\n          }\n\n          final data = snapshot.data!.data() as Map<String, dynamic>?;\n          final double lat = data?['currentLat'] as double? ?? 0.0;\n          final double lng = data?['currentLng'] as double? ?? 0.0;\n          final newLocation = LatLng(lat, lng);\n\n          // Update location and markers\n          if (_patientLocation == null || _patientLocation != newLocation) {\n            _patientLocation = newLocation;\n            _markers = {_buildPatientMarker(_patientLocation!)};\n            // Animate camera if map is ready and location has changed or first load\n            WidgetsBinding.instance.addPostFrameCallback((_) {\n              _recenter();\n            });\n          }\n\n          return GoogleMap(\n            onMapCreated: (controller) {\n              _mapController = controller;\n              // Recenter once map is created\n              _recenter();\n            },\n            initialCameraPosition: _initialCamera,\n            markers: _markers,\n            zoomControlsEnabled: true,\n            myLocationEnabled: false,\n            myLocationButtonEnabled: false,\n          );\n        },\n      ),\n      floatingActionButton: FloatingActionButton(\n        onPressed: _recenter,\n        child: const Icon(Icons.location_searching),\n      ),\n    );\n  }\n\n  @override\n  void dispose() {\n    _mapController?.dispose();\n    super.dispose();\n  }\n}",
        "_encoding": "utf-8"
      },
      "family_scanner.dart": {
        "_text": "import 'dart:convert';\nimport 'dart:io';\nimport 'package:camera/camera.dart';\nimport 'package:flutter/foundation.dart';\nimport 'package:flutter/material.dart';\nimport 'package:http/http.dart' as http;\nimport 'package:flutter_animate/flutter_animate.dart';\nimport 'package:confetti/confetti.dart';\nimport 'package:logger/logger.dart';\nimport 'package:image/image.dart' as img;\nimport 'package:cloud_firestore/cloud_firestore.dart';\n\nfinal logger = Logger();\n\nclass ScannerScreen extends StatefulWidget {\n  final String patientUid;\n  const ScannerScreen({super.key, required this.patientUid});\n\n  @override\n  State<ScannerScreen> createState() => _ScannerScreenState();\n}\n\nclass _ScannerScreenState extends State<ScannerScreen>\n    with SingleTickerProviderStateMixin {\n  CameraController? _controller;\n  Future<void>? _initializeControllerFuture;\n  XFile? _capturedImage;\n  bool _hasCameraError = false;\n  bool _isProcessing = false;\n  bool _isLoadingCamera = true;\n  bool _isCapturing = false;\n  late ConfettiController _confettiController;\n  bool _disposed = false;\n  bool _isFrontCamera = false;\n  List<CameraDescription> _cameras = [];\n\n  // NEW: Store fetched members list here\n  List<Map<String, dynamic>> _patientMembers = [];\n  bool _isFetchingMembers = true;\n\n  // Firestore instance\n  final FirebaseFirestore _firestore = FirebaseFirestore.instance;\n\n  // Result info\n  Map<String, dynamic>? _resultData;\n  bool _noMatch = false;\n\n  // Animation controller for scanning overlay\n  late AnimationController _scanAnimationController;\n\n  @override\n  void initState() {\n    super.initState();\n    _confettiController =\n        ConfettiController(duration: const Duration(seconds: 3));\n    _scanAnimationController = AnimationController(\n      vsync: this,\n      duration: const Duration(seconds: 2),\n    )..repeat(reverse: true);\n    // NEW: Start fetching members before initializing the camera\n    _fetchPatientMembers();\n  }\n\n  // NEW FUNCTION: Fetch the 'members' array from the patient's document\n  Future<void> _fetchPatientMembers() async {\n    if (_disposed) return;\n    setState(() => _isFetchingMembers = true);\n    try {\n      final patientDoc =\n          await _firestore.collection('user').doc(widget.patientUid).get();\n\n      if (patientDoc.exists) {\n        final data = patientDoc.data();\n        final membersList = data?['members'] as List<dynamic>?;\n        \n        if (membersList != null) {\n            // Convert List<dynamic> to List<Map<String, dynamic>>\n            _patientMembers = membersList\n                .whereType<Map<String, dynamic>>()\n                .toList();\n        }\n      }\n      // Continue to camera setup only after members are fetched\n      await _initializeCamera();\n    } catch (e) {\n      logger.e('Error fetching patient members: $e');\n      if (mounted && !_disposed) {\n        setState(() {\n            _hasCameraError = true;\n            _isLoadingCamera = false;\n        });\n      }\n    } finally {\n        if (mounted && !_disposed) setState(() => _isFetchingMembers = false);\n    }\n  }\n\n  Future<void> _initializeCamera() async {\n    if (_disposed || _isFetchingMembers) return; // Wait for members\n    setState(() {\n      _isLoadingCamera = true;\n      _resultData = null;\n      _noMatch = false;\n      _capturedImage = null;\n    });\n    try {\n      await _controller?.dispose();\n      _cameras = await availableCameras().timeout(\n        const Duration(seconds: 10),\n        onTimeout: () {\n          throw Exception('Camera initialization timed out');\n        },\n      );\n      if (_cameras.isEmpty) {\n        if (mounted && !_disposed) {\n          setState(() {\n            _hasCameraError = true;\n            _isLoadingCamera = false;\n          });\n        }\n        return;\n      }\n      final selectedCamera = _cameras.firstWhere(\n        (camera) =>\n            camera.lensDirection ==\n            (_isFrontCamera ? CameraLensDirection.front : CameraLensDirection.back),\n        orElse: () => _cameras.first,\n      );\n      _controller = CameraController(\n        selectedCamera,\n        ResolutionPreset.low, // Optimized to lower resolution for faster processing\n        enableAudio: false,\n        imageFormatGroup: ImageFormatGroup.jpeg,\n      );\n      _initializeControllerFuture = _controller!.initialize().timeout(\n        const Duration(seconds: 10),\n        onTimeout: () {\n          throw Exception('Camera controller initialization timed out');\n        },\n      );\n      await _initializeControllerFuture;\n      if (mounted && !_disposed) {\n        setState(() => _isLoadingCamera = false);\n      }\n    } catch (e) {\n      logger.e('Error initializing camera: $e');\n      if (mounted && !_disposed) {\n        setState(() {\n          _hasCameraError = true;\n          _isLoadingCamera = false;\n        });\n      }\n    }\n  }\n\n  Future<void> _toggleCamera() async {\n    if (_cameras.length < 2) return;\n    setState(() {\n      _isFrontCamera = !_isFrontCamera;\n      _hasCameraError = false;\n      _isLoadingCamera = true;\n      _capturedImage = null;\n      _resultData = null;\n      _noMatch = false;\n    });\n    await _initializeCamera();\n  }\n\n  Future<void> _captureImage() async {\n    if (_controller == null ||\n        _initializeControllerFuture == null ||\n        _hasCameraError ||\n        _isLoadingCamera ||\n        _isCapturing ||\n        _isProcessing || \n        _patientMembers.isEmpty) { // Prevent capture if no members\n      if (_patientMembers.isEmpty && mounted) {\n         ScaffoldMessenger.of(context).showSnackBar(\n            const SnackBar(content: Text('Cannot scan: Patient has no registered family members.')),\n        );\n      }\n      return;\n    }\n    setState(() => _isCapturing = true);\n    try {\n      await _initializeControllerFuture;\n      await _controller!.pausePreview();\n      final image = await _controller!.takePicture();\n\n      // Process image (flip if front, resize and compress)\n      final bytes = await File(image.path).readAsBytes();\n      Uint8List processedBytes;\n      if (_isFrontCamera) {\n        processedBytes = await compute(_flipHorizontal, bytes);\n      } else {\n        processedBytes = await compute(_resizeAndCompressBytes, bytes);\n      }\n      await File(image.path).writeAsBytes(processedBytes);\n\n      if (_controller != null && _controller!.value.isInitialized) {\n        await _controller!.resumePreview();\n      }\n\n      if (mounted && !_disposed) {\n        setState(() {\n          _capturedImage = image;\n          _resultData = null;\n          _noMatch = false;\n          _isCapturing = false;\n        });\n      }\n    } catch (e) {\n      logger.e('Error capturing image: $e');\n      if (_controller != null && _controller!.value.isInitialized) {\n        try {\n          await _controller!.resumePreview();\n        } catch (_) {}\n      }\n      if (mounted && !_disposed) setState(() => _isCapturing = false);\n    }\n  }\n\n  static Uint8List _flipHorizontal(Uint8List bytes) {\n    final image = img.decodeImage(bytes);\n    if (image == null) return bytes;\n    final flipped = img.flipHorizontal(image);\n    return _resizeAndCompress(flipped);\n  }\n\n  static Uint8List _resizeAndCompressBytes(Uint8List bytes) {\n    final image = img.decodeImage(bytes);\n    if (image == null) return bytes;\n    return _resizeAndCompress(image);\n  }\n\n  static Uint8List _resizeAndCompress(img.Image image) {\n    const maxSize = 512;\n    img.Image resized = image;\n    if (image.width > maxSize || image.height > maxSize) {\n      if (image.width > image.height) {\n        resized = img.copyResize(image, width: maxSize);\n      } else {\n        resized = img.copyResize(image, height: maxSize);\n      }\n    }\n    return img.encodeJpg(resized, quality: 85);\n  }\n\n  Future<String> _encodeImage(Uint8List bytes) async {\n    return await compute(_encodeBase64, bytes);\n  }\n\n  static String _encodeBase64(Uint8List bytes) {\n    return base64Encode(bytes);\n  }\n\n  Future<void> _sendToApi() async {\n    if (_capturedImage == null || _isProcessing || _patientMembers.isEmpty) return;\n    if (mounted && !_disposed) setState(() => _isProcessing = true);\n\n    try {\n      final imageBytes = await _capturedImage!.readAsBytes();\n      final base64Image = await _encodeImage(imageBytes);\n      \n      // LOGIC: Use the fetched _patientMembers list\n      final membersPayload = _patientMembers.map((m) => {\n          'memberName': m['name'],\n          'memberRelation': m['relation'],\n          'memberImage': m['imageUrl'],\n      }).toList();\n\n      final response = await http.post(\n        Uri.parse('https://una-heliotropic-aspersively.ngrok-free.dev/recognize'),\n        body: {\n          'members': jsonEncode(membersPayload), // Use fetched members\n          'imageUrl': 'data:image/jpeg;base64,$base64Image',\n        },\n      ).timeout(const Duration(seconds: 30));\n\n      if (!mounted || _disposed) return;\n\n      if (response.statusCode == 200) {\n        final result = jsonDecode(response.body);\n        if (result['matchFound']) {\n          _confettiController.play();\n          setState(() {\n            _resultData = result;\n            _noMatch = false;\n          });\n        } else {\n          setState(() {\n            _resultData = null;\n            _noMatch = true;\n          });\n        }\n      } else {\n        setState(() {\n          _resultData = null;\n          _noMatch = true;\n        });\n      }\n    } catch (e) {\n      logger.e('Error sending image to API: $e');\n      if (mounted && !_disposed) {\n        setState(() {\n          _resultData = null;\n          _noMatch = true;\n        });\n      }\n    } finally {\n      if (mounted && !_disposed) setState(() => _isProcessing = false);\n    }\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    // Show a loading indicator if fetching members OR setting up camera\n    if (_isFetchingMembers || _isLoadingCamera) {\n      return Scaffold(\n        appBar: AppBar(\n          title: Text(_isFetchingMembers ? 'Loading Patient Data...' : 'Initializing Camera...'),\n          backgroundColor: Colors.blueAccent,\n          elevation: 0,\n        ),\n        body: const Center(child: CircularProgressIndicator()),\n      );\n    }\n    \n    // Check if patient has any family members registered\n    if (_patientMembers.isEmpty) {\n        return Scaffold(\n            appBar: AppBar(\n                title: const Text('Scan Family Member'),\n                backgroundColor: Colors.redAccent,\n                elevation: 0,\n            ),\n            body: Center(\n                child: Padding(\n                    padding: const EdgeInsets.all(32.0),\n                    child: Column(\n                        mainAxisAlignment: MainAxisAlignment.center,\n                        children: [\n                            const Icon(Icons.group_off, size: 80, color: Colors.red),\n                            const SizedBox(height: 16),\n                            const Text(\n                                'No Family Members Registered',\n                                style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold),\n                                textAlign: TextAlign.center,\n                            ),\n                            const SizedBox(height: 8),\n                            const Text(\n                                'The patient connected to your account has no registered family members to verify against.',\n                                textAlign: TextAlign.center,\n                                style: TextStyle(color: Colors.grey),\n                            ),\n                            const SizedBox(height: 24),\n                            ElevatedButton(\n                                onPressed: () => Navigator.pop(context),\n                                child: const Text('Go Back'),\n                            ),\n                        ],\n                    ),\n                ),\n            ),\n        );\n    }\n\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text('Scan Family Member'),\n        backgroundColor: Colors.blueAccent,\n        elevation: 0,\n        actions: [\n          IconButton(\n            icon: Icon(_isFrontCamera ? Icons.camera_rear : Icons.camera_front),\n            onPressed: _isLoadingCamera || _isCapturing || _isProcessing\n                ? null\n                : _toggleCamera,\n          ),\n        ],\n      ),\n      body: Stack(\n        children: [\n          _hasCameraError\n              ? _buildCameraError()\n              : _capturedImage == null\n                  ? _buildCameraPreview()\n                  : _buildCapturedImageWithAnimation(),\n          Align(\n            alignment: Alignment.topCenter,\n            child: ConfettiWidget(\n              confettiController: _confettiController,\n              blastDirectionality: BlastDirectionality.explosive,\n              shouldLoop: false,\n              numberOfParticles: 50,\n            ),\n          ),\n        ],\n      ),\n      floatingActionButton: _capturedImage == null &&\n              !_hasCameraError &&\n              _controller != null &&\n              !_isLoadingCamera\n          ? FloatingActionButton(\n              onPressed: _isCapturing || _isProcessing ? null : _captureImage,\n              backgroundColor: Colors.blueAccent,\n              child: _isCapturing\n                  ? const CircularProgressIndicator(color: Colors.white)\n                  : const Icon(Icons.camera_alt, color: Colors.white),\n            )\n          : null,\n    );\n  }\n\n  Widget _buildCapturedImageWithAnimation() {\n    return Stack(\n      children: [\n        Image.file(\n          File(_capturedImage!.path),\n          width: double.infinity,\n          height: double.infinity,\n          fit: BoxFit.cover,\n        ),\n        if (_isProcessing)\n          Positioned.fill(\n            child: Container(\n              color: Colors.black26,\n              child: Center(\n                child: Container(\n                  width: 250,\n                  height: 250,\n                  decoration: BoxDecoration(\n                    border: Border.all(color: Colors.blueAccent, width: 2),\n                  ),\n                  child: AnimatedBuilder(\n                    animation: _scanAnimationController,\n                    builder: (context, child) {\n                      return Align(\n                        alignment: Alignment(\n                            0, -1 + 2 * _scanAnimationController.value),\n                        child: Container(\n                          height: 4,\n                          width: double.infinity,\n                          color: Colors.blueAccent,\n                        ),\n                      );\n                    },\n                  ),\n                ),\n              ),\n            ),\n          ),\n        Positioned(\n          bottom: 40, // Increased bottom padding\n          left: 20,\n          right: 20,\n          child: _buildBottomControls(),\n        ),\n      ],\n    );\n  }\n\n  Widget _buildBottomControls() {\n    return Column(\n      mainAxisSize: MainAxisSize.min,\n      children: [\n        if (!_isProcessing)\n          Row(\n            mainAxisAlignment: MainAxisAlignment.spaceEvenly,\n            children: [\n              ElevatedButton(\n                onPressed: _sendToApi,\n                style: ElevatedButton.styleFrom(\n                  backgroundColor: Colors.green,\n                  shape: RoundedRectangleBorder(\n                      borderRadius: BorderRadius.circular(12)),\n                  padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 12),\n                ),\n                child: const Text('OK', style: TextStyle(fontSize: 16, color: Colors.white)),\n              ),\n              ElevatedButton(\n                onPressed: () {\n                  setState(() {\n                    _capturedImage = null;\n                    _resultData = null;\n                    _noMatch = false;\n                  });\n                },\n                style: ElevatedButton.styleFrom(\n                  backgroundColor: Colors.red,\n                  shape: RoundedRectangleBorder(\n                      borderRadius: BorderRadius.circular(12)),\n                  padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 12),\n                ),\n                child: const Text('Retake', style: TextStyle(fontSize: 16, color: Colors.white)),\n              ),\n            ],\n          ),\n        const SizedBox(height: 16),\n        if (_resultData != null || _noMatch) _buildResultOverlay(),\n      ],\n    );\n  }\n\n  Widget _buildResultOverlay() {\n    return Center(\n      child: Container(\n        width: MediaQuery.of(context).size.width * 0.8,\n        padding: const EdgeInsets.all(20),\n        decoration: BoxDecoration(\n          color: Colors.white.withOpacity(0.9),\n          borderRadius: BorderRadius.circular(16),\n          boxShadow: [\n            BoxShadow(\n              color: Colors.black.withOpacity(0.1),\n              blurRadius: 8,\n              spreadRadius: 2,\n            ),\n          ],\n        ),\n        child: _resultData != null\n            ? Column(\n                mainAxisSize: MainAxisSize.min,\n                children: [\n                  Text(\n                    'Match Found',\n                    style: Theme.of(context).textTheme.titleLarge?.copyWith(\n                          color: Colors.blueAccent,\n                          fontWeight: FontWeight.bold,\n                        ),\n                  ),\n                  const SizedBox(height: 16),\n                  if (_resultData!['memberImageUrl'] != null &&\n                      _resultData!['memberImageUrl'].isNotEmpty)\n                    ClipRRect(\n                      borderRadius: BorderRadius.circular(8),\n                      child: Image.network(\n                        _resultData!['memberImageUrl'],\n                        height: 100,\n                        width: 100,\n                        fit: BoxFit.cover,\n                      ),\n                    ),\n                  const SizedBox(height: 12),\n                  Text(\n                    'Name: ${_resultData!['memberName']}',\n                    style: Theme.of(context).textTheme.titleMedium,\n                  ),\n                  Text(\n                    'Relation: ${_resultData!['memberRelation']}',\n                    style: Theme.of(context).textTheme.titleMedium,\n                  ),\n                  Text(\n                    'Confidence: ${(_resultData!['confidence'] * 100).toStringAsFixed(2)}%',\n                    style: Theme.of(context).textTheme.titleMedium,\n                  ),\n                ],\n              )\n            : Column(\n                mainAxisSize: MainAxisSize.min,\n                children: [\n                  Text(\n                    'No Matches Found',\n                    style: Theme.of(context).textTheme.titleLarge?.copyWith(\n                          color: Colors.redAccent,\n                          fontWeight: FontWeight.bold,\n                        ),\n                  ),\n                ],\n              ),\n      ).animate().fadeIn(duration: 400.ms),\n    );\n  }\n\n  Widget _buildCameraPreview() {\n    return FutureBuilder<void>(\n      future: _initializeControllerFuture,\n      builder: (context, snapshot) {\n        if (snapshot.connectionState == ConnectionState.done) {\n          if (snapshot.hasError || _controller == null) return _buildCameraError();\n          return CameraPreview(_controller!).animate().fadeIn(duration: 500.ms);\n        }\n        return const Center(child: CircularProgressIndicator());\n      },\n    );\n  }\n\n  Widget _buildCameraError() {\n    return Center(\n      child: Column(\n        mainAxisAlignment: MainAxisAlignment.center,\n        children: [\n          const Icon(Icons.camera_alt, size: 64, color: Colors.red),\n          const SizedBox(height: 16),\n          const Text(\n            'Camera not available',\n            style: TextStyle(fontSize: 18, color: Colors.red),\n          ),\n          const SizedBox(height: 16),\n          ElevatedButton(\n            onPressed: _initializeCamera,\n            child: const Text('Retry'),\n          ),\n        ],\n      ),\n    );\n  }\n\n  @override\n  void dispose() {\n    _disposed = true;\n    _controller?.dispose();\n    _confettiController.dispose();\n    _scanAnimationController.dispose();\n    super.dispose();\n  }\n}",
        "_encoding": "utf-8"
      },
      "notifications_screen.dart": {
        "_text": "// lib/careTaker/notifications.dart\nimport 'package:flutter/material.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:url_launcher/url_launcher.dart';\nimport 'package:intl/intl.dart';\n\nimport '../utils/notification_helper.dart';\n\nclass NotificationsScreen extends StatefulWidget {\n  const NotificationsScreen({super.key});\n\n  @override\n  State<NotificationsScreen> createState() => _NotificationsScreenState();\n}\n\nclass _NotificationsScreenState extends State<NotificationsScreen> {\n  final FirebaseAuth _auth = FirebaseAuth.instance;\n  final FirebaseFirestore _firestore = FirebaseFirestore.instance;\n\n  @override\n  void initState() {\n    super.initState();\n    _markAllAsRead();\n  }\n\n  // --- Utility Functions ---\n\n  Future<String> _fetchUserName(String userUid) async {\n    try {\n      final doc = await _firestore.collection('user').doc(userUid).get();\n      return doc.data()?['fullName'] as String? ?? 'User Not Found';\n    } catch (e) {\n      return 'Error fetching name';\n    }\n  }\n\n  Future<void> _markAllAsRead() async {\n    final caretakerUid = _auth.currentUser?.uid;\n    if (caretakerUid == null) return;\n\n    try {\n      final batch = _firestore.batch();\n      final snapshot = await _firestore\n          .collection('caretaker')\n          .doc(caretakerUid)\n          .collection('notifications')\n          .where('isRead', isEqualTo: false)\n          .get();\n\n      for (var doc in snapshot.docs) {\n        batch.update(doc.reference, {'isRead': true});\n      }\n      await batch.commit();\n    } catch (e) {\n      if (mounted) {\n        // Handle error silently\n      }\n    }\n  }\n\n  Future<void> _handleCall(String userUid) async {\n    try {\n      final userDoc = await _firestore.collection('user').doc(userUid).get();\n      final phone = userDoc.data()?['phoneNo'] as String?;\n\n      if (phone != null && phone.isNotEmpty) {\n        final url = Uri.parse('tel:$phone');\n        if (await canLaunchUrl(url)) {\n          await launchUrl(url);\n        } else {\n          if (mounted) {\n            ScaffoldMessenger.of(context).showSnackBar(\n              const SnackBar(content: Text('Could not launch phone app.')),\n            );\n          }\n        }\n      } else {\n        if (mounted) {\n          ScaffoldMessenger.of(context).showSnackBar(\n            const SnackBar(content: Text('User phone number not available.')),\n          );\n        }\n      }\n    } catch (e) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Error getting phone number: $e')),\n        );\n      }\n    }\n  }\n\n  Future<void> _handleAccept(String notificationId, String userUid, String connectionId) async {\n    final caretakerUid = _auth.currentUser?.uid;\n    if (caretakerUid == null) return;\n\n    try {\n      // Update connection status\n      await _firestore.collection('connections').doc(connectionId).update({\n        'status': 'accepted',\n        'confirmedBy': caretakerUid,\n      });\n\n      // Update Caretaker's profile\n      await _firestore.collection('caretaker').doc(caretakerUid).update({\n        'isConnected': true,\n        'currentConnectionId': connectionId,\n      });\n\n      // Update User's profile\n      await _firestore.collection('user').doc(userUid).update({\n        'isConnected': true,\n        'currentConnectionId': connectionId,\n      });\n\n      // Delete the notification\n      await _firestore\n          .collection('caretaker')\n          .doc(caretakerUid)\n          .collection('notifications')\n          .doc(notificationId)\n          .delete();\n\n      // Notify user\n      final userDoc = await _firestore.collection('user').doc(userUid).get();\n      final playerIds = List<String>.from(userDoc.data()?['playerIds'] ?? []);\n      await sendNotification(playerIds, 'Your connection request has been accepted!');\n\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Connection established!')),\n        );\n      }\n    } catch (e) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Failed to establish connection: $e')),\n        );\n      }\n    }\n  }\n\n  Future<void> _handleDecline(String notificationId, String userUid, String connectionId) async {\n    final caretakerUid = _auth.currentUser?.uid;\n    if (caretakerUid == null) return;\n\n    try {\n      await _firestore.collection('connections').doc(connectionId).update({\n        'status': 'rejected',\n      });\n\n      await _firestore\n          .collection('caretaker')\n          .doc(caretakerUid)\n          .collection('notifications')\n          .doc(notificationId)\n          .delete();\n\n      final userDoc = await _firestore.collection('user').doc(userUid).get();\n      final playerIds = List<String>.from(userDoc.data()?['playerIds'] ?? []);\n      await sendNotification(playerIds, 'Your connection request was declined');\n\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Connection request declined.')),\n        );\n      }\n    } catch (e) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Failed to decline connection: $e')),\n        );\n      }\n    }\n  }\n\n  Future<void> _handleUnbindAccept(String notificationId, String userUid, String connectionId) async {\n    final caretakerUid = _auth.currentUser?.uid;\n    if (caretakerUid == null) return;\n\n    try {\n      await _firestore.collection('connections').doc(connectionId).update({\n        'status': 'unbound',\n      });\n\n      // Update both profiles\n      await _firestore.collection('caretaker').doc(caretakerUid).update({\n        'isConnected': false,\n        'currentConnectionId': null,\n      });\n\n      await _firestore.collection('user').doc(userUid).update({\n        'isConnected': false,\n        'currentConnectionId': null,\n      });\n\n      // Delete the notification\n      await _firestore\n          .collection('caretaker')\n          .doc(caretakerUid)\n          .collection('notifications')\n          .doc(notificationId)\n          .delete();\n\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Connection unbound successfully')),\n        );\n      }\n    } catch (e) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Failed to unbind connection: $e')),\n        );\n      }\n    }\n  }\n\n  Future<void> _handleUnbindDecline(String notificationId, String connectionId) async {\n    final caretakerUid = _auth.currentUser?.uid;\n    if (caretakerUid == null) return;\n\n    try {\n      // Revert unbind request\n      await _firestore.collection('connections').doc(connectionId).update({\n        'status': 'accepted',\n        'requestedBy': null,\n      });\n\n      // Delete the notification\n      await _firestore\n          .collection('caretaker')\n          .doc(caretakerUid)\n          .collection('notifications')\n          .doc(notificationId)\n          .delete();\n\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Unbind request declined')),\n        );\n      }\n    } catch (e) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Failed to decline unbind: $e')),\n        );\n      }\n    }\n  }\n\n  // --- Stream and UI Builders ---\n\n  Stream<QuerySnapshot> _getNotificationsStream() {\n    final caretakerUid = _auth.currentUser?.uid;\n    if (caretakerUid == null) return Stream.empty();\n\n    return _firestore\n        .collection('caretaker')\n        .doc(caretakerUid)\n        .collection('notifications')\n        .orderBy('createdAt', descending: true)\n        .snapshots();\n  }\n\n  Widget _buildNotificationCard(DocumentSnapshot doc) {\n    final data = doc.data() as Map<String, dynamic>;\n    final type = data['type'] as String? ?? 'general';\n    final isRead = data['isRead'] as bool? ?? false;\n    final senderUid = data['from'] as String?;\n    final notificationMessage = data['message'] as String? ?? 'No message.';\n    final connectionId = data['connectionId'] as String?;\n\n    TextStyle textStyle = const TextStyle(fontWeight: FontWeight.normal);\n    Color cardColor = Colors.white;\n    IconData icon = Icons.info;\n\n    if (type == 'connection_request') {\n      textStyle = const TextStyle(\n        fontWeight: FontWeight.bold,\n        color: Colors.blueAccent,\n      );\n      cardColor = Colors.blue.shade50;\n      icon = Icons.person_add;\n    } else if (type == 'unbind_request') {\n      textStyle = const TextStyle(\n        fontWeight: FontWeight.bold,\n        color: Colors.orange,\n      );\n      cardColor = Colors.orange.shade50;\n      icon = Icons.link_off;\n    } else if (!isRead) {\n      cardColor = Colors.yellow.shade100;\n    }\n\n    return Card(\n      elevation: 3,\n      margin: const EdgeInsets.symmetric(vertical: 8, horizontal: 16),\n      color: cardColor,\n      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n      child: Padding(\n        padding: const EdgeInsets.all(12.0),\n        child: Column(\n          crossAxisAlignment: CrossAxisAlignment.start,\n          children: [\n            ListTile(\n              leading: Icon(icon, color: Colors.blueAccent),\n              title: (type == 'connection_request' && senderUid != null)\n                  ? FutureBuilder<String>(\n                      future: _fetchUserName(senderUid),\n                      builder: (context, snapshot) {\n                        String userName = snapshot.data ?? 'Loading User...';\n                        String displayMessage = 'Connection request from $userName.';\n                        return Text(displayMessage, style: textStyle);\n                      },\n                    )\n                  : (type == 'unbind_request' && senderUid != null)\n                      ? FutureBuilder<String>(\n                          future: _fetchUserName(senderUid),\n                          builder: (context, snapshot) {\n                            String userName = snapshot.data ?? 'Loading User...';\n                            String displayMessage = 'Unbind request from $userName.';\n                            return Text(displayMessage, style: textStyle);\n                          },\n                        )\n                      : Text(notificationMessage, style: textStyle),\n              subtitle: Text(\n                'Received: ${DateFormat('MMM dd, hh:mm a').format((data['createdAt'] as Timestamp).toDate())}',\n                style: const TextStyle(fontSize: 12, color: Colors.grey),\n              ),\n              contentPadding: EdgeInsets.zero,\n            ),\n\n            if ((type == 'connection_request' || type == 'unbind_request') && senderUid != null && connectionId != null)\n              Padding(\n                padding: const EdgeInsets.only(top: 8.0),\n                child: Row(\n                  mainAxisAlignment: MainAxisAlignment.end,\n                  children: [\n                    if (type == 'connection_request') ...[\n                      Expanded(\n                        flex: 1,\n                        child: OutlinedButton.icon(\n                          icon: const Icon(Icons.phone, size: 18, color: Colors.green),\n                          label: const Text('Call', style: TextStyle(fontSize: 13, color: Colors.green)),\n                          onPressed: () => _handleCall(senderUid),\n                          style: OutlinedButton.styleFrom(\n                            padding: const EdgeInsets.symmetric(horizontal: 0),\n                            side: const BorderSide(color: Colors.green),\n                          ),\n                        ),\n                      ),\n                      const SizedBox(width: 8),\n                      Expanded(\n                        flex: 2,\n                        child: ElevatedButton.icon(\n                          icon: const Icon(Icons.check, size: 18, color: Colors.white),\n                          label: const Text('Accept', style: TextStyle(fontSize: 13, color: Colors.white)),\n                          onPressed: () => _handleAccept(doc.id, senderUid, connectionId),\n                          style: ElevatedButton.styleFrom(\n                            backgroundColor: Colors.blueAccent,\n                            padding: const EdgeInsets.symmetric(horizontal: 0),\n                          ),\n                        ),\n                      ),\n                      const SizedBox(width: 8),\n                      Expanded(\n                        flex: 2,\n                        child: ElevatedButton.icon(\n                          icon: const Icon(Icons.close, size: 18, color: Colors.white),\n                          label: const Text('Decline', style: TextStyle(fontSize: 13, color: Colors.white)),\n                          onPressed: () => _handleDecline(doc.id, senderUid, connectionId),\n                          style: ElevatedButton.styleFrom(\n                            backgroundColor: Colors.red,\n                            padding: const EdgeInsets.symmetric(horizontal: 0),\n                          ),\n                        ),\n                      ),\n                    ] else if (type == 'unbind_request') ...[\n                      Expanded(\n                        flex: 1,\n                        child: OutlinedButton.icon(\n                          icon: const Icon(Icons.phone, size: 18, color: Colors.green),\n                          label: const Text('Call', style: TextStyle(fontSize: 13, color: Colors.green)),\n                          onPressed: () => _handleCall(senderUid),\n                          style: OutlinedButton.styleFrom(\n                            padding: const EdgeInsets.symmetric(horizontal: 0),\n                            side: const BorderSide(color: Colors.green),\n                          ),\n                        ),\n                      ),\n                      const SizedBox(width: 8),\n                      Expanded(\n                        flex: 2,\n                        child: ElevatedButton.icon(\n                          icon: const Icon(Icons.check, size: 18, color: Colors.white),\n                          label: const Text('Accept', style: TextStyle(fontSize: 13, color: Colors.white)),\n                          onPressed: () => _handleUnbindAccept(doc.id, senderUid, connectionId),\n                          style: ElevatedButton.styleFrom(\n                            backgroundColor: Colors.orange,\n                            padding: const EdgeInsets.symmetric(horizontal: 0),\n                          ),\n                        ),\n                      ),\n                      const SizedBox(width: 8),\n                      Expanded(\n                        flex: 2,\n                        child: ElevatedButton.icon(\n                          icon: const Icon(Icons.close, size: 18, color: Colors.white),\n                          label: const Text('Decline', style: TextStyle(fontSize: 13, color: Colors.white)),\n                          onPressed: () => _handleUnbindDecline(doc.id, connectionId),\n                          style: ElevatedButton.styleFrom(\n                            backgroundColor: Colors.red,\n                            padding: const EdgeInsets.symmetric(horizontal: 0),\n                          ),\n                        ),\n                      ),\n                    ],\n                  ],\n                ),\n              ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text('Notifications'),\n        centerTitle: true,\n        backgroundColor: Colors.blueAccent,\n      ),\n      body: StreamBuilder<QuerySnapshot>(\n        stream: _getNotificationsStream(),\n        builder: (context, snapshot) {\n          if (snapshot.connectionState == ConnectionState.waiting) {\n            return const Center(child: CircularProgressIndicator());\n          }\n          if (snapshot.hasError) {\n            return Center(\n              child: Text('Error loading notifications: ${snapshot.error}'),\n            );\n          }\n          if (snapshot.data == null || snapshot.data!.docs.isEmpty) {\n            return const Center(child: Text('You have no notifications.'));\n          }\n\n          final notifications = snapshot.data!.docs;\n\n          return ListView.builder(\n            itemCount: notifications.length,\n            itemBuilder: (context, index) {\n              return _buildNotificationCard(notifications[index]);\n            },\n          );\n        },\n      ),\n    );\n  }\n}",
        "_encoding": "utf-8"
      },
      "profile_screen.dart": {
        "_text": "import 'package:flutter/material.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport '../../welcome_page.dart';\nimport '../report_page.dart';\n\nclass Profile extends StatefulWidget {\n  const Profile({super.key});\n\n  @override\n  State<Profile> createState() => _ProfileState();\n}\n\nclass _ProfileState extends State<Profile> {\n  final FirebaseAuth _auth = FirebaseAuth.instance;\n  final FirebaseFirestore _firestore = FirebaseFirestore.instance;\n\n  Map<String, dynamic>? _userData;\n  bool _isLoading = true;\n\n  @override\n  void initState() {\n    super.initState();\n    _fetchUserData();\n  }\n\n  // --- Live Data Fetch Function ---\n  void _fetchUserData() async {\n    final user = _auth.currentUser;\n    if (user == null) {\n      if (mounted) {\n        setState(() => _isLoading = false);\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('No authenticated user found.')),\n        );\n      }\n      return;\n    }\n\n    try {\n      final docSnapshot =\n          await _firestore.collection('caretaker').doc(user.uid).get();\n\n      if (docSnapshot.exists && mounted) {\n        setState(() {\n          _userData = docSnapshot.data()!;\n          _isLoading = false;\n        });\n      } else if (mounted) {\n        setState(() => _isLoading = false);\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(\n              content: Text('User profile data not found in Firestore.')),\n        );\n      }\n    } catch (e) {\n      if (mounted) {\n        setState(() => _isLoading = false);\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Error fetching profile data: $e')),\n        );\n      }\n    }\n  }\n\n  // --- Log Out Function ---\n  void _logout() async {\n    await _auth.signOut();\n    if (mounted) {\n      Navigator.of(context).pushAndRemoveUntil(\n        MaterialPageRoute(builder: (context) => const WelcomePage()),\n        (Route<dynamic> route) => false,\n      );\n    }\n  }\n\n  // Helper to display experience/relation based on type\n  String _getRoleDetail() {\n    final type = _userData?['caregiverType'];\n    if (type == 'nurse') {\n      final years = _userData?['experienceYears'] ?? 0;\n      return 'Experience: $years years (Nurse)';\n    } else if (type == 'relative') {\n      final relation = _userData?['relation'] ?? 'N/A';\n      return 'Relation: $relation (Relative)';\n    }\n    return 'Role: Caretaker';\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    if (_isLoading) {\n      return Scaffold(\n        appBar: AppBar(\n          title: const Text('Profile'),\n          centerTitle: true,\n          backgroundColor: Colors.indigo,\n        ),\n        body: const Center(\n          child: CircularProgressIndicator(color: Colors.indigo),\n        ),\n      );\n    }\n\n    final profileImageUrl = _userData?['profileImageUrl'];\n\n    Widget profileImageWidget;\n    if (profileImageUrl != null && profileImageUrl.isNotEmpty) {\n      profileImageWidget = CircleAvatar(\n        radius: 60,\n        backgroundImage: NetworkImage(profileImageUrl),\n        backgroundColor: Colors.indigo.shade50,\n      );\n    } else {\n      profileImageWidget = CircleAvatar(\n        radius: 60,\n        backgroundColor: Colors.indigo.shade50,\n        child: const Icon(Icons.person, size: 60, color: Colors.indigo),\n      );\n    }\n\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text('Profile'),\n        centerTitle: true,\n        backgroundColor: Colors.indigo,\n      ),\n      body: SingleChildScrollView(\n        padding: const EdgeInsets.all(20),\n        child: Column(\n          crossAxisAlignment: CrossAxisAlignment.stretch,\n          children: [\n            const SizedBox(height: 50),\n\n            // Profile Card\n            Card(\n              elevation: 8,\n              shape: RoundedRectangleBorder(\n                borderRadius: BorderRadius.circular(16),\n              ),\n              child: Padding(\n                padding: const EdgeInsets.all(24),\n                child: Column(\n                  children: [\n                    profileImageWidget,\n                    const SizedBox(height: 16),\n                    Text(\n                      _userData?['fullName'] ?? 'User Name Not Set',\n                      style: const TextStyle(\n                        fontSize: 28,\n                        fontWeight: FontWeight.bold,\n                        color: Colors.indigo,\n                      ),\n                    ),\n                    const SizedBox(height: 8),\n                    Text(\n                      _getRoleDetail(),\n                      style: const TextStyle(fontSize: 16, color: Colors.black87),\n                    ),\n                    const SizedBox(height: 4),\n                    Text(\n                      'Contact: ${_userData?['phoneNo'] ?? 'N/A'}',\n                      style: const TextStyle(fontSize: 16, color: Colors.black54),\n                    ),\n                  ],\n                ),\n              ),\n            ),\n\n            const SizedBox(height: 40),\n\n            // Reports Sent Section\n            Card(\n              elevation: 4,\n              shape: RoundedRectangleBorder(\n                borderRadius: BorderRadius.circular(12),\n              ),\n              child: Column(\n                children: [\n                  ListTile(\n                    leading:\n                        const Icon(Icons.file_present, color: Colors.indigo),\n                    title: const Text(\n                      'Reports Sent',\n                      style: TextStyle(fontWeight: FontWeight.w500),\n                    ),\n                    trailing: const Icon(Icons.arrow_forward_ios,\n                        size: 16, color: Colors.grey),\n                    onTap: () {\n                      // Navigate to reports screen\n                    },\n                  ),\n\n                  // 🔹 Added Report Option\n                  ListTile(\n                    leading: const Icon(Icons.report, color: Colors.orange),\n                    title: const Text('Report',\n                        style: TextStyle(fontWeight: FontWeight.w500)),\n                    trailing: const Icon(Icons.arrow_forward_ios,\n                        size: 16, color: Colors.grey),\n                    onTap: () => Navigator.push(\n                      context,\n                      MaterialPageRoute(\n                        builder: (context) =>\n                            const ReportPage(reporterRole: 'caretaker'),\n                      ),\n                    ),\n                  ),\n                ],\n              ),\n            ),\n\n            const SizedBox(height: 20),\n\n            // Log Out Setting\n            Card(\n              elevation: 4,\n              shape: RoundedRectangleBorder(\n                borderRadius: BorderRadius.circular(12),\n              ),\n              child: ListTile(\n                leading: const Icon(Icons.logout, color: Colors.red),\n                title: const Text(\n                  'Log Out',\n                  style: TextStyle(\n                    fontWeight: FontWeight.w500,\n                    color: Colors.red,\n                  ),\n                ),\n                trailing: const Icon(Icons.arrow_forward_ios,\n                    size: 16, color: Colors.grey),\n                onTap: _logout,\n              ),\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n}\n",
        "_encoding": "utf-8"
      },
      "user_screen.dart": {
        "_text": "import 'package:flutter/material.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:intl/intl.dart';\n\nimport 'caretaker_map_screen.dart';\n\nclass UserScreen extends StatefulWidget {\n  const UserScreen({super.key});\n\n  @override\n  State<UserScreen> createState() => _UserScreenState();\n}\n\nclass _UserScreenState extends State<UserScreen> {\n  final FirebaseAuth _auth = FirebaseAuth.instance;\n  final FirebaseFirestore _firestore = FirebaseFirestore.instance;\n\n  String? _patientUid;\n  String? _patientName;\n  bool _isConnected = false;\n  bool _isLoading = true;\n\n  String _selectedTab = 'Today';\n\n  @override\n  void initState() {\n    super.initState();\n    _checkConnectionStatus();\n  }\n\n  Future<void> _checkConnectionStatus() async {\n    final caretakerUid = _auth.currentUser?.uid;\n\n    if (caretakerUid == null || !mounted) {\n      if (mounted) setState(() => _isLoading = false);\n      return;\n    }\n\n    try {\n      final caretakerDoc = await _firestore.collection('caretaker').doc(caretakerUid).get();\n      final data = caretakerDoc.data();\n\n      final isConnectedField = data?['isConnected'] as bool? ?? false;\n      final connectionId = data?['currentConnectionId'] as String?;\n\n      if (isConnectedField && connectionId != null && connectionId.isNotEmpty) {\n        final connectionDoc = await _firestore.collection('connections').doc(connectionId).get();\n        final patientUid = connectionDoc.data()?['user_uid'] as String?;\n\n        if (patientUid != null) {\n          final patientDoc = await _firestore.collection('user').doc(patientUid).get();\n\n          if (patientDoc.exists) {\n            if (mounted) {\n              setState(() {\n                _patientUid = patientUid;\n                _patientName = patientDoc.data()?['fullName'] ?? 'Unknown Patient';\n                _isConnected = true;\n                _isLoading = false;\n              });\n            }\n            return;\n          }\n        }\n      }\n\n      if (mounted) {\n        setState(() {\n          _patientUid = null;\n          _isConnected = false;\n          _isLoading = false;\n        });\n      }\n    } catch (e) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Error checking connection: $e')),\n        );\n        setState(() {\n          _patientUid = null;\n          _isConnected = false;\n          _isLoading = false;\n        });\n      }\n    }\n  }\n\n  // -------- TASK STREAM --------\n  Stream<QuerySnapshot<Map<String, dynamic>>> _getTasksStream() {\n    if (_patientUid == null) return Stream.empty();\n\n    final coll = _firestore.collection('user').doc(_patientUid).collection('to_dos');\n\n    final now = DateTime.now();\n    final todayMidnight = DateTime(now.year, now.month, now.day);\n    final tomorrowMidnight = todayMidnight.add(const Duration(days: 1));\n    final todayStart = Timestamp.fromDate(todayMidnight);\n    final todayEnd = Timestamp.fromDate(tomorrowMidnight);\n\n    final recurringColl = _firestore.collection('user').doc(_patientUid).collection('recurring_tasks');\n\n    if (_selectedTab == 'Recurring') {\n      return recurringColl.orderBy('createdAt', descending: true).snapshots();\n    } else if (_selectedTab == 'Today') {\n      return coll\n          .where('dueDate', isGreaterThanOrEqualTo: todayStart)\n          .where('dueDate', isLessThan: todayEnd)\n          .orderBy('dueDate', descending: false)\n          .snapshots();\n    } else if (_selectedTab == 'Upcoming') {\n      return coll.where('dueDate', isGreaterThanOrEqualTo: todayEnd).orderBy('dueDate', descending: false).snapshots();\n    } else if (_selectedTab == 'Completed') {\n      return coll.where('completed', isEqualTo: true).snapshots();\n    } else if (_selectedTab == 'All') {\n      return coll.orderBy('dueDate', descending: true).snapshots();\n    } else {\n      return Stream.empty();\n    }\n  }\n\n  String _formatTimestamp(Timestamp? ts) {\n    if (ts == null) return 'N/A';\n    return DateFormat('MMM dd, hh:mm a').format(ts.toDate());\n  }\n\n  String _formatTimeMap(Map<String, dynamic>? timeMap) {\n    if (timeMap == null) return 'N/A';\n    final hour = (timeMap['hour'] as int? ?? 0).toString().padLeft(2, '0');\n    final min = (timeMap['min'] as int? ?? 0).toString().padLeft(2, '0');\n    return '$hour:$min';\n  }\n\n  Widget _buildPatientDetails() {\n    return Card(\n      elevation: 4,\n      margin: const EdgeInsets.all(16),\n      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n      child: Padding(\n        padding: const EdgeInsets.all(16),\n        child: Column(crossAxisAlignment: CrossAxisAlignment.start, children: [\n          const Text('👤 Patient Details', style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),\n          const SizedBox(height: 8),\n          Text('Name: ${_patientName ?? 'Loading...'}'),\n          const Text('Age: 65'),\n          const Text('Condition: Dementia, recovering from surgery'),\n        ]),\n      ),\n    );\n  }\n\n  Widget _buildTaskCard(DocumentSnapshot doc) {\n    final task = doc.data() as Map<String, dynamic>;\n    final isTemplate = _selectedTab == 'Recurring';\n\n    final completed = isTemplate ? false : (task['completed'] as bool? ?? false);\n    final title = task['task'] as String? ?? 'Untitled Task';\n    final details = task['description'] as String? ?? 'No details provided.';\n    final dueDate = task['dueDate'] as Timestamp?;\n    final reminderTime = task['reminderTime'] as Timestamp?;\n\n    final Map<String, dynamic>? dailyDueTime = task['dailyDueTime'] as Map<String, dynamic>?;\n    final Map<String, dynamic>? dailyReminderTime = task['dailyReminderTime'] as Map<String, dynamic>?;\n\n    return Card(\n      elevation: 3,\n      margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),\n      child: ExpansionTile(\n        key: Key(doc.id),\n        leading: Icon(\n          isTemplate ? Icons.repeat : (completed ? Icons.check_circle : Icons.list_alt),\n          color: isTemplate ? Colors.indigo : (completed ? Colors.green : Colors.orange),\n        ),\n        title: Text(\n          title,\n          style: TextStyle(\n            decoration: completed ? TextDecoration.lineThrough : null,\n            fontWeight: FontWeight.w500,\n          ),\n        ),\n        subtitle: isTemplate\n            ? const Text('Daily Template', style: TextStyle(color: Colors.blue))\n            : Text(\n                'Status: ${completed ? 'Completed' : 'Pending'} | Due: ${_formatTimestamp(dueDate)}',\n                style: TextStyle(color: completed ? Colors.green : Colors.red),\n              ),\n        children: [\n          Padding(\n            padding: const EdgeInsets.symmetric(horizontal: 16.0, vertical: 8),\n            child: Column(crossAxisAlignment: CrossAxisAlignment.start, children: [\n              if (details.isNotEmpty) Padding(padding: const EdgeInsets.only(bottom: 8.0), child: Text('Details: $details')),\n              const Divider(height: 1, color: Colors.grey),\n              const SizedBox(height: 8),\n              Text('Created At: ${_formatTimestamp(task['createdAt'] as Timestamp?)}'),\n              Text('Created By: ${task['createdBy'] as String? ?? 'N/A'}'),\n              if (!isTemplate) Text('Scheduled Reminder: ${reminderTime is Timestamp ? _formatTimestamp(reminderTime) : 'None'}'),\n              if (isTemplate) ...[\n                Text('Daily Due Time: ${_formatTimeMap(dailyDueTime)}'),\n                Text('Daily Reminder Time: ${_formatTimeMap(dailyReminderTime)}'),\n              ],\n            ]),\n          ),\n        ],\n      ),\n    );\n  }\n\n  Widget _filterChip(String label) {\n    return ChoiceChip(\n      label: Text(label),\n      selected: _selectedTab == label,\n      onSelected: (sel) {\n        if (sel) setState(() => _selectedTab = label);\n      },\n    );\n  }\n\n  Widget _buildNotConnectedState() {\n    return const Center(\n      child: Padding(\n        padding: EdgeInsets.all(32.0),\n        child: Column(\n          mainAxisAlignment: MainAxisAlignment.center,\n          children: [\n            Icon(Icons.person_off, size: 80, color: Colors.red),\n            SizedBox(height: 16),\n            Text('Not Connected to any Patient', style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold)),\n            SizedBox(height: 8),\n            Text(\n              'Please ensure your profile is linked to a patient user to view and manage tasks.',\n              textAlign: TextAlign.center,\n              style: TextStyle(color: Colors.grey),\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  void _openFaceScanner() {\n    if (!_isConnected || _patientUid == null) {\n      ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Cannot open scanner: Not connected')));\n    }\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    if (_isLoading) {\n      return Scaffold(\n        appBar: AppBar(title: const Text('Loading...'), backgroundColor: Colors.indigo),\n        body: const Center(child: CircularProgressIndicator()),\n      );\n    }\n\n    if (!_isConnected) {\n      return Scaffold(\n        appBar: AppBar(title: const Text('Caretaker View'), centerTitle: true, backgroundColor: Colors.indigo),\n        body: _buildNotConnectedState(),\n      );\n    }\n\n    return Scaffold(\n      appBar: AppBar(\n        title: Text('Patient: ${_patientName ?? 'N/A'}'),\n        centerTitle: true,\n        backgroundColor: Colors.indigo,\n      ),\n      floatingActionButton: _isConnected && _patientUid != null\n          ? Column(\n              mainAxisSize: MainAxisSize.min,\n              crossAxisAlignment: CrossAxisAlignment.end,\n              children: [\n                // FIX: Add unique hero tags to prevent conflicts\n                FloatingActionButton.extended(\n                  heroTag: 'face_scan_btn', // UNIQUE TAG\n                  onPressed: _openFaceScanner,\n                  label: const Text('Face Scan', style: TextStyle(color: Colors.white)),\n                  icon: const Icon(Icons.face_unlock_outlined, color: Colors.white),\n                  backgroundColor: Colors.indigo,\n                ),\n                const SizedBox(height: 12),\n                FloatingActionButton.extended(\n                  heroTag: 'track_location_btn', // UNIQUE TAG\n                  onPressed: () {\n                    if (_patientUid != null) {\n                      Navigator.push(\n                        context,\n                        MaterialPageRoute(\n                          builder: (_) => CaretakerMapScreen(patientId: _patientUid!),\n                        ),\n                      );\n                    }\n                  },\n                  label: const Text('Track Location', style: TextStyle(color: Colors.white)),\n                  icon: const Icon(Icons.location_on_outlined, color: Colors.white),\n                  backgroundColor: Colors.green,\n                ),\n              ],\n            )\n          : null,\n      body: Column(\n        children: [\n          _buildPatientDetails(),\n          const Divider(),\n          SingleChildScrollView(\n            scrollDirection: Axis.horizontal,\n            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),\n            child: Row(\n              children: [\n                _filterChip('Today'),\n                const SizedBox(width: 8),\n                _filterChip('Upcoming'),\n                const SizedBox(width: 8),\n                _filterChip('Completed'),\n                const SizedBox(width: 8),\n                _filterChip('All'),\n                const SizedBox(width: 8),\n                _filterChip('Recurring'),\n              ],\n            ),\n          ),\n          Expanded(\n            child: StreamBuilder<QuerySnapshot>(\n              stream: _getTasksStream(),\n              builder: (context, snapshot) {\n                if (snapshot.hasError) return Center(child: Text('Error: ${snapshot.error}'));\n                if (snapshot.connectionState == ConnectionState.waiting) return const Center(child: CircularProgressIndicator());\n                if (snapshot.data == null || snapshot.data!.docs.isEmpty) {\n                  return Center(child: Text('No $_selectedTab tasks found.'));\n                }\n\n                var docs = snapshot.data!.docs;\n                if (_selectedTab == 'Completed') {\n                  docs.sort((a, b) {\n                    final aData = a.data() as Map<String, dynamic>;\n                    final bData = b.data() as Map<String, dynamic>;\n                    final aDate = (aData['dueDate'] as Timestamp?)?.toDate() ?? DateTime(0);\n                    final bDate = (bData['dueDate'] as Timestamp?)?.toDate() ?? DateTime(0);\n                    return bDate.compareTo(aDate);\n                  });\n                }\n\n                return ListView.builder(\n                  itemCount: docs.length,\n                  itemBuilder: (context, index) => _buildTaskCard(docs[index]),\n                );\n              },\n            ),\n          ),\n        ],\n      ),\n    );\n  }\n}",
        "_encoding": "utf-8"
      }
    },
    "user": {
      
     
      
      "home": {
        "add_task_page.dart": {
          "_text": "// lib/user/home/add_task_page.dart\n// lib/user/home/add_task_page.dart\nimport 'package:flutter/material.dart';\nimport 'package:intl/intl.dart';\n\nclass AddTaskPage extends StatefulWidget {\n  final bool isTemplate;\n  const AddTaskPage({super.key, this.isTemplate = false});\n\n  @override\n  State<AddTaskPage> createState() => _AddTaskPageState();\n}\n\nclass _AddTaskPageState extends State<AddTaskPage> {\n  final TextEditingController _taskController = TextEditingController();\n  final TextEditingController _descController = TextEditingController();\n  String _recurring = 'None';\n  DateTime? _dueDate;\n  DateTime? _reminderTime;\n  TimeOfDay? _dailyDueTime;\n  TimeOfDay? _dailyReminderTime;\n\n  Future<void> _pickDueDate() async {\n    final picked = await showDatePicker(\n      context: context,\n      initialDate: DateTime.now(),\n      firstDate: DateTime.now(),\n      lastDate: DateTime(2100),\n    );\n    if (picked != null && mounted) {\n      final time = await showTimePicker(\n        context: context,\n        initialTime: TimeOfDay.now(),\n      );\n      if (time != null && mounted) {\n        setState(() {\n          _dueDate = DateTime(\n            picked.year,\n            picked.month,\n            picked.day,\n            time.hour,\n            time.minute,\n          );\n        });\n      }\n    }\n  }\n\n  Future<void> _pickReminderTime() async {\n    final pickedDate = await showDatePicker(\n      context: context,\n      initialDate: DateTime.now(),\n      firstDate: DateTime.now(),\n      lastDate: DateTime(2100),\n    );\n    if (pickedDate != null && mounted) {\n      final pickedTime = await showTimePicker(\n        context: context,\n        initialTime: TimeOfDay.now(),\n      );\n      if (pickedTime != null && mounted) {\n        setState(() {\n          _reminderTime = DateTime(\n            pickedDate.year,\n            pickedDate.month,\n            pickedDate.day,\n            pickedTime.hour,\n            pickedTime.minute,\n          );\n        });\n      }\n    }\n  }\n\n  Future<void> _pickDailyDueTime() async {\n    final picked = await showTimePicker(\n      context: context,\n      initialTime: _dailyDueTime ?? TimeOfDay.now(),\n    );\n    if (picked != null && mounted) setState(() => _dailyDueTime = picked);\n  }\n\n  Future<void> _pickDailyReminderTime() async {\n    final picked = await showTimePicker(\n      context: context,\n      initialTime: _dailyReminderTime ?? TimeOfDay.now(),\n    );\n    if (picked != null && mounted) setState(() => _dailyReminderTime = picked);\n  }\n\n  @override\n  void initState() {\n    super.initState();\n    if (widget.isTemplate) {\n      _recurring = 'Daily';\n    }\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final isDaily = _recurring == 'Daily';\n    return Scaffold(\n      appBar: AppBar(\n        title: Text(isDaily || widget.isTemplate ? 'Add Daily Template' : 'Add Task'),\n        backgroundColor: Colors.blueAccent,\n        elevation: 0,\n      ),\n      body: Container(\n        decoration: BoxDecoration(\n          gradient: LinearGradient(\n            begin: Alignment.topCenter,\n            end: Alignment.bottomCenter,\n            colors: [Colors.blueAccent.withOpacity(0.1), Colors.white],\n          ),\n        ),\n        child: SingleChildScrollView(\n          padding: const EdgeInsets.all(24.0),\n          child: Column(\n            crossAxisAlignment: CrossAxisAlignment.start,\n            children: [\n              const Text(\n                'Task Details',\n                style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold, color: Colors.blueAccent),\n              ),\n              const SizedBox(height: 24),\n              TextField(\n                controller: _taskController,\n                decoration: InputDecoration(\n                  labelText: 'Task Name',\n                  border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),\n                  filled: true,\n                  fillColor: Colors.white,\n                  prefixIcon: const Icon(Icons.task),\n                ),\n              ),\n              const SizedBox(height: 16),\n              TextField(\n                controller: _descController,\n                decoration: InputDecoration(\n                  labelText: 'Description (optional)',\n                  border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),\n                  filled: true,\n                  fillColor: Colors.white,\n                  prefixIcon: const Icon(Icons.description),\n                ),\n                maxLines: 3,\n              ),\n              const SizedBox(height: 24),\n              const Text(\n                'Recurrence',\n                style: TextStyle(fontSize: 18, fontWeight: FontWeight.w600),\n              ),\n              const SizedBox(height: 8),\n              DropdownButtonFormField<String>(\n                value: _recurring,\n                decoration: InputDecoration(\n                  border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),\n                  filled: true,\n                  fillColor: Colors.white,\n                ),\n                items: ['None', 'Daily'].map((e) => DropdownMenuItem(value: e, child: Text(e))).toList(),\n                onChanged: (val) => setState(() => _recurring = val!),\n              ),\n              const SizedBox(height: 24),\n              if (!isDaily)\n                Card(\n                  elevation: 2,\n                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                  child: ListTile(\n                    title: Text(_dueDate == null ? 'Set Due Date & Time' : DateFormat('MMM dd, yyyy hh:mm a').format(_dueDate!)),\n                    trailing: const Icon(Icons.calendar_today, color: Colors.blueAccent),\n                    onTap: _pickDueDate,\n                  ),\n                ),\n              if (!isDaily) const SizedBox(height: 8),\n              if (!isDaily)\n                Card(\n                  elevation: 2,\n                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                  child: ListTile(\n                    title: Text(_reminderTime == null ? 'Set Reminder (optional)' : DateFormat('MMM dd, yyyy hh:mm a').format(_reminderTime!)),\n                    trailing: const Icon(Icons.alarm, color: Colors.orange),\n                    onTap: _pickReminderTime,\n                  ),\n                ),\n              if (isDaily)\n                Card(\n                  elevation: 2,\n                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                  child: ListTile(\n                    title: Text(_dailyDueTime == null ? 'Set Daily Due Time' : _dailyDueTime!.format(context)),\n                    trailing: const Icon(Icons.access_time, color: Colors.blueAccent),\n                    onTap: _pickDailyDueTime,\n                  ),\n                ),\n              if (isDaily) const SizedBox(height: 8),\n              if (isDaily)\n                Card(\n                  elevation: 2,\n                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                  child: ListTile(\n                    title: Text(_dailyReminderTime == null ? 'Set Daily Reminder (optional)' : _dailyReminderTime!.format(context)),\n                    trailing: const Icon(Icons.alarm, color: Colors.orange),\n                    onTap: _pickDailyReminderTime,\n                  ),\n                ),\n              const SizedBox(height: 32),\n              ElevatedButton(\n                onPressed: () {\n                  if (_taskController.text.trim().isEmpty) {\n                    ScaffoldMessenger.of(context).showSnackBar(\n                      const SnackBar(content: Text('Task name cannot be empty')),\n                    );\n                    return;\n                  }\n                  if (isDaily && _dailyDueTime == null) {\n                    ScaffoldMessenger.of(context).showSnackBar(\n                      const SnackBar(content: Text('Daily due time required')),\n                    );\n                    return;\n                  }\n                  final map = <String, dynamic>{\n                    'task': _taskController.text.trim(),\n                    'description': _descController.text.trim(),\n                    'recurring': _recurring,\n                  };\n                  if (isDaily) {\n                    map['dailyDueTime'] = _dailyDueTime != null \n                      ? {'hour': _dailyDueTime!.hour, 'min': _dailyDueTime!.minute} \n                      : null;\n                    map['dailyReminderTime'] = _dailyReminderTime != null \n                      ? {'hour': _dailyReminderTime!.hour, 'min': _dailyReminderTime!.minute} \n                      : null;\n                  } else {\n                    map['dueDate'] = _dueDate;\n                    map['reminderTime'] = _reminderTime;\n                  }\n                  Navigator.pop(context, map);\n                },\n                style: ElevatedButton.styleFrom(\n                  backgroundColor: Colors.blueAccent,\n                  padding: const EdgeInsets.symmetric(vertical: 16),\n                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                  minimumSize: const Size(double.infinity, 50),\n                ),\n                child: const Text('Save', style: TextStyle(fontSize: 18, color: Colors.white)),\n              ),\n            ],\n          ),\n        ),\n      ),\n    );\n  }\n\n  @override\n  void dispose() {\n    _taskController.dispose();\n    _descController.dispose();\n    super.dispose();\n  }\n}",
          "_encoding": "utf-8"
        },
        "ai_chat_page.dart": {
          "_text": "// lib/user/home/ai_chat_page.dart\nimport 'dart:convert';\nimport 'dart:developer';\n\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/material.dart';\nimport 'package:flutter_animate/flutter_animate.dart';\nimport 'package:flutter_gemini/flutter_gemini.dart';\nimport 'package:intl/intl.dart';\nimport 'package:shared_preferences/shared_preferences.dart';\n\nclass AIChatPage extends StatefulWidget {\n  const AIChatPage({super.key});\n\n  @override\n  State<AIChatPage> createState() => _AIChatPageState();\n}\n\nclass _AIChatPageState extends State<AIChatPage> {\n  final TextEditingController _controller = TextEditingController();\n  final String currentUserId = FirebaseAuth.instance.currentUser!.uid;\n  final String _chatStorageKey = 'dementia_ai_chat_history';\n  final List<String> _userInputHistory = [];\n  final _firestore = FirebaseFirestore.instance;\n  final _gemini = Gemini.instance;\n  late SharedPreferences _prefs;\n\n  List<Map<String, String>> _chatHistory = [];\n  Map<String, dynamic>? _userData;\n  int _remainingTasks = 0;\n  int _completedTasks = 0;\n  String _systemPrompt = '';\n  bool _isLoading = false;\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  @override\n  void initState() {\n    super.initState();\n    _initializeStorage();\n    _fetchUserData();\n  }\n\n  Future<void> _initializeStorage() async {\n    _prefs = await SharedPreferences.getInstance();\n    _loadChatHistory();\n  }\n\n  Future<void> _loadChatHistory() async {\n    try {\n      final String? chatHistoryJson = _prefs.getString(_chatStorageKey);\n      if (chatHistoryJson != null) {\n        final List<dynamic> decodedList = json.decode(chatHistoryJson);\n        if (mounted) {\n          setState(() {\n            _chatHistory = decodedList\n                .map((item) => Map<String, String>.from(item))\n                .toList();\n          });\n        }\n      }\n    } catch (e) {\n      log('Error loading chat history: $e');\n    }\n  }\n\n  Future<void> _saveChatHistory() async {\n    try {\n      final String chatHistoryJson = json.encode(_chatHistory);\n      await _prefs.setString(_chatStorageKey, chatHistoryJson);\n    } catch (e) {\n      log('Error saving chat history: $e');\n    }\n  }\n\n  void _addMessageToHistory(Map<String, String> message) {\n    if (message['role'] != 'error') {\n      if (mounted) {\n        setState(() {\n          _chatHistory.add(message);\n        });\n      }\n      _saveChatHistory();\n    } else {\n      if (mounted) {\n        setState(() {\n          _chatHistory.add(message);\n        });\n        Future.delayed(const Duration(seconds: 5), () {\n          if (mounted) {\n            setState(() {\n              _chatHistory.removeWhere((msg) =>\n                  msg['role'] == 'error' &&\n                  msg['message'] == message['message']);\n            });\n          }\n        });\n      }\n    }\n  }\n\n  Future<void> _fetchUserData() async {\n  try {\n    if (mounted) setState(() => _isLoading = true);\n\n    final uid = currentUserId;\n\n    // Load user data\n    final userDoc = await _firestore.collection('user').doc(uid).get();\n    if (userDoc.exists && mounted) {\n      setState(() {\n        _userData = userDoc.data();\n      });\n    }\n\n    // Load today's tasks\n    final today = DateTime.now();\n    final todayStart = Timestamp.fromDate(\n      DateTime(today.year, today.month, today.day),\n    );\n    final todayEnd = Timestamp.fromDate(\n      DateTime(today.year, today.month, today.day, 23, 59, 59),\n    );\n\n    final tasksSnap = await _firestore\n        .collection('user')\n        .doc(uid)\n        .collection('to_dos')\n        .where('dueDate', isGreaterThanOrEqualTo: todayStart)\n        .where('dueDate', isLessThanOrEqualTo: todayEnd)\n        .get();\n\n    final incompleteTasks = tasksSnap.docs\n        .where((doc) => doc.data()['completed'] == false)\n        .map((doc) {\n      final data = doc.data();\n      final dueTime = data['dueDate'] != null\n          ? DateFormat('hh:mm a').format((data['dueDate'] as Timestamp).toDate())\n          : 'Unknown time';\n      return '- ${data['task']} (Due: $dueTime)';\n    }).toList();\n\n    if (mounted) {\n      setState(() {\n        _remainingTasks = incompleteTasks.length;\n        _completedTasks = tasksSnap.docs.length - incompleteTasks.length;\n\n        // Build system prompt\n        _systemPrompt = '''\nYou are a compassionate AI assistant named \"Dementia Helper\" for a person with dementia.\n- Provide gentle reminders about tasks.\n- Remind about incomplete tasks with names and due times.\n- Offer emotional support and guidance.\n- Keep responses concise, calm, and positive.\n\nUser Info:\n- Name: ${_userData?['fullName'] ?? 'User'}\n- Age: ${_calculateAge(_userData?['dob']) ?? 'Unknown'}\n- Today's date: ${DateFormat('MMMM dd, yyyy').format(DateTime.now())}\n\nToday's incomplete tasks:\n${incompleteTasks.isEmpty ? 'No pending tasks' : incompleteTasks.join('\\n')}\n\nSummary:\n- Remaining tasks: $_remainingTasks\n- Completed tasks: $_completedTasks\n\nAlways start conversations with a warm greeting and address the user by name if important. If the user mentions tasks, reference the summary above. Encourage completion of remaining tasks gently. If asked about past events, suggest checking the diary. Never overwhelm with too much information.\n''';\n\n        // Initial AI greeting\n        if (_chatHistory.isEmpty) {\n          _addMessageToHistory({\n            'role': 'model',\n            'message':\n                'Hello ${_userData?['fullName'] ?? 'there'}! You have $_remainingTasks tasks left for today. I\\'m your Dementia Helper. How can I assist you?',\n          });\n        }\n      });\n    }\n  } catch (e) {\n    log('Error fetching user data: $e');\n    if (mounted) {\n      ScaffoldMessenger.of(context).showSnackBar(\n        SnackBar(content: Text('Error loading data: $e')),\n      );\n    }\n  } finally {\n    if (mounted) setState(() => _isLoading = false);\n  }\n}\n\n\n  int? _calculateAge(Timestamp? dob) {\n    if (dob == null) return null;\n    final birthDate = dob.toDate();\n    final today = DateTime.now();\n    int age = today.year - birthDate.year;\n    if (today.month < birthDate.month ||\n        (today.month == birthDate.month && today.day < birthDate.day)) {\n      age--;\n    }\n    return age;\n  }\n\n  Future<void> clearChatHistory() async {\n    try {\n      await _prefs.remove(_chatStorageKey);\n      if (mounted) {\n        setState(() {\n          _chatHistory = [];\n          _addMessageToHistory({\n            'role': 'model',\n            'message':\n                'Hello ${_userData?['fullName'] ?? 'there'}! I\\'m your Dementia Helper. How can I assist you today? You have $_remainingTasks tasks left for today.',\n          });\n        });\n      }\n    } catch (e) {\n      log('Error clearing chat history: $e');\n    }\n  }\n\n  Future<void> _showClearChatDialog() async {\n    return showDialog<void>(\n      context: context,\n      builder: (BuildContext context) {\n        return AlertDialog(\n          backgroundColor: Colors.white,\n          title: const Text('Clear Chat History'),\n          content: const Text(\n            'Are you sure you want to clear all chat history? This action cannot be undone.',\n          ),\n          actions: <Widget>[\n            TextButton(\n              child: const Text('Cancel'),\n              onPressed: () {\n                Navigator.of(context).pop();\n              },\n            ),\n            TextButton(\n              child: const Text(\n                'Clear',\n                style: TextStyle(color: Colors.red),\n              ),\n              onPressed: () {\n                clearChatHistory();\n                Navigator.of(context).pop();\n                ScaffoldMessenger.of(context).showSnackBar(\n                  const SnackBar(\n                    content: Text('Chat history cleared'),\n                    duration: Duration(seconds: 2),\n                  ),\n                );\n              },\n            ),\n          ],\n        );\n      },\n    );\n  }\n\n  void _sendMessage(String userMessage) async {\n    if (userMessage.trim().isEmpty) return;\n\n    _userInputHistory.add(userMessage);\n    if (_userInputHistory.length > 5) {\n      _userInputHistory.removeAt(0);\n    }\n\n    _addMessageToHistory({'role': 'user', 'message': userMessage});\n\n    if (mounted) {\n      setState(() {\n        _isLoading = true;\n      });\n    }\n\n    try {\n      final conversation = [\n        Content(parts: [Part.text(_systemPrompt)], role: 'user'),\n        ..._chatHistory.map(\n          (msg) => Content(\n            parts: [Part.text(msg['message']!)],\n            role: msg['role'],\n          ),\n        ),\n        Content(parts: [Part.text(userMessage)], role: 'user'),\n      ];\n      final response = await _gemini.chat(conversation);\n      if (mounted) {\n        setState(() {\n          _addMessageToHistory({\n            'role': 'model',\n            'message': response?.output ?? 'No response received',\n          });\n        });\n      }\n    } catch (e) {\n      log('Error in chat: $e');\n      if (mounted) {\n        setState(() {\n          _addMessageToHistory({\n            'role': 'error',\n            'message':\n                'Response not loading. Please try again or check your internet connection.',\n          });\n        });\n      }\n    } finally {\n      if (mounted) {\n        setState(() {\n          _isLoading = false;\n        });\n      }\n    }\n  }\n\n  Widget _buildMessageBubble(String message, String role,\n      {bool isLoading = false}) {\n    bool isUser = role == 'user';\n    return Align(\n      alignment: isUser ? Alignment.centerRight : Alignment.centerLeft,\n      child: Container(\n        margin: const EdgeInsets.symmetric(vertical: 8.0, horizontal: 12.0),\n        padding: const EdgeInsets.symmetric(vertical: 15.0, horizontal: 18.0),\n        decoration: BoxDecoration(\n          color: isUser ? Colors.blueAccent : Colors.grey[200],\n          borderRadius: BorderRadius.only(\n            topLeft: const Radius.circular(20.0),\n            topRight: const Radius.circular(20.0),\n            bottomLeft: isUser ? const Radius.circular(20.0) : Radius.zero,\n            bottomRight: isUser ? Radius.zero : const Radius.circular(20.0),\n          ),\n          boxShadow: [\n            BoxShadow(\n              color: Colors.black.withOpacity(0.1),\n              offset: const Offset(0, 2),\n              blurRadius: 4.0,\n            ),\n          ],\n        ),\n        child: isLoading\n            ? const LoadingAnimation()\n            : Text(\n                message,\n                style: TextStyle(\n                  fontSize: 16.0,\n                  color: isUser ? Colors.white : Colors.black87,\n                  fontWeight: FontWeight.w400,\n                  height: 1.4,\n                ),\n              ),\n      ),\n    );\n  }\n\n  Widget _buildChatList() {\n    return ListView.builder(\n      itemCount: _chatHistory.length + (_isLoading ? 1 : 0),\n      padding: const EdgeInsets.symmetric(vertical: 8.0),\n      itemBuilder: (context, index) {\n        if (index == _chatHistory.length && _isLoading) {\n          return _buildMessageBubble('', 'model', isLoading: true);\n        }\n        final message = _chatHistory[index];\n        return _buildMessageBubble(message['message']!, message['role']!)\n            .animate()\n            .fadeIn(duration: 300.ms)\n            .slideX(begin: message['role'] == 'user' ? 0.2 : -0.2);\n      },\n    );\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      backgroundColor: Colors.white,\n      appBar: AppBar(\n        backgroundColor: Colors.blueAccent,\n        iconTheme: const IconThemeData(color: Colors.white),\n        title: Row(\n          children: [\n            const CircleAvatar(\n              backgroundImage: AssetImage('assets/aiIcon.png'),\n              backgroundColor: Colors.blueAccent,\n              radius: 30,\n            ),\n            const SizedBox(width: 10),\n            const Text(\n              'Dementia Helper',\n              style: TextStyle(fontSize: 18, color: Colors.white),\n            ),\n          ],\n        ),\n        actions: [\n          if (_chatHistory.isNotEmpty)\n            IconButton(\n              icon: const Icon(Icons.delete_outline),\n              onPressed: _showClearChatDialog,\n              tooltip: 'Clear chat history',\n            ),\n        ],\n      ),\n      body: SafeArea(\n        child: Column(\n          children: [\n            Expanded(\n              child: _isLoading && _chatHistory.isEmpty\n                  ? const Center(child: LoadingAnimation())\n                  : _chatHistory.isEmpty\n                      ? const Center(\n                          child: Text(\n                            'Start a conversation with Dementia Helper',\n                            style:\n                                TextStyle(fontSize: 16, color: Colors.black54),\n                          ),\n                        )\n                      : _buildChatList(),\n            ),\n            const Divider(height: 1),\n            Container(\n              color: Colors.grey[200],\n              child: Padding(\n                padding: const EdgeInsets.all(8.0),\n                child: Row(\n                  children: [\n                    Expanded(\n                      child: Padding(\n                        padding: const EdgeInsets.symmetric(horizontal: 10),\n                        child: TextField(\n                          controller: _controller,\n                          decoration: InputDecoration(\n                            hintText: 'Type a message...',\n                            hintStyle: const TextStyle(\n                                color: Colors.black54, fontSize: 16),\n                            filled: true,\n                            fillColor: Colors.white,\n                            contentPadding: const EdgeInsets.symmetric(\n                                vertical: 16, horizontal: 16),\n                            border: OutlineInputBorder(\n                              borderRadius: BorderRadius.circular(30),\n                              borderSide: BorderSide.none,\n                            ),\n                            focusedBorder: OutlineInputBorder(\n                              borderRadius: BorderRadius.circular(30),\n                              borderSide: BorderSide.none,\n                            ),\n                            enabledBorder: OutlineInputBorder(\n                              borderRadius: BorderRadius.circular(30),\n                              borderSide: BorderSide.none,\n                            ),\n                          ),\n                          minLines: 1,\n                          maxLines: 5,\n                          onSubmitted: (_) {\n                            final message = _controller.text;\n                            _controller.clear();\n                            _sendMessage(message);\n                          },\n                          style: const TextStyle(color: Colors.black87),\n                        ),\n                      ),\n                    ),\n                    Padding(\n                      padding: const EdgeInsets.only(left: 4),\n                      child: IconButton(\n                        icon: const Icon(\n                          Icons.send,\n                          color: Colors.blueAccent,\n                        ),\n                        onPressed: () {\n                          final message = _controller.text;\n                          _controller.clear();\n                          _sendMessage(message);\n                        },\n                        splashColor: Colors.blueAccent.withOpacity(0.3),\n                        splashRadius: 25,\n                      ),\n                    ),\n                  ],\n                ),\n              ),\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n}\n\nclass LoadingAnimation extends StatelessWidget {\n  const LoadingAnimation({super.key});\n\n  @override\n  Widget build(BuildContext context) {\n    return const SizedBox(\n      width: 20,\n      height: 20,\n      child: CircularProgressIndicator(\n        strokeWidth: 2.0,\n      ),\n    );\n  }\n}",
          "_encoding": "utf-8"
        },
        "edit_task_page.dart": {
          "_text": "// lib/user/home/edit_task_page.dart\n// lib/user/home/edit_task_page.dart\nimport 'package:flutter/material.dart';\nimport 'package:intl/intl.dart';\n\nclass EditTaskPage extends StatefulWidget {\n  final String taskName;\n  final String description;\n  final DateTime? dueDate;\n  final DateTime? reminderTime;\n  final bool isTemplate;\n  final Map<String, dynamic>? dailyDueTime;\n  final Map<String, dynamic>? dailyReminderTime;\n\n  const EditTaskPage({\n    super.key,\n    required this.taskName,\n    required this.description,\n    this.dueDate,\n    this.reminderTime,\n    this.isTemplate = false,\n    this.dailyDueTime,\n    this.dailyReminderTime,\n  });\n\n  @override\n  State<EditTaskPage> createState() => _EditTaskPageState();\n}\n\nclass _EditTaskPageState extends State<EditTaskPage> {\n  late TextEditingController _taskController;\n  late TextEditingController _descController;\n  DateTime? _dueDate;\n  DateTime? _reminderTime;\n  TimeOfDay? _dailyDueTime;\n  TimeOfDay? _dailyReminderTime;\n\n  @override\n  void initState() {\n    super.initState();\n    _taskController = TextEditingController(text: widget.taskName);\n    _descController = TextEditingController(text: widget.description);\n    _dueDate = widget.dueDate;\n    _reminderTime = widget.reminderTime;\n    if (widget.dailyDueTime != null) {\n      _dailyDueTime = TimeOfDay(hour: widget.dailyDueTime!['hour'], minute: widget.dailyDueTime!['min']);\n    }\n    if (widget.dailyReminderTime != null) {\n      _dailyReminderTime = TimeOfDay(hour: widget.dailyReminderTime!['hour'], minute: widget.dailyReminderTime!['min']);\n    }\n  }\n\n  Future<void> _pickDueDate() async {\n    final picked = await showDatePicker(\n      context: context,\n      initialDate: _dueDate ?? DateTime.now(),\n      firstDate: DateTime.now(),\n      lastDate: DateTime(2100),\n    );\n    if (picked != null && mounted) {\n      final time = await showTimePicker(\n        context: context,\n        initialTime: _dueDate != null ? TimeOfDay.fromDateTime(_dueDate!) : TimeOfDay.now(),\n      );\n      if (time != null && mounted) {\n        setState(() {\n          _dueDate = DateTime(\n            picked.year,\n            picked.month,\n            picked.day,\n            time.hour,\n            time.minute,\n          );\n        });\n      }\n    }\n  }\n\n  Future<void> _pickReminderTime() async {\n    final pickedDate = await showDatePicker(\n      context: context,\n      initialDate: _reminderTime ?? DateTime.now(),\n      firstDate: DateTime.now(),\n      lastDate: DateTime(2100),\n    );\n    if (pickedDate != null && mounted) {\n      final pickedTime = await showTimePicker(\n        context: context,\n        initialTime: _reminderTime != null ? TimeOfDay.fromDateTime(_reminderTime!) : TimeOfDay.now(),\n      );\n      if (pickedTime != null && mounted) {\n        setState(() {\n          _reminderTime = DateTime(\n            pickedDate.year,\n            pickedDate.month,\n            pickedDate.day,\n            pickedTime.hour,\n            pickedTime.minute,\n          );\n        });\n      }\n    }\n  }\n\n  Future<void> _pickDailyDueTime() async {\n    final picked = await showTimePicker(\n      context: context,\n      initialTime: _dailyDueTime ?? TimeOfDay.now(),\n    );\n    if (picked != null && mounted) setState(() => _dailyDueTime = picked);\n  }\n\n  Future<void> _pickDailyReminderTime() async {\n    final picked = await showTimePicker(\n      context: context,\n      initialTime: _dailyReminderTime ?? TimeOfDay.now(),\n    );\n    if (picked != null && mounted) setState(() => _dailyReminderTime = picked);\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final isTemplate = widget.isTemplate;\n    return Scaffold(\n      appBar: AppBar(\n        title: Text(isTemplate ? 'Edit Template' : 'Edit Task'),\n        backgroundColor: Colors.blueAccent,\n        elevation: 0,\n      ),\n      body: Container(\n        decoration: BoxDecoration(\n          gradient: LinearGradient(\n            begin: Alignment.topCenter,\n            end: Alignment.bottomCenter,\n            colors: [Colors.blueAccent.withOpacity(0.1), Colors.white],\n          ),\n        ),\n        child: SingleChildScrollView(\n          padding: const EdgeInsets.all(24.0),\n          child: Column(\n            crossAxisAlignment: CrossAxisAlignment.start,\n            children: [\n              const Text(\n                'Edit Task Details',\n                style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold, color: Colors.blueAccent),\n              ),\n              const SizedBox(height: 24),\n              TextField(\n                controller: _taskController,\n                decoration: InputDecoration(\n                  labelText: 'Task Name',\n                  border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),\n                  filled: true,\n                  fillColor: Colors.white,\n                  prefixIcon: const Icon(Icons.task),\n                ),\n              ),\n              const SizedBox(height: 16),\n              TextField(\n                controller: _descController,\n                decoration: InputDecoration(\n                  labelText: 'Description (optional)',\n                  border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),\n                  filled: true,\n                  fillColor: Colors.white,\n                  prefixIcon: const Icon(Icons.description),\n                ),\n                maxLines: 3,\n              ),\n              const SizedBox(height: 24),\n              if (!isTemplate)\n                Card(\n                  elevation: 2,\n                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                  child: ListTile(\n                    title: Text(_dueDate == null ? 'Set Due Date & Time' : DateFormat('MMM dd, yyyy hh:mm a').format(_dueDate!)),\n                    trailing: const Icon(Icons.calendar_today, color: Colors.blueAccent),\n                    onTap: _pickDueDate,\n                  ),\n                ),\n              if (!isTemplate) const SizedBox(height: 8),\n              if (!isTemplate)\n                Card(\n                  elevation: 2,\n                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                  child: ListTile(\n                    title: Text(_reminderTime == null ? 'Set Reminder (optional)' : DateFormat('MMM dd, yyyy hh:mm a').format(_reminderTime!)),\n                    trailing: const Icon(Icons.alarm, color: Colors.orange),\n                    onTap: _pickReminderTime,\n                  ),\n                ),\n              if (isTemplate)\n                Card(\n                  elevation: 2,\n                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                  child: ListTile(\n                    title: Text(_dailyDueTime == null ? 'Set Daily Due Time' : _dailyDueTime!.format(context)),\n                    trailing: const Icon(Icons.access_time, color: Colors.blueAccent),\n                    onTap: _pickDailyDueTime,\n                  ),\n                ),\n              if (isTemplate) const SizedBox(height: 8),\n              if (isTemplate)\n                Card(\n                  elevation: 2,\n                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                  child: ListTile(\n                    title: Text(_dailyReminderTime == null ? 'Set Daily Reminder (optional)' : _dailyReminderTime!.format(context)),\n                    trailing: const Icon(Icons.alarm, color: Colors.orange),\n                    onTap: _pickDailyReminderTime,\n                  ),\n                ),\n              const SizedBox(height: 32),\n              ElevatedButton(\n                onPressed: () {\n                  if (_taskController.text.trim().isEmpty) {\n                    ScaffoldMessenger.of(context).showSnackBar(\n                      const SnackBar(content: Text('Task name cannot be empty')),\n                    );\n                    return;\n                  }\n                  if (isTemplate && _dailyDueTime == null) {\n                    ScaffoldMessenger.of(context).showSnackBar(\n                      const SnackBar(content: Text('Daily due time required')),\n                    );\n                    return;\n                  }\n                  final map = <String, dynamic>{\n                    'task': _taskController.text.trim(),\n                    'description': _descController.text.trim(),\n                  };\n                  if (isTemplate) {\n                    map['dailyDueTime'] = _dailyDueTime != null \n                      ? {'hour': _dailyDueTime!.hour, 'min': _dailyDueTime!.minute} \n                      : null;\n                    map['dailyReminderTime'] = _dailyReminderTime != null \n                      ? {'hour': _dailyReminderTime!.hour, 'min': _dailyReminderTime!.minute} \n                      : null;\n                  } else {\n                    map['dueDate'] = _dueDate;\n                    map['reminderTime'] = _reminderTime;\n                  }\n                  Navigator.pop(context, map);\n                },\n                style: ElevatedButton.styleFrom(\n                  backgroundColor: Colors.blueAccent,\n                  padding: const EdgeInsets.symmetric(vertical: 16),\n                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                  minimumSize: const Size(double.infinity, 50),\n                ),\n                child: const Text('Save Changes', style: TextStyle(fontSize: 18, color: Colors.white)),\n              ),\n            ],\n          ),\n        ),\n      ),\n    );\n  }\n\n  @override\n  void dispose() {\n    _taskController.dispose();\n    _descController.dispose();\n    super.dispose();\n  }\n}",
          "_encoding": "utf-8"
        },
        "home_screen.dart": {
          "_text": "// lib/user/home/home_screen.dart\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/material.dart';\nimport 'package:intl/intl.dart';\nimport 'package:logger/logger.dart';\nimport 'package:shared_preferences/shared_preferences.dart';\nimport '../notifications/notifications_screen.dart';\nimport '../../utils/notification_helper.dart';\nimport 'add_task_page.dart';\nimport 'ai_chat_page.dart';\nimport 'edit_task_page.dart';\n\nfinal logger = Logger();\n\nclass HomeScreen extends StatefulWidget {\n  const HomeScreen({super.key});\n\n  @override\n  State<HomeScreen> createState() => _HomeScreenState();\n}\n\nclass _HomeScreenState extends State<HomeScreen> {\n  final _auth = FirebaseAuth.instance;\n  final _firestore = FirebaseFirestore.instance;\n  String _selectedTab = 'Today';\n\n  @override\n  void initState() {\n    super.initState();\n    _checkBanned();\n    _generateDailyTasks();\n  }\n\n  Future<void> _checkBanned() async {\n    final uid = _auth.currentUser?.uid;\n    if (uid == null || !mounted) return;\n    try {\n      final doc = await _firestore.collection('user').doc(uid).get();\n      if (doc.data()?['isBanned'] == true) {\n        await _auth.signOut();\n        if (mounted) {\n          Navigator.pushReplacementNamed(context, '/welcome');\n        }\n      }\n    } catch (e) {\n      logger.e('Error checking banned status: $e');\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Error checking user status: $e')),\n        );\n      }\n    }\n  }\n\n  Future<void> _generateDailyTasks() async {\n    final uid = _auth.currentUser?.uid;\n    if (uid == null || !mounted) return;\n\n    final prefs = await SharedPreferences.getInstance();\n    final todayStr = DateFormat('yyyy-MM-dd').format(DateTime.now());\n    final lastGenerate = prefs.getString('last_generate_date');\n    if (lastGenerate == todayStr) return;\n\n    try {\n      final recurringSnap = await _firestore\n          .collection('user')\n          .doc(uid)\n          .collection('recurring_tasks')\n          .get();\n      for (var rec in recurringSnap.docs) {\n        final data = rec.data();\n        final dailyDue = data['dailyDueTime'];\n        if (dailyDue == null) continue;\n\n        final today = DateTime.now();\n        final dueDate = DateTime(\n            today.year, today.month, today.day, dailyDue['hour'], dailyDue['min']);\n        final dueTs = Timestamp.fromDate(dueDate);\n\n        final reminder = data['dailyReminderTime'];\n        Timestamp? reminderTs;\n        if (reminder != null) {\n          final remDate = DateTime(today.year, today.month, today.day,\n              reminder['hour'], reminder['min']);\n          reminderTs = Timestamp.fromDate(remDate);\n        }\n\n        final existing = await _firestore\n            .collection('user')\n            .doc(uid)\n            .collection('to_dos')\n            .where('recurringId', isEqualTo: rec.id)\n            .where('dueDate', isEqualTo: dueTs)\n            .get();\n\n        if (existing.docs.isEmpty) {\n          await _firestore.collection('user').doc(uid).collection('to_dos').add({\n            'task': data['task'],\n            'description': data['description'],\n            'completed': false,\n            'createdAt': Timestamp.now(),\n            'dueDate': dueTs,\n            'reminderTime': reminderTs,\n            'recurringId': rec.id,\n            'createdBy': 'system',\n          });\n\n          if (reminderTs != null && reminderTs.toDate().isAfter(DateTime.now())) {\n            final userPlayerIds = await _getUserPlayerIds();\n            final caretakerPlayerIds = await _getCaretakerPlayerIds();\n            final all = [...userPlayerIds, ...caretakerPlayerIds];\n            await scheduleNotification(\n                all, 'Daily Task Reminder: ${data['task']}', reminderTs.toDate());\n          }\n        }\n      }\n      await prefs.setString('last_generate_date', todayStr);\n    } catch (e) {\n      logger.e('Error generating daily tasks: $e');\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Error generating tasks: $e')),\n        );\n      }\n    }\n  }\n\n  Stream<QuerySnapshot<Map<String, dynamic>>> _getTasksStream() {\n    final uid = _auth.currentUser?.uid;\n    if (uid == null) return Stream.empty();\n\n    final coll = _firestore.collection('user').doc(uid).collection('to_dos');\n\n    final todayStart = Timestamp.fromDate(\n        DateTime.now().subtract(const Duration(days: 1)).add(const Duration(hours: 24)));\n    final todayEnd = Timestamp.fromDate(DateTime.now().add(const Duration(days: 1)));\n\n    if (_selectedTab == 'Recurring') {\n      return _firestore\n          .collection('user')\n          .doc(uid)\n          .collection('recurring_tasks')\n          .orderBy('createdAt', descending: true)\n          .snapshots();\n    } else if (_selectedTab == 'Today') {\n      return coll\n          .where('dueDate', isGreaterThanOrEqualTo: todayStart)\n          .where('dueDate', isLessThan: todayEnd)\n          .orderBy('dueDate')\n          .limit(50)\n          .snapshots();\n    } else if (_selectedTab == 'Upcoming') {\n      return coll\n          .where('dueDate', isGreaterThanOrEqualTo: todayEnd)\n          .orderBy('dueDate')\n          .limit(50)\n          .snapshots();\n    } else if (_selectedTab == 'Completed') {\n      return coll.where('completed', isEqualTo: true).snapshots();\n    } else if (_selectedTab == 'All') {\n      return coll.orderBy('dueDate', descending: true).limit(50).snapshots();\n    } else {\n      return Stream.empty();\n    }\n  }\n\n  Future<int> _getRemainingToday() async {\n    final uid = _auth.currentUser?.uid;\n    if (uid == null) return 0;\n\n    final coll = _firestore.collection('user').doc(uid).collection('to_dos');\n    final todayStart = Timestamp.fromDate(\n        DateTime.now().subtract(const Duration(days: 1)).add(const Duration(hours: 24)));\n    final todayEnd = Timestamp.fromDate(DateTime.now().add(const Duration(days: 1)));\n\n    try {\n      // Workaround: Simplified query to avoid composite index requirement\n      final snap = await coll\n          .where('dueDate', isGreaterThanOrEqualTo: todayStart)\n          .where('dueDate', isLessThan: todayEnd)\n          .get();\n      // Filter completed tasks in code\n      final incompleteTasks = snap.docs\n          .where((doc) => doc.data()['completed'] == false)\n          .length;\n      return incompleteTasks;\n    } catch (e) {\n      logger.e('Error getting remaining today: $e');\n      if (e.toString().contains('requires an index') && mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(\n            content: const Text(\n              'Database setup in progress. Please try again in a few minutes or contact support.',\n            ),\n            duration: const Duration(seconds: 5),\n            action: SnackBarAction(\n              label: 'Retry',\n              onPressed: () {\n                if (mounted) setState(() {});\n              },\n            ),\n          ),\n        );\n      } else if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Error fetching tasks: $e')),\n        );\n      }\n      return 0;\n    }\n  }\n\n  Future<void> _deleteTask(String id, bool isTemplate) async {\n    final uid = _auth.currentUser?.uid;\n    if (uid == null || !mounted) return;\n    final confirm = await showDialog<bool>(\n      context: context,\n      builder: (_) => AlertDialog(\n        title: const Text('Delete Task'),\n        content: const Text('Are you sure you want to delete this task?'),\n        actions: [\n          TextButton(\n            onPressed: () => Navigator.pop(context, false),\n            child: const Text('Cancel'),\n          ),\n          ElevatedButton(\n            style: ElevatedButton.styleFrom(backgroundColor: Colors.red),\n            onPressed: () => Navigator.pop(context, true),\n            child: const Text('Delete'),\n          ),\n        ],\n      ),\n    );\n    if (confirm == true && mounted) {\n      try {\n        final coll = isTemplate ? 'recurring_tasks' : 'to_dos';\n        await _firestore\n            .collection('user')\n            .doc(uid)\n            .collection(coll)\n            .doc(id)\n            .delete();\n      } catch (e) {\n        if (mounted) {\n          ScaffoldMessenger.of(context)\n              .showSnackBar(SnackBar(content: Text('Error deleting: $e')));\n        }\n      }\n    }\n  }\n\n  Future<void> _toggleTaskStatus(String id, bool current) async {\n    final uid = _auth.currentUser?.uid;\n    if (uid == null || !mounted) return;\n    try {\n      await _firestore\n          .collection('user')\n          .doc(uid)\n          .collection('to_dos')\n          .doc(id)\n          .update({'completed': !current});\n    } catch (e) {\n      if (mounted) {\n        ScaffoldMessenger.of(context)\n            .showSnackBar(SnackBar(content: Text('Error updating task: $e')));\n      }\n    }\n  }\n\n  Future<List<String>> _getCaretakerPlayerIds() async {\n    final uid = _auth.currentUser?.uid;\n    if (uid == null) return [];\n\n    final userDoc = await _firestore.collection('user').doc(uid).get();\n    final connectionId = userDoc.data()?['currentConnectionId'];\n    if (connectionId == null) return [];\n\n    final connectionDoc =\n        await _firestore.collection('connections').doc(connectionId).get();\n    final caretakerUid = connectionDoc.data()?['caretaker_uid'];\n    if (caretakerUid == null) return [];\n\n    final caretakerDoc =\n        await _firestore.collection('caretaker').doc(caretakerUid).get();\n    return List<String>.from(caretakerDoc.data()?['playerIds'] ?? []);\n  }\n\n  Future<List<String>> _getUserPlayerIds() async {\n    final uid = _auth.currentUser?.uid;\n    if (uid == null) return [];\n    final userDoc = await _firestore.collection('user').doc(uid).get();\n    return List<String>.from(userDoc.data()?['playerIds'] ?? []);\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      body: Column(\n        children: [\n          Container(\n            decoration: const BoxDecoration(\n              gradient: LinearGradient(\n                colors: [Colors.blueAccent, Colors.blue],\n                begin: Alignment.topLeft,\n                end: Alignment.bottomRight,\n              ),\n              borderRadius: BorderRadius.vertical(bottom: Radius.circular(20)),\n            ),\n            padding: EdgeInsets.only(\n              top: MediaQuery.of(context).padding.top + 16,\n              bottom: 16,\n              left: 16,\n              right: 16,\n            ),\n            child: Row(\n              mainAxisAlignment: MainAxisAlignment.spaceBetween,\n              children: [\n                const Text(\n                  'Dementia Tasks',\n                  style: TextStyle(\n                    fontSize: 24,\n                    fontWeight: FontWeight.bold,\n                    color: Colors.white,\n                  ),\n                ),\n                IconButton(\n                  icon: const Icon(Icons.notifications, color: Colors.white),\n                  onPressed: () {\n                    if (mounted) {\n                      Navigator.push(\n                        context,\n                        MaterialPageRoute(\n                          builder: (_) => const NotificationsScreen(),\n                        ),\n                      );\n                    }\n                  },\n                ),\n              ],\n            ),\n          ),\n          FutureBuilder<int>(\n            future: _getRemainingToday(),\n            builder: (context, snap) {\n              return Card(\n                margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),\n                elevation: 4,\n                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),\n                child: Container(\n                  decoration: BoxDecoration(\n                    gradient: const LinearGradient(\n                      colors: [Colors.greenAccent, Colors.green],\n                      begin: Alignment.topLeft,\n                      end: Alignment.bottomRight,\n                    ),\n                    borderRadius: BorderRadius.circular(16),\n                  ),\n                  padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 12),\n                  child: Row(\n                    mainAxisAlignment: MainAxisAlignment.center,\n                    children: [\n                      Text(\n                        snap.connectionState == ConnectionState.waiting\n                            ? '0'\n                            : (snap.data ?? 0).toString().padLeft(3, '0'),\n                        style: const TextStyle(\n                          fontSize: 36,\n                          fontWeight: FontWeight.bold,\n                          color: Colors.white,\n                        ),\n                      ),\n                      const SizedBox(width: 8),\n                      const Text(\n                        'Remaining Today',\n                        style: TextStyle(\n                          fontSize: 16,\n                          color: Colors.white,\n                        ),\n                      ),\n                    ],\n                  ),\n                ),\n              );\n            },\n          ),\n          SingleChildScrollView(\n            scrollDirection: Axis.horizontal,\n            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),\n            child: Row(\n              children: [\n                _filterChip('Today'),\n                const SizedBox(width: 8),\n                _filterChip('Upcoming'),\n                const SizedBox(width: 8),\n                _filterChip('Completed'),\n                const SizedBox(width: 8),\n                _filterChip('All'),\n                const SizedBox(width: 8),\n                _filterChip('Recurring'),\n              ],\n            ),\n          ),\n          Expanded(\n            child: StreamBuilder<QuerySnapshot<Map<String, dynamic>>>(\n              stream: _getTasksStream(),\n              builder: (context, snapshot) {\n                if (snapshot.connectionState == ConnectionState.waiting) {\n                  return const Center(child: CircularProgressIndicator());\n                }\n\n                if (snapshot.hasError) {\n                  logger.e('Task stream error: ${snapshot.error}');\n                  return Center(\n                    child: Padding(\n                      padding: const EdgeInsets.all(24),\n                      child: Column(\n                        mainAxisAlignment: MainAxisAlignment.center,\n                        children: [\n                          const Icon(Icons.error, size: 64, color: Colors.red),\n                          const SizedBox(height: 16),\n                          Text(\n                            snapshot.error.toString().contains('requires an index')\n                                ? 'Database setup in progress. Please try again in a few minutes or contact support.'\n                                : 'Failed to load tasks: ${snapshot.error}',\n                            textAlign: TextAlign.center,\n                            style: const TextStyle(fontSize: 16),\n                          ),\n                          const SizedBox(height: 16),\n                          ElevatedButton.icon(\n                            icon: const Icon(Icons.refresh),\n                            label: const Text('Retry'),\n                            onPressed: () {\n                              if (mounted) setState(() {});\n                            },\n                          ),\n                        ],\n                      ),\n                    ),\n                  );\n                }\n\n                var docs = snapshot.data?.docs ?? [];\n                if (_selectedTab == 'Completed') {\n                  docs.sort((a, b) {\n                    final aDate = (a.data()['dueDate'] as Timestamp?) ?? Timestamp(0, 0);\n                    final bDate = (b.data()['dueDate'] as Timestamp?) ?? Timestamp(0, 0);\n                    int cmp = bDate.compareTo(aDate);\n                    if (cmp == 0) {\n                      return b.id.compareTo(a.id);\n                    }\n                    return cmp;\n                  });\n                  docs = docs.take(50).toList();\n                }\n\n                if (docs.isEmpty) {\n                  return _emptyState();\n                }\n\n                return RefreshIndicator(\n                  onRefresh: () async {\n                    if (mounted) setState(() {});\n                  },\n                  child: ListView.builder(\n                    padding: const EdgeInsets.all(16),\n                    itemCount: docs.length,\n                    itemBuilder: (context, index) {\n                      final doc = docs[index];\n                      final task = doc.data();\n                      final id = doc.id;\n                      final isTemplate = _selectedTab == 'Recurring';\n                      final completed = isTemplate ? false : (task['completed'] as bool? ?? false);\n                      final description = task['description'] as String? ?? '';\n                      final dueDate = task['dueDate'] as Timestamp?;\n                      final reminderTime = task['reminderTime'] as Timestamp?;\n                      final Map<String, dynamic>? dailyDueTime = isTemplate ? task['dailyDueTime'] as Map<String, dynamic>? : null;\n                      final Map<String, dynamic>? dailyReminderTime = isTemplate ? task['dailyReminderTime'] as Map<String, dynamic>? : null;\n\n                      return Card(\n                        elevation: 4,\n                        margin: const EdgeInsets.only(bottom: 16),\n                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),\n                        color: completed ? Colors.grey[200] : Colors.white,\n                        child: ListTile(\n                          contentPadding: const EdgeInsets.all(16),\n                          leading: isTemplate\n                              ? const Icon(Icons.repeat, color: Colors.blue, size: 32)\n                              : Icon(\n                                  completed\n                                      ? Icons.check_circle\n                                      : Icons.radio_button_unchecked,\n                                  color: completed ? Colors.green : Colors.red,\n                                  size: 32,\n                                ),\n                          title: Text(\n                            task['task'] as String? ?? 'Untitled',\n                            style: TextStyle(\n                              fontSize: 18,\n                              fontWeight: FontWeight.bold,\n                              decoration:\n                                  completed ? TextDecoration.lineThrough : null,\n                            ),\n                          ),\n                          subtitle: Column(\n                            crossAxisAlignment: CrossAxisAlignment.start,\n                            children: [\n                              if (description.isNotEmpty)\n                                Padding(\n                                  padding: const EdgeInsets.only(top: 4),\n                                  child: Text(\n                                    description,\n                                    style: const TextStyle(color: Colors.black54),\n                                  ),\n                                ),\n                              if (!isTemplate && dueDate != null)\n                                Padding(\n                                  padding: const EdgeInsets.only(top: 4),\n                                  child: Text(\n                                    'Due: ${DateFormat('MMM dd, yyyy hh:mm a').format(dueDate.toDate())}',\n                                    style: const TextStyle(color: Colors.blueGrey),\n                                  ),\n                                ),\n                              if (!isTemplate && reminderTime != null)\n                                Padding(\n                                  padding: const EdgeInsets.only(top: 4),\n                                  child: Text(\n                                    'Reminder: ${DateFormat('MMM dd, yyyy hh:mm a').format(reminderTime.toDate())}',\n                                    style: const TextStyle(color: Colors.orange),\n                                  ),\n                                ),\n                              if (isTemplate && dailyDueTime != null)\n                                Padding(\n                                  padding: const EdgeInsets.only(top: 4),\n                                  child: Text(\n                                    'Daily Due: ${dailyDueTime['hour'].toString().padLeft(2, '0')}:${dailyDueTime['min'].toString().padLeft(2, '0')}',\n                                    style: const TextStyle(color: Colors.blueGrey),\n                                  ),\n                                ),\n                              if (isTemplate && dailyReminderTime != null)\n                                Padding(\n                                  padding: const EdgeInsets.only(top: 4),\n                                  child: Text(\n                                    'Daily Reminder: ${dailyReminderTime['hour'].toString().padLeft(2, '0')}:${dailyReminderTime['min'].toString().padLeft(2, '0')}',\n                                    style: const TextStyle(color: Colors.orange),\n                                  ),\n                                ),\n                            ],\n                          ),\n                          trailing: Row(\n                            mainAxisSize: MainAxisSize.min,\n                            children: [\n                              IconButton(\n                                icon: const Icon(Icons.edit, color: Colors.blue),\n                                onPressed: () async {\n                                  if (!mounted) return;\n                                  final Map<String, dynamic>? updated = await Navigator.push<Map<String, dynamic>>(\n                                    context,\n                                    MaterialPageRoute(\n                                      builder: (_) => EditTaskPage(\n                                        taskName: task['task'] as String? ?? '',\n                                        description: description,\n                                        dueDate: dueDate?.toDate(),\n                                        reminderTime: reminderTime?.toDate(),\n                                        isTemplate: isTemplate,\n                                        dailyDueTime: dailyDueTime,\n                                        dailyReminderTime: dailyReminderTime,\n                                      ),\n                                    ),\n                                  );\n                                  if (updated != null && mounted) {\n                                    final uid = _auth.currentUser?.uid;\n                                    if (uid != null) {\n                                      try {\n                                        final coll = isTemplate ? 'recurring_tasks' : 'to_dos';\n                                        await _firestore\n                                            .collection('user')\n                                            .doc(uid)\n                                            .collection(coll)\n                                            .doc(id)\n                                            .update({\n                                              'task': updated['task'],\n                                              'description': updated['description'],\n                                              if (isTemplate)\n                                                'dailyDueTime': updated['dailyDueTime'],\n                                              if (isTemplate)\n                                                'dailyReminderTime': updated['dailyReminderTime'],\n                                              if (!isTemplate)\n                                                'dueDate': updated['dueDate'] != null\n                                                    ? Timestamp.fromDate(updated['dueDate'] as DateTime)\n                                                    : null,\n                                              if (!isTemplate)\n                                                'reminderTime': updated['reminderTime'] != null\n                                                    ? Timestamp.fromDate(updated['reminderTime'] as DateTime)\n                                                    : null,\n                                            });\n\n                                        if (!isTemplate && updated['reminderTime'] != null) {\n                                          final userPlayerIds = await _getUserPlayerIds();\n                                          final caretakerPlayerIds = await _getCaretakerPlayerIds();\n                                          final allPlayerIds = [...userPlayerIds, ...caretakerPlayerIds];\n\n                                          await scheduleNotification(\n                                            allPlayerIds,\n                                            'Task Reminder: ${updated['task']}',\n                                            updated['reminderTime'] as DateTime,\n                                          );\n                                        }\n                                      } catch (e) {\n                                        if (mounted) {\n                                          ScaffoldMessenger.of(context).showSnackBar(\n                                            SnackBar(content: Text('Error updating: $e')),\n                                          );\n                                        }\n                                      }\n                                    }\n                                  }\n                                },\n                              ),\n                              IconButton(\n                                icon: const Icon(Icons.delete, color: Colors.red),\n                                onPressed: () => _deleteTask(id, isTemplate),\n                              ),\n                            ],\n                          ),\n                          onTap: isTemplate ? null : () => _toggleTaskStatus(id, completed),\n                        ),\n                      );\n                    },\n                  ),\n                );\n              },\n            ),\n          ),\n        ],\n      ),\n      floatingActionButton: Column(\n        mainAxisAlignment: MainAxisAlignment.end,\n        children: [\n          FloatingActionButton(\n            onPressed: () {\n              Navigator.push(\n                context,\n                MaterialPageRoute(builder: (context) => const AIChatPage()),\n              );\n            },\n            backgroundColor: Colors.blue, // Blue background\n            heroTag: 'ai_chat',\n            child: ClipOval(\n              child: Image.asset(\n                'assets/aiIcon.png',\n                width: 50,\n                height: 50,\n                fit: BoxFit.cover,\n              ),\n            ),\n          ),\n          const SizedBox(height: 16),\n          FloatingActionButton.extended(\n            onPressed: () async {\n              if (!mounted) return;\n              final newTask = await Navigator.push(\n                context,\n                MaterialPageRoute(builder: (_) => AddTaskPage(isTemplate: _selectedTab == 'Recurring')),\n              );\n              if (newTask != null && mounted) {\n                final uid = _auth.currentUser?.uid;\n                if (uid != null) {\n                  try {\n                    final isTemplate = newTask['recurring'] == 'Daily';\n                    final coll = isTemplate ? 'recurring_tasks' : 'to_dos';\n                    await _firestore.collection('user').doc(uid).collection(coll).add({\n                      'task': newTask['task'],\n                      'description': newTask['description'],\n                      if (!isTemplate) 'completed': false,\n                      'createdAt': Timestamp.now(),\n                      if (!isTemplate)\n                        'dueDate': newTask['dueDate'] != null\n                            ? Timestamp.fromDate(newTask['dueDate'] as DateTime)\n                            : null,\n                      if (!isTemplate)\n                        'reminderTime': newTask['reminderTime'] != null\n                            ? Timestamp.fromDate(newTask['reminderTime'] as DateTime)\n                            : null,\n                      if (isTemplate) 'dailyDueTime': newTask['dailyDueTime'],\n                      if (isTemplate) 'dailyReminderTime': newTask['dailyReminderTime'],\n                      'createdBy': 'user',\n                    });\n\n                    if (!isTemplate && newTask['reminderTime'] != null) {\n                      final userPlayerIds = await _getUserPlayerIds();\n                      final caretakerPlayerIds = await _getCaretakerPlayerIds();\n                      final allPlayerIds = [...userPlayerIds, ...caretakerPlayerIds];\n\n                      await scheduleNotification(\n                        allPlayerIds,\n                        'New Task Reminder: ${newTask['task']}',\n                        newTask['reminderTime'] as DateTime,\n                      );\n                    }\n\n                    if (isTemplate) {\n                      await _generateDailyTasks();\n                    }\n                  } catch (e) {\n                    if (mounted) {\n                      ScaffoldMessenger.of(context).showSnackBar(\n                        SnackBar(content: Text('Error adding: $e')),\n                      );\n                    }\n                  }\n                }\n              }\n            },\n            backgroundColor: Colors.orange,\n            icon: const Icon(Icons.add, color: Colors.white),\n            label: const Text('Add', style: TextStyle(color: Colors.white)),\n            heroTag: 'add_task',\n          ),\n        ],\n      ),\n    );\n  }\n\n  Widget _filterChip(String label) {\n    return ChoiceChip(\n      label: Text(label, style: const TextStyle(fontSize: 14)),\n      selected: _selectedTab == label,\n      onSelected: (selected) {\n        if (selected && mounted) {\n          setState(() => _selectedTab = label);\n        }\n      },\n      selectedColor: Colors.blueAccent,\n      backgroundColor: Colors.grey[300],\n      labelStyle: TextStyle(\n          color: _selectedTab == label ? Colors.white : Colors.black),\n    );\n  }\n\n  Widget _emptyState() {\n    return const Center(\n      child: Column(\n        mainAxisAlignment: MainAxisAlignment.center,\n        children: [\n          Icon(Icons.inbox, size: 64, color: Colors.grey),\n          SizedBox(height: 16),\n          Text(\n            'No items yet. Add one!',\n            style: TextStyle(fontSize: 18, color: Colors.grey),\n          ),\n        ],\n      ),\n    );\n  }\n}",
          "_encoding": "utf-8"
        }
      },
      "notifications": {
        "notifications_screen.dart": {
          "_text": "// lib/user/notifications/notifications_screen.dart\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/material.dart';\nimport 'package:intl/intl.dart';\nimport 'package:url_launcher/url_launcher.dart';\n\nclass NotificationsScreen extends StatefulWidget {\n  const NotificationsScreen({super.key});\n\n  @override\n  State<NotificationsScreen> createState() => _NotificationsScreenState();\n}\n\nclass _NotificationsScreenState extends State<NotificationsScreen> {\n  final _auth = FirebaseAuth.instance;\n  final _firestore = FirebaseFirestore.instance;\n\n  Stream<QuerySnapshot> _getNotifications() {\n    final uid = _auth.currentUser?.uid;\n    if (uid == null) return Stream.empty();\n    return _firestore.collection('user').doc(uid).collection('notifications').orderBy('createdAt', descending: true).snapshots();\n  }\n\n  Future<void> _markRead(String id) async {\n    final uid = _auth.currentUser?.uid;\n    if (uid != null) {\n      await _firestore.collection('user').doc(uid).collection('notifications').doc(id).update({'isRead': true});\n    }\n  }\n\n  Future<String> _fetchCaretakerName(String caretakerUid) async {\n    try {\n      final doc = await _firestore.collection('caretaker').doc(caretakerUid).get();\n      return doc.data()?['fullName'] as String? ?? 'Caretaker Not Found';\n    } catch (e) {\n      return 'Error fetching name';\n    }\n  }\n\n  Future<void> _handleCall(String caretakerUid) async {\n    try {\n      final caretakerDoc = await _firestore.collection('caretaker').doc(caretakerUid).get();\n      final phone = caretakerDoc.data()?['phoneNo'] as String?;\n\n      if (phone != null && phone.isNotEmpty) {\n        final url = Uri.parse('tel:$phone');\n        if (await canLaunchUrl(url)) {\n          await launchUrl(url);\n        } else {\n          if (mounted) {\n            ScaffoldMessenger.of(context).showSnackBar(\n              const SnackBar(content: Text('Could not launch phone app.')),\n            );\n          }\n        }\n      } else {\n        if (mounted) {\n          ScaffoldMessenger.of(context).showSnackBar(\n            const SnackBar(content: Text('Caretaker phone number not available.')),\n          );\n        }\n      }\n    } catch (e) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Error getting phone number: $e')),\n        );\n      }\n    }\n  }\n\n  Future<void> _handleUnbindAccept(String notificationId, String caretakerUid, String connectionId) async {\n    final userUid = _auth.currentUser?.uid;\n    if (userUid == null) return;\n\n    try {\n      await _firestore.collection('connections').doc(connectionId).update({\n        'status': 'unbound',\n      });\n\n      // Update both profiles\n      await _firestore.collection('user').doc(userUid).update({\n        'isConnected': false,\n        'currentConnectionId': null,\n      });\n\n      await _firestore.collection('caretaker').doc(caretakerUid).update({\n        'isConnected': false,\n        'currentConnectionId': null,\n      });\n\n      // Delete the notification\n      await _firestore\n          .collection('user')\n          .doc(userUid)\n          .collection('notifications')\n          .doc(notificationId)\n          .delete();\n\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Connection unbound successfully')),\n        );\n      }\n    } catch (e) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Failed to unbind connection: $e')),\n        );\n      }\n    }\n  }\n\n  Future<void> _handleUnbindDecline(String notificationId, String connectionId) async {\n    final userUid = _auth.currentUser?.uid;\n    if (userUid == null) return;\n\n    try {\n      // Revert unbind request\n      await _firestore.collection('connections').doc(connectionId).update({\n        'status': 'accepted',\n        'requestedBy': null,\n      });\n\n      // Delete the notification\n      await _firestore\n          .collection('user')\n          .doc(userUid)\n          .collection('notifications')\n          .doc(notificationId)\n          .delete();\n\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Unbind request declined')),\n        );\n      }\n    } catch (e) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Failed to decline unbind: $e')),\n        );\n      }\n    }\n  }\n\n  Widget _buildNotificationCard(DocumentSnapshot doc) {\n    final data = doc.data() as Map<String, dynamic>;\n    final type = data['type'] as String? ?? 'general';\n    final isRead = data['isRead'] as bool? ?? false;\n    final senderUid = data['from'] as String?;\n    final notificationMessage = data['message'] as String? ?? 'No message.';\n    final connectionId = data['connectionId'] as String?;\n\n    TextStyle textStyle = const TextStyle(fontWeight: FontWeight.normal);\n    Color cardColor = Colors.white;\n    IconData icon = Icons.info;\n\n    if (type == 'unbind_request') {\n      textStyle = const TextStyle(\n        fontWeight: FontWeight.bold,\n        color: Colors.orange,\n      );\n      cardColor = Colors.orange.shade50;\n      icon = Icons.link_off;\n    } else if (!isRead) {\n      cardColor = Colors.yellow.shade100;\n    }\n\n    return Card(\n      elevation: 3,\n      margin: const EdgeInsets.symmetric(vertical: 8, horizontal: 16),\n      color: cardColor,\n      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n      child: Padding(\n        padding: const EdgeInsets.all(12.0),\n        child: Column(\n          crossAxisAlignment: CrossAxisAlignment.start,\n          children: [\n            ListTile(\n              leading: Icon(icon, color: Colors.blueAccent),\n              title: (type == 'unbind_request' && senderUid != null)\n                  ? FutureBuilder<String>(\n                      future: _fetchCaretakerName(senderUid),\n                      builder: (context, snapshot) {\n                        String caretakerName = snapshot.data ?? 'Loading Caretaker...';\n                        String displayMessage = 'Unbind request from $caretakerName.';\n                        return Text(displayMessage, style: textStyle);\n                      },\n                    )\n                  : Text(notificationMessage, style: textStyle),\n              subtitle: Text(\n                'Received: ${DateFormat('MMM dd, hh:mm a').format((data['createdAt'] as Timestamp).toDate())}',\n                style: const TextStyle(fontSize: 12, color: Colors.grey),\n              ),\n              contentPadding: EdgeInsets.zero,\n              onTap: () => _markRead(doc.id),\n            ),\n\n            if (type == 'unbind_request' && senderUid != null && connectionId != null)\n              Padding(\n                padding: const EdgeInsets.only(top: 8.0),\n                child: Row(\n                  mainAxisAlignment: MainAxisAlignment.end,\n                  children: [\n                    Expanded(\n                      flex: 1,\n                      child: OutlinedButton.icon(\n                        icon: const Icon(Icons.phone, size: 18, color: Colors.green),\n                        label: const Text('Call', style: TextStyle(fontSize: 13, color: Colors.green)),\n                        onPressed: () => _handleCall(senderUid),\n                        style: OutlinedButton.styleFrom(\n                          padding: const EdgeInsets.symmetric(horizontal: 0),\n                          side: const BorderSide(color: Colors.green),\n                        ),\n                      ),\n                    ),\n                    const SizedBox(width: 8),\n                    Expanded(\n                      flex: 2,\n                      child: ElevatedButton.icon(\n                        icon: const Icon(Icons.check, size: 18, color: Colors.white),\n                        label: const Text('Accept', style: TextStyle(fontSize: 13, color: Colors.white)),\n                        onPressed: () => _handleUnbindAccept(doc.id, senderUid, connectionId),\n                        style: ElevatedButton.styleFrom(\n                          backgroundColor: Colors.orange,\n                          padding: const EdgeInsets.symmetric(horizontal: 0),\n                        ),\n                      ),\n                    ),\n                    const SizedBox(width: 8),\n                    Expanded(\n                      flex: 2,\n                      child: ElevatedButton.icon(\n                        icon: const Icon(Icons.close, size: 18, color: Colors.white),\n                        label: const Text('Decline', style: TextStyle(fontSize: 13, color: Colors.white)),\n                        onPressed: () => _handleUnbindDecline(doc.id, connectionId),\n                        style: ElevatedButton.styleFrom(\n                          backgroundColor: Colors.red,\n                          padding: const EdgeInsets.symmetric(horizontal: 0),\n                        ),\n                      ),\n                    ),\n                  ],\n                ),\n              ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text('Notifications'),\n        backgroundColor: Colors.blueAccent,\n        elevation: 0,\n      ),\n      body: Container(\n        decoration: BoxDecoration(\n          gradient: LinearGradient(\n            begin: Alignment.topCenter,\n            end: Alignment.bottomCenter,\n            colors: [Colors.blueAccent.withOpacity(0.1), Colors.white],\n          ),\n        ),\n        child: StreamBuilder<QuerySnapshot>(\n          stream: _getNotifications(),\n          builder: (context, snapshot) {\n            if (snapshot.hasError) {\n              return Center(\n                child: Text('Error: ${snapshot.error}', style: const TextStyle(color: Colors.red)),\n              );\n            }\n            if (!snapshot.hasData) {\n              return const Center(child: CircularProgressIndicator(color: Colors.blueAccent));\n            }\n            final notifs = snapshot.data!.docs;\n            if (notifs.isEmpty) {\n              return const Center(\n                child: Column(\n                  mainAxisAlignment: MainAxisAlignment.center,\n                  children: [\n                    Icon(Icons.notifications_off, size: 64, color: Colors.grey),\n                    SizedBox(height: 16),\n                    Text(\n                      'No notifications yet',\n                      style: TextStyle(fontSize: 18, color: Colors.grey),\n                    ),\n                  ],\n                ),\n              );\n            }\n            return ListView.builder(\n              padding: const EdgeInsets.all(16.0),\n              itemCount: notifs.length,\n              itemBuilder: (context, index) {\n                return _buildNotificationCard(notifs[index]);\n              },\n            );\n          },\n        ),\n      ),\n    );\n  }\n}",
          "_encoding": "utf-8"
        }
      },
      "profile": {
        "edit_profile_screen.dart": {
          "_text": "// lib/user/profile/edit_profile_screen.dart\nimport 'dart:io';\n\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:cloudinary_public/cloudinary_public.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/material.dart';\nimport 'package:image_picker/image_picker.dart';\nimport 'package:intl/intl.dart';\nimport 'package:permission_handler/permission_handler.dart';\n\nclass EditProfileScreen extends StatefulWidget {\n  final Map<String, dynamic> userData;\n  const EditProfileScreen({super.key, required this.userData});\n\n  @override\n  State<EditProfileScreen> createState() => _EditProfileScreenState();\n}\n\nclass _EditProfileScreenState extends State<EditProfileScreen> {\n  late TextEditingController _fullNameController;\n  late TextEditingController _usernameController;\n  late TextEditingController _bioController;\n  late TextEditingController _phoneController;\n  late TextEditingController _localityController;\n  late TextEditingController _cityController;\n  late TextEditingController _stateController;\n  DateTime? _dob;\n  String? _gender;\n  String _profileImageUrl = '';\n  File? _newProfileImage;\n  final _picker = ImagePicker();\n  final cloudinary = CloudinaryPublic('dts8hgf4f', 'user_image');\n  bool _isSaving = false;\n  List<Map<String, dynamic>> _emergencyContacts = [];\n\n  @override\n  void initState() {\n    super.initState();\n    _fullNameController = TextEditingController(text: widget.userData['fullName']);\n    _usernameController = TextEditingController(text: widget.userData['username']);\n    _bioController = TextEditingController(text: widget.userData['bio']);\n    _phoneController = TextEditingController(text: widget.userData['phoneNo']);\n    _localityController = TextEditingController(text: widget.userData['locality']);\n    _cityController = TextEditingController(text: widget.userData['city']);\n    _stateController = TextEditingController(text: widget.userData['state']);\n    _dob = widget.userData['dob']?.toDate();\n    \n    // Handle gender case conversion\n    final genderFromData = widget.userData['gender'];\n    if (genderFromData is String) {\n      _gender = genderFromData.toLowerCase();\n    } else {\n      _gender = 'male'; // default\n    }\n    \n    _profileImageUrl = widget.userData['profileImageUrl'] ?? '';\n    _emergencyContacts = List<Map<String, dynamic>>.from(widget.userData['emergencyContacts'] ?? []);\n  }\n\n  Future<void> _pickImage() async {\n    if (await Permission.photos.request().isGranted) {\n      final picked = await _picker.pickImage(source: ImageSource.gallery);\n      if (picked != null && mounted) {\n        setState(() => _newProfileImage = File(picked.path));\n      }\n    }\n  }\n\n  Future<String?> _uploadImage() async {\n    if (_newProfileImage == null) return _profileImageUrl;\n    try {\n      final response = await cloudinary.uploadFile(CloudinaryFile.fromFile(_newProfileImage!.path));\n      return response.secureUrl;\n    } catch (e) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Upload failed: $e')));\n      }\n      return _profileImageUrl;\n    }\n  }\n\n  Future<void> _saveChanges() async {\n    if (_isSaving || !mounted) return;\n    setState(() => _isSaving = true);\n    final url = await _uploadImage();\n    final uid = FirebaseAuth.instance.currentUser?.uid;\n    if (uid != null && mounted) {\n      try {\n        await FirebaseFirestore.instance.collection('user').doc(uid).update({\n          'fullName': _fullNameController.text.trim(),\n          'username': _usernameController.text.trim(),\n          'bio': _bioController.text.trim(),\n          'phoneNo': _phoneController.text.trim(),\n          'profileImageUrl': url,\n          'locality': _localityController.text.trim(),\n          'city': _cityController.text.trim(),\n          'state': _stateController.text.trim(),\n          'dob': _dob != null ? Timestamp.fromDate(_dob!) : null,\n          'gender': _gender?.toLowerCase(), // Ensure lowercase when saving\n          'emergencyContacts': _emergencyContacts,\n        });\n        if (mounted) Navigator.pop(context, true);\n      } catch (e) {\n        if (mounted) {\n          ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Save failed: $e')));\n        }\n      }\n    }\n    if (mounted) setState(() => _isSaving = false);\n  }\n\n  Future<void> _pickDob() async {\n    final DateTime? picked = await showDatePicker(\n      context: context,\n      initialDate: _dob ?? DateTime(2000),\n      firstDate: DateTime(1900),\n      lastDate: DateTime.now(),\n      builder: (context, child) {\n        return Theme(\n          data: ThemeData.light().copyWith(\n            colorScheme: const ColorScheme.light(\n              primary: Colors.blueAccent,\n              onPrimary: Colors.white,\n              onSurface: Colors.black,\n            ),\n          ),\n          child: child!,\n        );\n      },\n    );\n    if (picked != null && picked != _dob) {\n      setState(() {\n        _dob = picked;\n      });\n    }\n  }\n\n  void _addEmergencyContact() {\n    _showContactDialog();\n  }\n\n  void _editEmergencyContact(int index) {\n    _showContactDialog(index: index);\n  }\n\n  void _deleteEmergencyContact(int index) {\n    setState(() {\n      _emergencyContacts.removeAt(index);\n    });\n  }\n\n  void _showContactDialog({int? index}) {\n    final isEdit = index != null;\n    final nameController = TextEditingController(text: isEdit ? _emergencyContacts[index]['name'] : '');\n    final relationController = TextEditingController(text: isEdit ? _emergencyContacts[index]['relation'] : '');\n    final phoneController = TextEditingController(text: isEdit ? _emergencyContacts[index]['number'] : '');\n\n    showDialog(\n      context: context,\n      builder: (context) {\n        return AlertDialog(\n          title: Text(isEdit ? 'Edit Contact' : 'Add Contact'),\n          content: SingleChildScrollView(\n            child: Column(\n              mainAxisSize: MainAxisSize.min,\n              children: [\n                TextField(controller: nameController, decoration: const InputDecoration(labelText: 'Name')),\n                TextField(controller: relationController, decoration: const InputDecoration(labelText: 'Relation')),\n                TextField(controller: phoneController, decoration: const InputDecoration(labelText: 'Phone')),\n              ],\n            ),\n          ),\n          actions: [\n            TextButton(\n              onPressed: () => Navigator.pop(context),\n              child: const Text('Cancel'),\n            ),\n            ElevatedButton(\n              onPressed: () {\n                final name = nameController.text.trim();\n                final relation = relationController.text.trim();\n                final phone = phoneController.text.trim();\n                if (name.isNotEmpty && relation.isNotEmpty && phone.isNotEmpty) {\n                  final contact = {'name': name, 'relation': relation, 'number': phone};\n                  setState(() {\n                    if (isEdit) {\n                      _emergencyContacts[index] = contact;\n                    } else {\n                      _emergencyContacts.add(contact);\n                    }\n                  });\n                  Navigator.pop(context);\n                }\n              },\n              child: Text(isEdit ? 'Update' : 'Add'),\n            ),\n          ],\n        );\n      },\n    );\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text('Edit Profile'),\n        backgroundColor: Colors.blueAccent,\n        elevation: 0,\n      ),\n      body: Container(\n        decoration: BoxDecoration(\n          gradient: LinearGradient(\n            begin: Alignment.topCenter,\n            end: Alignment.bottomCenter,\n            colors: [Colors.blueAccent.withOpacity(0.1), Colors.white],\n          ),\n        ),\n        child: SingleChildScrollView(\n          padding: const EdgeInsets.all(24.0),\n          child: Column(\n            crossAxisAlignment: CrossAxisAlignment.start,\n            children: [\n              const Text(\n                'Profile Picture',\n                style: TextStyle(fontSize: 18, fontWeight: FontWeight.w600, color: Colors.blueAccent),\n              ),\n              const SizedBox(height: 8),\n              Center(\n                child: GestureDetector(\n                  onTap: _pickImage,\n                  child: Stack(\n                    children: [\n                      CircleAvatar(\n                        radius: 60,\n                        backgroundImage: _newProfileImage != null\n                            ? FileImage(_newProfileImage!)\n                            : (_profileImageUrl.isNotEmpty ? NetworkImage(_profileImageUrl) : null),\n                        child: (_newProfileImage == null && _profileImageUrl.isEmpty)\n                            ? const Icon(Icons.person, size: 60, color: Colors.blueAccent)\n                            : null,\n                      ),\n                      Positioned(\n                        bottom: 0,\n                        right: 0,\n                        child: CircleAvatar(\n                          backgroundColor: Colors.blueAccent,\n                          radius: 20,\n                          child: const Icon(Icons.camera_alt, color: Colors.white, size: 20),\n                        ),\n                      ),\n                    ],\n                  ),\n                ),\n              ),\n              const SizedBox(height: 24),\n              const Text(\n                'Personal Details',\n                style: TextStyle(fontSize: 18, fontWeight: FontWeight.w600, color: Colors.blueAccent),\n              ),\n              const SizedBox(height: 8),\n              _buildTextField(_fullNameController, 'Full Name', Icons.person),\n              _buildTextField(_usernameController, 'Username', Icons.alternate_email),\n              _buildTextField(_bioController, 'Bio', Icons.info, maxLines: 3),\n              _buildTextField(_phoneController, 'Phone Number', Icons.phone, keyboardType: TextInputType.phone),\n              Card(\n                elevation: 2,\n                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                child: ListTile(\n                  title: Text(_dob == null ? 'Select DOB' : DateFormat('yyyy-MM-dd').format(_dob!)),\n                  trailing: const Icon(Icons.calendar_today, color: Colors.blueAccent),\n                  onTap: _pickDob,\n                ),\n              ),\n              const SizedBox(height: 8),\n              DropdownButtonFormField<String>(\n                value: _gender, // Now this will match exactly with lowercase values\n                hint: const Text('Select Gender'),\n                decoration: InputDecoration(\n                  border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),\n                  filled: true,\n                  fillColor: Colors.white,\n                ),\n                items: [\n                  DropdownMenuItem(value: 'male', child: const Text('Male')),\n                  DropdownMenuItem(value: 'female', child: const Text('Female')),\n                  DropdownMenuItem(value: 'other', child: const Text('Other')),\n                ],\n                onChanged: (value) => setState(() => _gender = value),\n              ),\n              const SizedBox(height: 24),\n              const Text(\n                'Location',\n                style: TextStyle(fontSize: 18, fontWeight: FontWeight.w600, color: Colors.blueAccent),\n              ),\n              const SizedBox(height: 8),\n              _buildTextField(_localityController, 'Locality', Icons.location_on),\n              _buildTextField(_cityController, 'City', Icons.location_city),\n              _buildTextField(_stateController, 'State', Icons.map),\n              const SizedBox(height: 24),\n              Row(\n                mainAxisAlignment: MainAxisAlignment.spaceBetween,\n                children: [\n                  const Text(\n                    'Emergency Contacts',\n                    style: TextStyle(fontSize: 18, fontWeight: FontWeight.w600, color: Colors.blueAccent),\n                  ),\n                  IconButton(\n                    icon: const Icon(Icons.add_circle, color: Colors.blueAccent),\n                    onPressed: _addEmergencyContact,\n                  ),\n                ],\n              ),\n              const SizedBox(height: 8),\n              if (_emergencyContacts.isEmpty)\n                Card(\n                  elevation: 2,\n                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                  child: const Padding(\n                    padding: EdgeInsets.all(16.0),\n                    child: Center(\n                      child: Text(\n                        'No emergency contacts added',\n                        style: TextStyle(color: Colors.grey),\n                      ),\n                    ),\n                  ),\n                )\n              else\n                Column(\n                  children: _emergencyContacts.asMap().entries.map((entry) {\n                    int idx = entry.key;\n                    Map<String, dynamic> contact = entry.value;\n                    return Card(\n                      elevation: 2,\n                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                      child: ListTile(\n                        leading: const Icon(Icons.emergency, color: Colors.red),\n                        title: Text(contact['name'] ?? ''),\n                        subtitle: Text(\n                          'Relation: ${contact['relation'] ?? ''}\\\\nPhone: ${contact['number'] ?? ''}',\n                        ),\n                        trailing: Row(\n                          mainAxisSize: MainAxisSize.min,\n                          children: [\n                            IconButton(\n                              icon: const Icon(Icons.edit, color: Colors.blue),\n                              onPressed: () => _editEmergencyContact(idx),\n                            ),\n                            IconButton(\n                              icon: const Icon(Icons.delete, color: Colors.red),\n                              onPressed: () => _deleteEmergencyContact(idx),\n                            ),\n                          ],\n                        ),\n                      ),\n                    );\n                  }).toList(),\n                ),\n              const SizedBox(height: 32),\n              _isSaving\n                  ? const Center(child: CircularProgressIndicator(color: Colors.blueAccent))\n                  : ElevatedButton(\n                      onPressed: _saveChanges,\n                      style: ElevatedButton.styleFrom(\n                        backgroundColor: Colors.blueAccent,\n                        padding: const EdgeInsets.symmetric(vertical: 16),\n                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                        minimumSize: const Size(double.infinity, 50),\n                      ),\n                      child: const Text('Save Changes', style: TextStyle(fontSize: 18, color: Colors.white)),\n                    ),\n            ],\n          ),\n        ),\n      ),\n    );\n  }\n\n  Widget _buildTextField(TextEditingController controller, String label, IconData icon, {int maxLines = 1, TextInputType? keyboardType}) {\n    return Padding(\n      padding: const EdgeInsets.only(bottom: 16),\n      child: TextField(\n        controller: controller,\n        decoration: InputDecoration(\n          labelText: label,\n          border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),\n          filled: true,\n          fillColor: Colors.white,\n          prefixIcon: Icon(icon, color: Colors.blueAccent),\n        ),\n        maxLines: maxLines,\n        keyboardType: keyboardType,\n      ),\n    );\n  }\n\n  @override\n  void dispose() {\n    _fullNameController.dispose();\n    _usernameController.dispose();\n    _bioController.dispose();\n    _phoneController.dispose();\n    _localityController.dispose();\n    _cityController.dispose();\n    _stateController.dispose();\n    super.dispose();\n  }\n}",
          "_encoding": "utf-8"
        },
        "settings_screen.dart": {
          "_text": "// lib/user/profile/settings_screen.dart\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/material.dart';\nimport 'package:onesignal_flutter/onesignal_flutter.dart';\nimport 'package:shared_preferences/shared_preferences.dart';\nimport '../../report_page.dart';\nimport '../../welcome_page.dart';\n\nclass SettingsScreen extends StatelessWidget {\n  const SettingsScreen({super.key});\n\n  Future<void> _logout(BuildContext context) async {\n    final uid = FirebaseAuth.instance.currentUser?.uid;\n    if (uid != null) {\n      final playerId = OneSignal.User.pushSubscription.id;\n      if (playerId != null) {\n        await FirebaseFirestore.instance.collection('user').doc(uid).update({\n          'playerIds': FieldValue.arrayRemove([playerId]),\n        });\n      }\n    }\n    await FirebaseAuth.instance.signOut();\n    final prefs = await SharedPreferences.getInstance();\n    await prefs.remove('lastRole'); // Clear role on logout\n    Navigator.pushReplacement(\n      context,\n      MaterialPageRoute(builder: (context) => const WelcomePage()),\n    );\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text('Settings'),\n        backgroundColor: Colors.blueAccent,\n        elevation: 0,\n      ),\n      body: Container(\n        decoration: BoxDecoration(\n          gradient: LinearGradient(\n            begin: Alignment.topCenter,\n            end: Alignment.bottomCenter,\n            colors: [Colors.blueAccent.withOpacity(0.1), Colors.white],\n          ),\n        ),\n        child: ListView(\n          padding: const EdgeInsets.all(16.0),\n          children: [\n            const Text(\n              'Account',\n              style: TextStyle(\n                fontSize: 18,\n                fontWeight: FontWeight.w600,\n                color: Colors.blueAccent,\n              ),\n            ),\n            const SizedBox(height: 8),\n            Card(\n              elevation: 2,\n              shape: RoundedRectangleBorder(\n                borderRadius: BorderRadius.circular(12),\n              ),\n              child: ListTile(\n                leading: const Icon(Icons.logout, color: Colors.red),\n                title: const Text('Logout'),\n                onTap: () => _logout(context),\n              ),\n            ),\n            const SizedBox(height: 24),\n\n            const Text(\n              'Preferences',\n              style: TextStyle(\n                fontSize: 18,\n                fontWeight: FontWeight.w600,\n                color: Colors.blueAccent,\n              ),\n            ),\n            const SizedBox(height: 8),\n\n            /// 🔹 Added Report Option\n            Card(\n              elevation: 2,\n              shape: RoundedRectangleBorder(\n                borderRadius: BorderRadius.circular(12),\n              ),\n              child: ListTile(\n                leading: const Icon(Icons.report, color: Colors.orange),\n                title: const Text('Report'),\n                onTap: () => Navigator.push(\n                  context,\n                  MaterialPageRoute(\n                    builder: (context) =>\n                        const ReportPage(reporterRole: 'user'),\n                  ),\n                ),\n              ),\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n}\n",
          "_encoding": "utf-8"
        },
        "user_profile.dart": {
          "_text": "// lib/user/profile/user_profile.dart\n\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/material.dart';\nimport 'package:intl/intl.dart';\nimport 'package:url_launcher/url_launcher.dart';\nimport 'edit_profile_screen.dart';\nimport 'settings_screen.dart';\n\nclass UserProfile extends StatefulWidget {\n  const UserProfile({super.key});\n\n  @override\n  State<UserProfile> createState() => _UserProfileState();\n}\n\nclass _UserProfileState extends State<UserProfile> {\n  final _auth = FirebaseAuth.instance;\n  final _firestore = FirebaseFirestore.instance;\n  Map<String, dynamic>? _userData;\n  bool _isLoading = true;\n  bool _hasError = false;\n  int _remainingTasks = 0;\n  int _completedTasks = 0;\n  int _totalTasks = 0;\n  List<QueryDocumentSnapshot> _albums = [];\n\n  @override\n  void initState() {\n    super.initState();\n    _loadUserData();\n  }\n\n  Future<void> _loadUserData() async {\n    if (!mounted) return;\n    setState(() {\n      _isLoading = true;\n      _hasError = false;\n    });\n\n    try {\n      final uid = _auth.currentUser?.uid;\n      if (uid != null) {\n        // Load user data\n        final doc = await _firestore.collection('user').doc(uid).get();\n        if (doc.exists && mounted) {\n          setState(() {\n            _userData = doc.data();\n          });\n        } else {\n          throw Exception('User document not found');\n        }\n\n        // Load albums\n        final albumSnap = await _firestore\n            .collection('user')\n            .doc(uid)\n            .collection('album')\n            .orderBy('createdAt', descending: true)\n            .get();\n        if (mounted) {\n          setState(() {\n            _albums = albumSnap.docs;\n          });\n        }\n\n        // Load today's tasks counts\n        final today = DateTime.now();\n        final todayStart = Timestamp.fromDate(\n          DateTime(today.year, today.month, today.day),\n        );\n        final todayEnd = Timestamp.fromDate(\n          DateTime(today.year, today.month, today.day, 23, 59, 59),\n        );\n\n        final tasksSnap = await _firestore\n            .collection('user')\n            .doc(uid)\n            .collection('to_dos')\n            .where('dueDate', isGreaterThanOrEqualTo: todayStart)\n            .where('dueDate', isLessThanOrEqualTo: todayEnd)\n            .get();\n\n        if (mounted) {\n          final incomplete = tasksSnap.docs\n              .where((doc) => doc.data()['completed'] == false)\n              .length;\n          final total = tasksSnap.docs.length;\n          final completed = total - incomplete;\n\n          setState(() {\n            _remainingTasks = incomplete;\n            _completedTasks = completed;\n            _totalTasks = total;\n            _isLoading = false;\n          });\n        }\n      } else {\n        throw Exception('No user logged in');\n      }\n    } catch (e) {\n      if (mounted) {\n        setState(() {\n          _isLoading = false;\n          _hasError = true;\n        });\n      }\n    }\n  }\n\n  Future<void> _callNumber(String number) async {\n    final uri = Uri(scheme: 'tel', path: number);\n    if (await canLaunchUrl(uri)) {\n      await launchUrl(uri);\n    } else if (!mounted) return;\n    ScaffoldMessenger.of(context).showSnackBar(\n      SnackBar(content: Text('Could not launch dialer for $number')),\n    );\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      backgroundColor: Colors.white,\n      appBar: AppBar(\n        title: Text(\n          _userData?['username'] ?? \"Profile\",\n          style: const TextStyle(\n            color: Colors.white,\n            fontWeight: FontWeight.bold,\n            fontSize: 20,\n          ),\n        ),\n        backgroundColor: Colors.blue, // ✅ Changed from white to blue\n        elevation: 0,\n        iconTheme: const IconThemeData(color: Colors.white), // ✅ Makes back icon white\n      ),\n\n      body: _isLoading\n          ? const Center(child: CircularProgressIndicator())\n          : _hasError || _userData == null\n              ? const Center(\n                  child: Text(\n                    \"Error loading profile\",\n                    style: TextStyle(color: Colors.red),\n                  ),\n                )\n              : RefreshIndicator(\n                  onRefresh: _loadUserData,\n                  child: DefaultTabController(\n                    length: 2,\n                    child: SingleChildScrollView(\n                      physics: const AlwaysScrollableScrollPhysics(),\n                      child: Column(\n                        crossAxisAlignment: CrossAxisAlignment.start,\n                        children: [\n                          const SizedBox(height: 16),\n\n                          /// Header with avatar + stats\n                          Row(\n                            crossAxisAlignment: CrossAxisAlignment.start,\n                            children: [\n                              const SizedBox(width: 16),\n                              CircleAvatar(\n                                radius: 45,\n                                backgroundColor: Colors.grey[300],\n                                backgroundImage: (_userData!['profileImageUrl'] !=\n                                            null &&\n                                        _userData!['profileImageUrl']\n                                            .toString()\n                                            .isNotEmpty)\n                                    ? NetworkImage(\n                                        _userData!['profileImageUrl'])\n                                    : null,\n                                child: (_userData!['profileImageUrl'] == null ||\n                                        _userData!['profileImageUrl']\n                                            .toString()\n                                            .isEmpty)\n                                    ? const Icon(Icons.person,\n                                        size: 50, color: Colors.grey)\n                                    : null,\n                              ),\n                              const SizedBox(width: 24),\n                              Expanded(\n                                child: Row(\n                                  mainAxisAlignment:\n                                      MainAxisAlignment.spaceEvenly,\n                                  children: [\n                                    _buildStat(\"Remaining\", _remainingTasks.toString()),\n                                    _buildStat(\"Completed\", _completedTasks.toString()),\n                                    _buildStat(\"Total\", _totalTasks.toString()),\n                                  ],\n                                ),\n                              ),\n                              const SizedBox(width: 16),\n                            ],\n                          ),\n\n                          const SizedBox(height: 12),\n\n                          Padding(\n                            padding:\n                                const EdgeInsets.symmetric(horizontal: 16.0),\n                            child: Column(\n                              crossAxisAlignment: CrossAxisAlignment.start,\n                              children: [\n                                Text(\n                                  _userData!['fullName'] ?? \"No Name\",\n                                  style: const TextStyle(\n                                      fontWeight: FontWeight.bold, fontSize: 18),\n                                ),\n                                const SizedBox(height: 4),\n                                Text(\n                                  _userData!['bio'] ?? \"No bio yet\",\n                                  style: const TextStyle(fontSize: 14),\n                                ),\n                                const SizedBox(height: 6),\n                                if (_userData!['email'] != null)\n                                  Text(\n                                    _userData!['email'],\n                                    style: const TextStyle(\n                                        fontSize: 14, color: Colors.blueGrey),\n                                  ),\n                                if (_userData!['phoneNo'] != null)\n                                  Text(\n                                    _userData!['phoneNo'],\n                                    style: const TextStyle(\n                                        fontSize: 14, color: Colors.blueGrey),\n                                  ),\n                              ],\n                            ),\n                          ),\n\n\n                          Padding(\n                            padding: const EdgeInsets.symmetric(horizontal: 16.0),\n                            child: Column(\n                              crossAxisAlignment: CrossAxisAlignment.start,\n                              children: [\n                                if (_userData!['dob'] != null || _userData!['gender'] != null)\n                                  Padding(\n                                    padding: const EdgeInsets.symmetric(vertical: 1.0),\n                                    child: Row(\n                                      children: [\n                                        if (_userData!['dob'] != null)\n                                          Expanded(\n                                            child: _buildInfoRow(\n                                              \"Birthday\",\n                                              DateFormat('yyyy-MM-dd')\n                                                  .format(_userData!['dob'].toDate()),\n                                            ),\n                                          ),\n                                        if (_userData!['gender'] != null)\n                                          Expanded(\n                                            child: _buildInfoRow(\"Gender\", _userData!['gender']),\n                                          ),\n                                      ],\n                                    ),\n                                  ),\n                                if (_userData!['locality'] != null ||\n                                    _userData!['city'] != null ||\n                                    _userData!['state'] != null)\n                                  Padding(\n                                    padding: const EdgeInsets.symmetric(vertical: 1.0), \n                                    child: _buildInfoRow(\n                                      \"Location\",\n                                      [\n                                        _userData!['locality'],\n                                        _userData!['city'],\n                                        _userData!['state']\n                                      ]\n                                          .where((e) => e != null && e.toString().isNotEmpty)\n                                          .join(\", \"),\n                                    ),\n                                  ),\n                              ],\n                            ),\n                          ),\n\n\n                          const SizedBox(height: 20),\n\n                          /// Buttons\n                          Row(\n                            mainAxisAlignment: MainAxisAlignment.spaceEvenly,\n                            children: [\n                              Expanded(\n                                child: Padding(\n                                  padding: const EdgeInsets.symmetric(horizontal: 8),\n                                  child: ElevatedButton(\n                                    onPressed: () async {\n                                      if (_userData != null) {\n                                        final updated = await Navigator.push(\n                                          context,\n                                          MaterialPageRoute(\n                                            builder: (context) => EditProfileScreen(userData: _userData ?? {}),\n                                          ),\n                                        );\n                                        if (updated == true) {\n                                          _loadUserData();\n                                        }\n                                      }\n                                    },\n                                    style: ElevatedButton.styleFrom(\n                                      backgroundColor: Colors.blue, // ✅ Button background color\n                                      foregroundColor: Colors.white, // ✅ Text color\n                                      shape: RoundedRectangleBorder(\n                                        borderRadius: BorderRadius.circular(8),\n                                      ),\n                                      padding: const EdgeInsets.symmetric(vertical: 12),\n                                    ),\n                                    child: const Text(\"Edit Profile\"),\n                                  ),\n                                ),\n                              ),\n                              Expanded(\n                                child: Padding(\n                                  padding: const EdgeInsets.symmetric(horizontal: 8),\n                                  child: ElevatedButton(\n                                    onPressed: () {\n                                      Navigator.push(\n                                        context,\n                                        MaterialPageRoute(builder: (_) => const SettingsScreen()),\n                                      );\n                                    },\n                                    style: ElevatedButton.styleFrom(\n                                      backgroundColor: Colors.blue, // ✅ Button background color\n                                      foregroundColor: Colors.white, // ✅ Text color\n                                      shape: RoundedRectangleBorder(\n                                        borderRadius: BorderRadius.circular(8),\n                                      ),\n                                      padding: const EdgeInsets.symmetric(vertical: 12),\n                                    ),\n                                    child: const Text(\"Settings\"),\n                                  ),\n                                ),\n                              ),\n                            ],\n                          ),\n\n                          const SizedBox(height: 20),\n                          const Divider(thickness: 1),\n                          const SizedBox(height: 20),\n\n                          const TabBar(\n                            tabs: [\n                              Tab(icon: Icon(Icons.photo_album)),\n                              Tab(icon: Icon(Icons.contacts)),\n                            ],\n                            indicatorColor: Colors.blueAccent,\n                            labelColor: Colors.blueAccent,\n                            unselectedLabelColor: Colors.grey,\n                          ),\n\n                          SizedBox(\n                            height: 300,\n                            child: TabBarView(\n                              children: [\n                                _buildAlbumTab(),\n                                _buildEmergencyTab(),\n                              ],\n                            ),\n                          ),\n\n                          const SizedBox(height: 40),\n                        ],\n                      ),\n                    ),\n                  ),\n                ),\n    );\n  }\n\n  Widget _buildStat(String label, String count) {\n    return Column(\n      children: [\n        Text(\n          count,\n          style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 18),\n        ),\n        const SizedBox(height: 4),\n        Text(label, style: const TextStyle(fontSize: 14, color: Colors.black54)),\n      ],\n    );\n  }\n\n  Widget _buildInfoRow(String title, String value) {\n    return Padding(\n      padding: const EdgeInsets.symmetric(vertical: 6.0),\n      child: Row(\n        children: [\n          Text(\n            \"$title: \",\n            style: const TextStyle(\n                fontWeight: FontWeight.bold, color: Colors.black87),\n          ),\n          Expanded(\n            child: Text(value, style: const TextStyle(color: Colors.black87)),\n          ),\n        ],\n      ),\n    );\n  }\n\n  Widget _buildAlbumTab() {\n    if (_albums.isEmpty) {\n      return const Center(\n        child: Column(\n          mainAxisAlignment: MainAxisAlignment.center,\n          children: [\n            Icon(Icons.photo_album_outlined, size: 64, color: Colors.grey),\n            SizedBox(height: 16),\n            Text(\n              'No memories yet. Add one!',\n              style: TextStyle(fontSize: 18, color: Colors.grey),\n            ),\n          ],\n        ),\n      );\n    }\n\n    return GridView.builder(\n      padding: const EdgeInsets.all(16),\n      gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(\n        crossAxisCount: 3,\n        childAspectRatio: 1,\n        crossAxisSpacing: 4,\n        mainAxisSpacing: 4,\n      ),\n      itemCount: _albums.length,\n      itemBuilder: (context, index) {\n        final album = _albums[index].data() as Map<String, dynamic>;\n        return GestureDetector(\n          onTap: () => Navigator.push(\n            context,\n            MaterialPageRoute(\n              builder: (context) => FullImageScreen(imageUrl: album['imageUrl']),\n            ),\n          ),\n          child: ClipRRect(\n            borderRadius: BorderRadius.circular(8),\n            child: Image.network(\n              album['imageUrl'],\n              fit: BoxFit.cover,\n              errorBuilder: (context, error, stackTrace) {\n                return const Center(child: Icon(Icons.error));\n              },\n            ),\n          ),\n        );\n      },\n    );\n  }\n\n  Widget _buildEmergencyTab() {\n    final contacts = _userData!['emergencyContacts'] as List? ?? [];\n    if (contacts.isEmpty) {\n      return const Center(\n        child: Column(\n          mainAxisAlignment: MainAxisAlignment.center,\n          children: [\n            Icon(Icons.contacts_outlined, size: 64, color: Colors.grey),\n            SizedBox(height: 16),\n            Text(\n              'No emergency contacts',\n              style: TextStyle(fontSize: 18, color: Colors.grey),\n            ),\n          ],\n        ),\n      );\n    }\n\n    return ListView.builder(\n      padding: const EdgeInsets.all(16),\n      itemCount: contacts.length,\n      itemBuilder: (context, index) {\n        final contact = contacts[index] as Map<String, dynamic>;\n        return Card(\n          elevation: 2,\n          margin: const EdgeInsets.only(bottom: 16),\n          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n          child: ListTile(\n            leading: const Icon(Icons.person, color: Colors.blueAccent),\n            title: Text(contact['name'] ?? 'Unknown'),\n            subtitle: Column(\n              crossAxisAlignment: CrossAxisAlignment.start,\n              children: [\n                Text('Relation: ${contact['relation'] ?? 'None'}'),\n                Text('Phone: ${contact['number'] ?? 'None'}'),\n              ],\n            ),\n            trailing: IconButton(\n              icon: const Icon(Icons.phone, color: Colors.green),\n              onPressed: () {\n                final number = contact['number'] as String?;\n                if (number != null && number.isNotEmpty) {\n                  _callNumber(number);\n                }\n              },\n            ),\n          ),\n        );\n      },\n    );\n  }\n}\n\nclass FullImageScreen extends StatelessWidget {\n  final String imageUrl;\n  const FullImageScreen({super.key, required this.imageUrl});\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      backgroundColor: Colors.black,\n      body: GestureDetector(\n        onTap: () => Navigator.pop(context),\n        child: Center(\n          child: Image.network(imageUrl),\n        ),\n      ),\n      floatingActionButton: FloatingActionButton(\n        mini: true,\n        onPressed: () => Navigator.pop(context),\n        child: const Icon(Icons.close),\n      ),\n      floatingActionButtonLocation: FloatingActionButtonLocation.endTop,\n    );\n  }\n}",
          "_encoding": "utf-8"
        }
      },
      "location_service.dart": {
        "_text": "// lib/user/location_service.dart (Fully Fixed)\nimport 'dart:async';\n\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:geolocator/geolocator.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:permission_handler/permission_handler.dart';\nimport 'package:flutter/material.dart';\n\nclass PatientLocationService {\n  final _firestore = FirebaseFirestore.instance;\n  final _auth = FirebaseAuth.instance;\n  Timer? _updateTimer;\n  bool _isSharing = false;\n\n  // Check if location services are enabled\n  Future<bool> _checkLocationService() async {\n    try {\n      return await Geolocator.isLocationServiceEnabled();\n    } catch (e) {\n      debugPrint('Error checking location service: $e');\n      return false;\n    }\n  }\n\n  // Request location permissions\n  Future<bool> _requestLocationPermission(BuildContext context) async {\n    try {\n      // Check current permission status first\n      LocationPermission permission = await Geolocator.checkPermission();\n      \n      if (permission == LocationPermission.deniedForever) {\n        if (context.mounted) {\n          await _showPermissionDialog(\n            context,\n            'Location Permission Permanently Denied',\n            'Location permission has been permanently denied. Please enable it in app settings to share your location.',\n          );\n        }\n        return false;\n      }\n\n      if (permission == LocationPermission.denied) {\n        permission = await Geolocator.requestPermission();\n        \n        if (permission == LocationPermission.denied) {\n          if (context.mounted) {\n            ScaffoldMessenger.of(context).showSnackBar(\n              const SnackBar(content: Text('Location permission is required to share location')),\n            );\n          }\n          return false;\n        }\n        \n        if (permission == LocationPermission.deniedForever) {\n          if (context.mounted) {\n            await _showPermissionDialog(\n              context,\n              'Location Permission Denied',\n              'Location permission has been denied. Please enable it in app settings to share your location.',\n            );\n          }\n          return false;\n        }\n      }\n\n      return permission == LocationPermission.always || \n             permission == LocationPermission.whileInUse;\n    } catch (e) {\n      debugPrint('Error requesting location permission: $e');\n      if (context.mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Error requesting location permission: $e')),\n        );\n      }\n      return false;\n    }\n  }\n\n  // Show permission dialog\n  Future<void> _showPermissionDialog(BuildContext context, String title, String content) async {\n    return showDialog(\n      context: context,\n      builder: (context) => AlertDialog(\n        title: Text(title),\n        content: Text(content),\n        actions: [\n          TextButton(\n            onPressed: () => Navigator.pop(context),\n            child: const Text('Cancel'),\n          ),\n          TextButton(\n            onPressed: () async {\n              Navigator.pop(context);\n              await openAppSettings();\n            },\n            child: const Text('Open Settings'),\n          ),\n        ],\n      ),\n    );\n  }\n\n  // Start sharing location\n  Future<void> startSharingLocation(BuildContext context) async {\n    if (_isSharing) {\n      debugPrint('Location sharing already active');\n      return;\n    }\n\n    try {\n      // Check if location services are enabled\n      final serviceEnabled = await _checkLocationService();\n      if (!serviceEnabled) {\n        if (context.mounted) {\n          await showDialog(\n            context: context,\n            builder: (context) => AlertDialog(\n              title: const Text('Location Services Disabled'),\n              content: const Text('Please enable location services to share your location.'),\n              actions: [\n                TextButton(\n                  onPressed: () => Navigator.pop(context),\n                  child: const Text('Cancel'),\n                ),\n                TextButton(\n                  onPressed: () async {\n                    Navigator.pop(context);\n                    await Geolocator.openLocationSettings();\n                  },\n                  child: const Text('Open Settings'),\n                ),\n              ],\n            ),\n          );\n        }\n        return;\n      }\n\n      // Request location permission\n      final hasPermission = await _requestLocationPermission(context);\n      if (!hasPermission) {\n        return;\n      }\n\n      // Start location sharing with initial update and periodic timer\n      _isSharing = true;\n      \n      // Initial location update on start\n      await _getAndUpdateLocation(context);\n      \n      // Set up periodic updates every 30 minutes\n      _updateTimer = Timer.periodic(const Duration(minutes: 30), (_) {\n        _getAndUpdateLocation(context);\n      });\n\n      debugPrint('Location sharing started successfully with periodic updates');\n\n    } catch (e) {\n      debugPrint('Error starting location sharing: $e');\n      if (context.mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Error starting location sharing: $e')),\n        );\n      }\n      _isSharing = false;\n    }\n  }\n\n  // Get current location and update in Firestore\n  Future<void> _getAndUpdateLocation(BuildContext context) async {\n    try {\n      final position = await Geolocator.getCurrentPosition(\n        desiredAccuracy: LocationAccuracy.best,\n        timeLimit: const Duration(seconds: 30),\n      );\n      await _updateLocationInFirestore(position);\n    } catch (e) {\n      debugPrint('Error getting location: $e');\n      _handleLocationError(e, context);\n    }\n  }\n\n  // Update location in Firestore\n  Future<void> _updateLocationInFirestore(Position position) async {\n    try {\n      final uid = _auth.currentUser?.uid;\n      if (uid == null) {\n        debugPrint('No user logged in');\n        return;\n      }\n\n      await _firestore.collection(\"user\").doc(uid).update({\n        \"currentLat\": position.latitude,\n        \"currentLng\": position.longitude,\n        \"locationTimestamp\": FieldValue.serverTimestamp(),\n      });\n      \n      debugPrint('Location updated: ${position.latitude}, ${position.longitude}');\n    } catch (e) {\n      debugPrint(\"Error updating location in Firestore: $e\");\n    }\n  }\n\n  // Handle location errors\n  void _handleLocationError(dynamic error, BuildContext context) {\n    debugPrint('Location error: $error');\n    \n    if (error is LocationServiceDisabledException) {\n      if (context.mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Location services have been disabled')),\n        );\n      }\n    } else {\n      if (context.mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Location error: ${error.toString()}')),\n        );\n      }\n    }\n  }\n\n  // Stop sharing location\n  Future<void> stopSharingLocation() async {\n    try {\n      _updateTimer?.cancel();\n      _updateTimer = null;\n      _isSharing = false;\n      debugPrint('Location sharing stopped');\n    } catch (e) {\n      debugPrint('Error stopping location sharing: $e');\n    }\n  }\n\n  // Check if location is being shared\n  bool get isSharing => _isSharing;\n\n  // Dispose resources\n  void dispose() {\n    _updateTimer?.cancel();\n    _updateTimer = null;\n    _isSharing = false;\n  }\n}",
        "_encoding": "utf-8"
      },
      "user_bottom_nav.dart": {
        "_text": "// lib/user/user_bottom_nav.dart\nimport 'dart:async';\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/material.dart';\nimport 'diary_album/diary_album_screen.dart';\nimport 'family/family_screen.dart';\nimport 'home/home_screen.dart';\nimport 'caretaker/caretaker_screen.dart';\nimport 'profile/user_profile.dart';\nimport 'location_service.dart';\n\nclass UserBottomNav extends StatefulWidget {\n  const UserBottomNav({super.key});\n\n  @override\n  State<UserBottomNav> createState() => _UserBottomNavState();\n}\n\nclass _UserBottomNavState extends State<UserBottomNav> {\n  int _selectedIndex = 2; // Start with Home (center)\n  final PatientLocationService _locationService = PatientLocationService();\n  StreamSubscription<DocumentSnapshot>? _connectionSubscription;\n  bool _isConnected = false;\n\n  final List<Widget> _pages = [\n    const FamilyScreen(),\n    const CaretakerScreen(),\n    const HomeScreen(),\n    const DiaryAlbumScreen(),\n    const UserProfile(),\n  ];\n\n  Future<void> _checkBanned() async {\n    final uid = FirebaseAuth.instance.currentUser?.uid;\n    if (uid == null) return;\n\n    final doc = await FirebaseFirestore.instance.collection('user').doc(uid).get();\n\n    if (doc.data()?['isBanned'] == true) {\n      if (!mounted) return;\n      showDialog(\n        context: context,\n        builder: (_) => AlertDialog(\n          title: const Text('Account Banned'),\n          content: const Text('Your account has been banned.'),\n          actions: [\n            TextButton(\n              onPressed: () async {\n                await _cleanup();\n                await FirebaseAuth.instance.signOut();\n                if (!mounted) return;\n                Navigator.pushReplacementNamed(context, '/welcome');\n              },\n              child: const Text('Logout'),\n            ),\n          ],\n        ),\n      );\n    }\n  }\n\n  void _startConnectionListener() {\n    final uid = FirebaseAuth.instance.currentUser?.uid;\n    if (uid == null) return;\n\n    _connectionSubscription = FirebaseFirestore.instance\n        .collection('user')\n        .doc(uid)\n        .snapshots()\n        .listen((snapshot) {\n      if (snapshot.exists) {\n        final data = snapshot.data();\n        final newConnectionStatus = data?['isConnected'] == true;\n\n        if (newConnectionStatus != _isConnected) {\n          setState(() => _isConnected = newConnectionStatus);\n\n          if (newConnectionStatus) {\n            _startLocationSharing();\n          } else {\n            _stopLocationSharing();\n          }\n        }\n      }\n    }, onError: (error) {\n      debugPrint('Connection listener error: $error');\n    });\n  }\n\n  Future<void> _startLocationSharing() async {\n    try {\n      await _locationService.startSharingLocation(context);\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Location sharing started')),\n        );\n      }\n    } catch (e) {\n      debugPrint('Error starting location sharing: $e');\n    }\n  }\n\n  Future<void> _stopLocationSharing() async {\n    try {\n      await _locationService.stopSharingLocation();\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Location sharing stopped')),\n        );\n      }\n    } catch (e) {\n      debugPrint('Error stopping location sharing: $e');\n    }\n  }\n\n  Future<void> _cleanup() async {\n    await _stopLocationSharing();\n    _locationService.dispose();\n    await _connectionSubscription?.cancel();\n    _connectionSubscription = null;\n  }\n\n  @override\n  void initState() {\n    super.initState();\n    _checkBanned();\n    _startConnectionListener();\n  }\n\n  @override\n  void dispose() {\n    _cleanup();\n    super.dispose();\n  }\n\n  Widget _buildAnimatedIcon(IconData icon, int index, String label) {\n    final bool isSelected = _selectedIndex == index;\n\n    return Column(\n      mainAxisAlignment: MainAxisAlignment.center,\n      children: [\n        AnimatedScale(\n          scale: isSelected ? 1.25 : 1.0,\n          duration: const Duration(milliseconds: 200),\n          curve: Curves.easeOut,\n          child: Icon(\n            icon,\n            color: isSelected ? Colors.blueAccent : Colors.grey[600],\n          ),\n        ),\n        const SizedBox(height: 3),\n        AnimatedOpacity(\n          opacity: isSelected ? 1.0 : 0.0,\n          duration: const Duration(milliseconds: 200),\n          child: Text(\n            label,\n            style: TextStyle(\n              fontSize: 11,\n              fontWeight: isSelected ? FontWeight.w600 : FontWeight.w400,\n              color: Colors.blueAccent,\n            ),\n          ),\n        ),\n      ],\n    );\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      body: _pages[_selectedIndex],\n      bottomNavigationBar: Container(\n        decoration: const BoxDecoration(\n          color: Colors.white,\n          boxShadow: [BoxShadow(blurRadius: 6, color: Colors.black12)],\n        ),\n        child: BottomNavigationBar(\n          currentIndex: _selectedIndex,\n          onTap: (index) => setState(() => _selectedIndex = index),\n          type: BottomNavigationBarType.fixed,\n          backgroundColor: Colors.white,\n          elevation: 0,\n          showSelectedLabels: false,\n          showUnselectedLabels: false,\n          items: [\n            BottomNavigationBarItem(\n              icon: _buildAnimatedIcon(Icons.group, 0, 'Family'),\n              label: '',\n            ),\n            BottomNavigationBarItem(\n              icon: _buildAnimatedIcon(Icons.medical_services, 1, 'Care'),\n              label: '',\n            ),\n            BottomNavigationBarItem(\n              icon: _buildAnimatedIcon(Icons.home_rounded, 2, 'Home'),\n              label: '',\n            ),\n            BottomNavigationBarItem(\n              icon: _buildAnimatedIcon(Icons.book_outlined, 3, 'Diary'),\n              label: '',\n            ),\n            BottomNavigationBarItem(\n              icon: _buildAnimatedIcon(Icons.person_rounded, 4, 'Profile'),\n              label: '',\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n}\n",
        "_encoding": "utf-8"
      }
    },
    "utils": {
      "notification_helper.dart": {
        "_text": "// lib/utils/notification_helper.dart\nimport 'package:http/http.dart' as http;\nimport 'dart:convert';\nimport 'package:intl/intl.dart';\n\nFuture<void> sendNotification(List<String> playerIds, String content) async {\n  if (playerIds.isEmpty) return;\n\n  const appId = '73673a14-2de9-44c4-a9c5-dd531da39b59';\n  const apiKey = 'rirnuaeujum3mksb5gtjrhjnq';\n\n  try {\n    final response = await http.post(\n      Uri.parse('https://onesignal.com/api/v1/notifications'),\n      headers: {\n        'Content-Type': 'application/json; charset=utf-8',\n        'Authorization': 'Basic $apiKey',\n      },\n      body: jsonEncode({\n        'app_id': appId,\n        'include_player_ids': playerIds,\n        'contents': {'en': content},\n        'priority': 10,\n      }),\n    ).timeout(const Duration(seconds: 10));\n\n    if (response.statusCode != 200) {\n      print('Failed to send notification: ${response.statusCode} - ${response.body}');\n    }\n  } catch (e) {\n    print('Error sending notification: $e');\n  }\n}\n\nFuture<void> scheduleNotification(List<String> playerIds, String content, DateTime scheduledTime) async {\n  if (playerIds.isEmpty) return;\n\n  const appId = '73673a14-2de9-44c4-a9c5-dd531da39b59';\n  const apiKey = 'rirnuaeujum3mksb5gtjrhjnq';\n\n  final formattedTime = DateFormat('yyyy-MM-dd HH:mm:ss').format(scheduledTime.toUtc()) + ' UTC';\n\n  try {\n    final response = await http.post(\n      Uri.parse('https://onesignal.com/api/v1/notifications'),\n      headers: {\n        'Content-Type': 'application/json; charset=utf-8',\n        'Authorization': 'Basic $apiKey',\n      },\n      body: jsonEncode({\n        'app_id': appId,\n        'include_player_ids': playerIds,\n        'contents': {'en': content},\n        'send_after': formattedTime,\n        'priority': 10,\n      }),\n    ).timeout(const Duration(seconds: 10));\n\n    if (response.statusCode != 200) {\n      print('Failed to schedule notification: ${response.statusCode} - ${response.body}');\n    }\n  } catch (e) {\n    print('Error scheduling notification: $e');\n  }\n}",
        "_encoding": "utf-8"
      }
    },
    "firebase_options.dart": {
      "_text": "// File generated by FlutterFire CLI.\n// ignore_for_file: type=lint\nimport 'package:firebase_core/firebase_core.dart' show FirebaseOptions;\nimport 'package:flutter/foundation.dart'\n    show defaultTargetPlatform, kIsWeb, TargetPlatform;\n\n/// Default [FirebaseOptions] for use with your Firebase apps.\n///\n/// Example:\n/// ```dart\n/// import 'firebase_options.dart';\n/// // ...\n/// await Firebase.initializeApp(\n///   options: DefaultFirebaseOptions.currentPlatform,\n/// );\n/// ```\nclass DefaultFirebaseOptions {\n  static FirebaseOptions get currentPlatform {\n    if (kIsWeb) {\n      throw UnsupportedError(\n        'DefaultFirebaseOptions have not been configured for web - '\n        'you can reconfigure this by running the FlutterFire CLI again.',\n      );\n    }\n    switch (defaultTargetPlatform) {\n      case TargetPlatform.android:\n        return android;\n      case TargetPlatform.iOS:\n        return ios;\n      case TargetPlatform.macOS:\n        throw UnsupportedError(\n          'DefaultFirebaseOptions have not been configured for macos - '\n          'you can reconfigure this by running the FlutterFire CLI again.',\n        );\n      case TargetPlatform.windows:\n        throw UnsupportedError(\n          'DefaultFirebaseOptions have not been configured for windows - '\n          'you can reconfigure this by running the FlutterFire CLI again.',\n        );\n      case TargetPlatform.linux:\n        throw UnsupportedError(\n          'DefaultFirebaseOptions have not been configured for linux - '\n          'you can reconfigure this by running the FlutterFire CLI again.',\n        );\n      default:\n        throw UnsupportedError(\n          'DefaultFirebaseOptions are not supported for this platform.',\n        );\n    }\n  }\n\n  static const FirebaseOptions android = FirebaseOptions(\n    apiKey: 'AIzaSyD24yA69_RtcP-ad4cVST3ykwfEEpWScGw',\n    appId: '1:54955106735:android:ed95e1b17fba45b566cf5a',\n    messagingSenderId: '54955106735',\n    projectId: 'dementia-app-2025',\n    storageBucket: 'dementia-app-2025.firebasestorage.app',\n  );\n\n  static const FirebaseOptions ios = FirebaseOptions(\n    apiKey: 'AIzaSyAznFalyZJzZlofbHOIYUXbGiipNwL7PXU',\n    appId: '1:54955106735:ios:da277fbc63d770d366cf5a',\n    messagingSenderId: '54955106735',\n    projectId: 'dementia-app-2025',\n    storageBucket: 'dementia-app-2025.firebasestorage.app',\n    iosBundleId: 'com.example.dementiaVirtualMemory',\n  );\n}\n",
      "_encoding": "utf-8"
    },
    "forgot_password_page.dart": {
      "_text": "// lib/forgot_password_page.dart\n// lib/forgot_password_page.dart\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/material.dart';\n\nclass ForgotPasswordPage extends StatefulWidget {\n  const ForgotPasswordPage({super.key});\n\n  @override\n  State<ForgotPasswordPage> createState() => _ForgotPasswordPageState();\n}\n\nclass _ForgotPasswordPageState extends State<ForgotPasswordPage> {\n  final TextEditingController emailController = TextEditingController();\n  final _auth = FirebaseAuth.instance;\n  bool _loading = false;\n\n  Future<void> _resetPassword() async {\n    setState(() => _loading = true);\n    try {\n      await _auth.sendPasswordResetEmail(email: emailController.text.trim());\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Password reset link sent to ${emailController.text}')));\n      }\n    } catch (e) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Failed: $e')));\n      }\n    } finally {\n      setState(() => _loading = false);\n    }\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      resizeToAvoidBottomInset: true, // Ensure content resizes when keyboard appears\n      appBar: AppBar(\n        title: const Text('Forgot Password'),\n        backgroundColor: Colors.blueAccent,\n        elevation: 0,\n      ),\n      body: Container(\n        decoration: BoxDecoration(\n          gradient: LinearGradient(\n            begin: Alignment.topCenter,\n            end: Alignment.bottomCenter,\n            colors: [Colors.blueAccent.withValues(alpha: 0.1), Colors.white],\n          ),\n        ),\n        child: SingleChildScrollView( // Add SingleChildScrollView to handle keyboard overflow\n          padding: const EdgeInsets.all(24.0),\n          child: Column(\n            mainAxisAlignment: MainAxisAlignment.center,\n            children: [\n              const Text(\n                'Enter your email to reset your password',\n                style: TextStyle(fontSize: 18, color: Colors.blueAccent),\n                textAlign: TextAlign.center,\n              ),\n              const SizedBox(height: 24),\n              TextField(\n                controller: emailController,\n                decoration: InputDecoration(\n                  labelText: 'Email',\n                  border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),\n                  filled: true,\n                  fillColor: Colors.white,\n                  prefixIcon: const Icon(Icons.email, color: Colors.blueAccent),\n                ),\n              ),\n              const SizedBox(height: 32),\n              _loading\n                  ? const CircularProgressIndicator(color: Colors.blueAccent)\n                  : ElevatedButton(\n                      onPressed: _resetPassword,\n                      style: ElevatedButton.styleFrom(\n                        backgroundColor: Colors.blueAccent,\n                        padding: const EdgeInsets.symmetric(vertical: 16),\n                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                        minimumSize: const Size(double.infinity, 50),\n                      ),\n                      child: const Text('Send Reset Link', style: TextStyle(fontSize: 18, color: Colors.white)),\n                    ),\n            ],\n          ),\n        ),\n      ),\n    );\n  }\n}",
      "_encoding": "utf-8"
    },
    "login_page.dart": {
      "_text": "// lib/login_page.dart\n\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/material.dart';\nimport 'package:onesignal_flutter/onesignal_flutter.dart';\nimport 'package:shared_preferences/shared_preferences.dart';\nimport 'admin/admin_bottom_nav.dart';\nimport 'careTaker/caretaker_bottom_nav.dart';\nimport 'register_page.dart';\nimport 'forgot_password_page.dart';\nimport 'user/user_bottom_nav.dart';\n\nclass LoginPage extends StatefulWidget {\n  final String role;\n  const LoginPage({Key? key, required this.role}) : super(key: key);\n\n  @override\n  State<LoginPage> createState() => _LoginPageState();\n}\n\nclass _LoginPageState extends State<LoginPage> {\n  final TextEditingController emailController = TextEditingController();\n  final TextEditingController passwordController = TextEditingController();\n  final _auth = FirebaseAuth.instance;\n  final _firestore = FirebaseFirestore.instance;\n  bool _loading = false;\n  bool _obscurePassword = true;\n\n  final _formKey = GlobalKey<FormState>();\n\n  @override\n  void dispose() {\n    emailController.dispose();\n    passwordController.dispose();\n    super.dispose();\n  }\n\n  Future<void> _login() async {\n    if (!_formKey.currentState!.validate()) return;\n    \n    setState(() => _loading = true);\n\n    try {\n      final credential = await _auth.signInWithEmailAndPassword(\n        email: emailController.text.trim(),\n        password: passwordController.text.trim(),\n      );\n      final uid = credential.user?.uid;\n      final email = credential.user?.email;\n\n      if (uid == null) {\n        if (mounted) {\n          _showErrorDialog('Login failed', 'Missing user ID. Please try again.');\n        }\n        return;\n      }\n\n      try {\n        await OneSignal.login(uid);\n      } catch (e) {\n        debugPrint('OneSignal login failed during login: $e');\n      }\n\n      DocumentSnapshot<Map<String, dynamic>> docByUid = await _firestore\n          .collection(widget.role)\n          .doc(uid)\n          .get();\n\n      Map<String, dynamic>? data;\n      DocumentReference<Map<String, dynamic>>? docRef;\n\n      if (docByUid.exists && docByUid.data() != null) {\n        data = docByUid.data();\n        docRef = _firestore.collection(widget.role).doc(uid);\n      } else {\n        // Fallback: try finding the document by email (useful for admin docs created manually)\n        if (email != null && email.isNotEmpty) {\n          final query = await _firestore\n              .collection(widget.role)\n              .where('email', isEqualTo: email)\n              .limit(1)\n              .get();\n\n          if (query.docs.isNotEmpty) {\n            final qdoc = query.docs.first;\n            data = qdoc.data();\n            docRef = qdoc.reference;\n\n            // Optional: store uid into that document to help future lookups\n            try {\n              await qdoc.reference.update({'uid': uid});\n            } catch (_) {\n              // ignore update errors\n            }\n          }\n        }\n      }\n\n      if (data == null || docRef == null) {\n        await _auth.signOut();\n        if (mounted) {\n          _showErrorDialog(\n            'Invalid Role', \n            'This account is not registered as a ${widget.role}. Please login with the correct role or contact support.'\n          );\n        }\n        return;\n      }\n\n      // Ban check\n      if (data['isBanned'] == true) {\n        await _auth.signOut();\n        if (mounted) {\n          _showErrorDialog(\n            'Account Banned',\n            'Your ${widget.role} account has been suspended by the Administrator. Please contact support for more information.'\n          );\n        }\n        return;\n      }\n\n      // Add OneSignal player id to the found document\n      try {\n        final playerId = OneSignal.User.pushSubscription.id;\n        if (playerId != null && playerId.isNotEmpty) {\n          await docRef.update({\n            'playerIds': FieldValue.arrayUnion([playerId]),\n          });\n        }\n      } catch (_) {\n        // If OneSignal call fails, ignore - don't block login\n      }\n\n      // Save role for auto-login\n      final prefs = await SharedPreferences.getInstance();\n      await prefs.setString('lastRole', widget.role);\n\n      if (mounted) {\n        _showSuccessDialog('Welcome Back!', 'Successfully logged in as ${widget.role}');\n        \n        // Navigate to the appropriate home screen and prevent going back\n        Widget targetScreen = const SizedBox();\n        \n        if (widget.role == 'user') {\n          targetScreen = const UserBottomNav();\n        } else if (widget.role == 'caretaker') {\n          targetScreen = const CareTaker();\n        } else {\n          targetScreen = const AdminBottomNav();\n        }\n        \n        // Use pushAndRemoveUntil to prevent going back to login\n        Navigator.pushAndRemoveUntil(\n          context,\n          MaterialPageRoute(builder: (context) => targetScreen),\n          (route) => false, // Remove all previous routes\n        );\n      }\n    } on FirebaseAuthException catch (e) {\n      if (mounted) {\n        String message = 'An error occurred during login.';\n        String title = 'Login Failed';\n        \n        switch (e.code) {\n          case 'user-not-found':\n            title = 'Account Not Found';\n            message = 'No account found with this email address. Please check your email or register for a new account.';\n            break;\n          case 'wrong-password':\n            title = 'Incorrect Password';\n            message = 'The password you entered is incorrect. Please try again or use \\\"Forgot Password\\\" to reset it.';\n            break;\n          case 'invalid-email':\n            title = 'Invalid Email';\n            message = 'The email address is not valid. Please check and try again.';\n            break;\n          case 'user-disabled':\n            title = 'Account Disabled';\n            message = 'This account has been disabled. Please contact support for assistance.';\n            break;\n          case 'too-many-requests':\n            title = 'Too Many Attempts';\n            message = 'Too many unsuccessful login attempts. Please try again later or reset your password.';\n            break;\n          default:\n            message = e.message ?? 'An unexpected error occurred. Please try again.';\n        }\n        \n        _showErrorDialog(title, message);\n      }\n    } catch (e) {\n      if (mounted) {\n        _showErrorDialog(\n          'Login Error',\n          'An unexpected error occurred. Please check your internet connection and try again.'\n        );\n      }\n    } finally {\n      setState(() => _loading = false);\n    }\n  }\n\n  void _showErrorDialog(String title, String message) {\n    showDialog(\n      context: context,\n      builder: (context) => AlertDialog(\n        title: Row(\n          children: [\n            Icon(Icons.error_outline, color: Colors.red.shade600),\n            const SizedBox(width: 8),\n            Text(title),\n          ],\n        ),\n        content: Text(message),\n        actions: [\n          TextButton(\n            onPressed: () => Navigator.pop(context),\n            child: const Text('OK'),\n          ),\n        ],\n      ),\n    );\n  }\n\n  void _showSuccessDialog(String title, String message) {\n    showDialog(\n      context: context,\n      builder: (context) => AlertDialog(\n        title: Row(\n          children: [\n            Icon(Icons.check_circle, color: Colors.green.shade600),\n            const SizedBox(width: 8),\n            Text(title),\n          ],\n        ),\n        content: Text(message),\n        actions: [\n          TextButton(\n            onPressed: () => Navigator.pop(context),\n            child: const Text('Continue'),\n          ),\n        ],\n      ),\n    );\n  }\n\n  void _goToRegister() {\n    Navigator.pushReplacement(\n      context,\n      MaterialPageRoute(builder: (context) => RegisterPage(role: widget.role)),\n    );\n  }\n\n  void _forgotPassword() {\n    Navigator.push(\n      context,\n      MaterialPageRoute(builder: (context) => const ForgotPasswordPage()),\n    );\n  }\n\n  String? _validateEmail(String? value) {\n    if (value == null || value.isEmpty) {\n      return 'Please enter your email address';\n    }\n    if (!RegExp(r'^[\\w-\\.]+@([\\w-]+\\.)+[\\w-]{2,4}$').hasMatch(value)) {\n      return 'Please enter a valid email address';\n    }\n    return null;\n  }\n\n  String? _validatePassword(String? value) {\n    if (value == null || value.isEmpty) {\n      return 'Please enter your password';\n    }\n    if (value.length < 6) {\n      return 'Password must be at least 6 characters long';\n    }\n    return null;\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final isAdmin = widget.role == 'admin';\n    final roleDisplayName = widget.role == 'caretaker' ? 'Caregiver' : widget.role;\n    \n    return Scaffold(\n      resizeToAvoidBottomInset: true,\n      body: Container(\n        decoration: const BoxDecoration(\n          gradient: LinearGradient(\n            colors: [\n              Colors.blueAccent,\n              Color(0xFF1976D2),\n              Color(0xFF0D47A1),\n            ],\n            begin: Alignment.topCenter,\n            end: Alignment.bottomCenter,\n          ),\n        ),\n        child: SafeArea(\n          child: Center(\n            child: SingleChildScrollView(\n              padding: const EdgeInsets.all(24.0),\n              child: Column(\n                crossAxisAlignment: CrossAxisAlignment.center,\n                children: [\n                  // Logo and Welcome Section\n                  Container(\n                    padding: const EdgeInsets.all(20),\n                    decoration: BoxDecoration(\n                      color: Colors.white.withOpacity(0.1),\n                      shape: BoxShape.circle,\n                    ),\n                    child: Icon(\n                      Icons.health_and_safety_outlined,\n                      size: 80,\n                      color: Colors.white,\n                    ),\n                  ),\n                  const SizedBox(height: 24),\n                  \n                  Text(\n                    'DVMA',\n                    style: TextStyle(\n                      fontSize: 32,\n                      fontWeight: FontWeight.bold,\n                      color: Colors.white,\n                      letterSpacing: 1.5,\n                    ),\n                  ),\n                  const SizedBox(height: 8),\n                  \n                  Text(\n                    'Digital Vision Monitoring Assistant',\n                    style: TextStyle(\n                      fontSize: 14,\n                      color: Colors.white.withOpacity(0.8),\n                      fontWeight: FontWeight.w300,\n                    ),\n                  ),\n                  const SizedBox(height: 32),\n\n                  // Login Card\n                  Container(\n                    width: double.infinity,\n                    padding: const EdgeInsets.all(32),\n                    decoration: BoxDecoration(\n                      color: Colors.white,\n                      borderRadius: BorderRadius.circular(24),\n                      boxShadow: [\n                        BoxShadow(\n                          color: Colors.black.withOpacity(0.1),\n                          blurRadius: 20,\n                          offset: const Offset(0, 10),\n                        ),\n                      ],\n                    ),\n                    child: Form(\n                      key: _formKey,\n                      child: Column(\n                        crossAxisAlignment: CrossAxisAlignment.start,\n                        children: [\n                          // Header\n                          Row(\n                            children: [\n                              Container(\n                                padding: const EdgeInsets.all(8),\n                                decoration: BoxDecoration(\n                                  color: Colors.blueAccent.withOpacity(0.1),\n                                  shape: BoxShape.circle,\n                                ),\n                                child: Icon(\n                                  Icons.lock_outline,\n                                  color: Colors.blueAccent,\n                                  size: 24,\n                                ),\n                              ),\n                              const SizedBox(width: 12),\n                              Expanded(\n                                child: Column(\n                                  crossAxisAlignment: CrossAxisAlignment.start,\n                                  children: [\n                                    Text(\n                                      '$roleDisplayName Login',\n                                      style: const TextStyle(\n                                        fontSize: 24,\n                                        fontWeight: FontWeight.bold,\n                                        color: Colors.blueAccent,\n                                      ),\n                                    ),\n                                    const SizedBox(height: 4),\n                                    Text(\n                                      'Welcome back! Please sign in to continue',\n                                      style: TextStyle(\n                                        fontSize: 14,\n                                        color: Colors.grey.shade600,\n                                      ),\n                                    ),\n                                  ],\n                                ),\n                              ),\n                            ],\n                          ),\n                          const SizedBox(height: 32),\n\n                          // Email Field\n                          Text(\n                            'Email Address',\n                            style: TextStyle(\n                              fontSize: 16,\n                              fontWeight: FontWeight.w500,\n                              color: Colors.grey.shade700,\n                            ),\n                          ),\n                          const SizedBox(height: 8),\n                          TextFormField(\n                            controller: emailController,\n                            keyboardType: TextInputType.emailAddress,\n                            validator: _validateEmail,\n                            style: TextStyle(\n                              fontSize: 16,\n                              color: Colors.grey.shade800,\n                            ),\n                            decoration: InputDecoration(\n                              hintText: 'Enter your email address',\n                              border: OutlineInputBorder(\n                                borderRadius: BorderRadius.circular(12),\n                                borderSide: BorderSide(color: Colors.grey.shade300),\n                              ),\n                              enabledBorder: OutlineInputBorder(\n                                borderRadius: BorderRadius.circular(12),\n                                borderSide: BorderSide(color: Colors.grey.shade300),\n                              ),\n                              focusedBorder: OutlineInputBorder(\n                                borderRadius: BorderRadius.circular(12),\n                                borderSide: const BorderSide(color: Colors.blueAccent, width: 2),\n                              ),\n                              errorBorder: OutlineInputBorder(\n                                borderRadius: BorderRadius.circular(12),\n                                borderSide: BorderSide(color: Colors.red.shade400),\n                              ),\n                              focusedErrorBorder: OutlineInputBorder(\n                                borderRadius: BorderRadius.circular(12),\n                                borderSide: BorderSide(color: Colors.red.shade400, width: 2),\n                              ),\n                              filled: true,\n                              fillColor: Colors.grey.shade50,\n                              prefixIcon: Icon(\n                                Icons.email_outlined,\n                                color: Colors.blueAccent,\n                              ),\n                              contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),\n                            ),\n                          ),\n                          const SizedBox(height: 20),\n\n                          // Password Field\n                          Text(\n                            'Password',\n                            style: TextStyle(\n                              fontSize: 16,\n                              fontWeight: FontWeight.w500,\n                              color: Colors.grey.shade700,\n                            ),\n                          ),\n                          const SizedBox(height: 8),\n                          TextFormField(\n                            controller: passwordController,\n                            obscureText: _obscurePassword,\n                            validator: _validatePassword,\n                            style: TextStyle(\n                              fontSize: 16,\n                              color: Colors.grey.shade800,\n                            ),\n                            decoration: InputDecoration(\n                              hintText: 'Enter your password',\n                              border: OutlineInputBorder(\n                                borderRadius: BorderRadius.circular(12),\n                                borderSide: BorderSide(color: Colors.grey.shade300),\n                              ),\n                              enabledBorder: OutlineInputBorder(\n                                borderRadius: BorderRadius.circular(12),\n                                borderSide: BorderSide(color: Colors.grey.shade300),\n                              ),\n                              focusedBorder: OutlineInputBorder(\n                                borderRadius: BorderRadius.circular(12),\n                                borderSide: const BorderSide(color: Colors.blueAccent, width: 2),\n                              ),\n                              errorBorder: OutlineInputBorder(\n                                borderRadius: BorderRadius.circular(12),\n                                borderSide: BorderSide(color: Colors.red.shade400),\n                              ),\n                              focusedErrorBorder: OutlineInputBorder(\n                                borderRadius: BorderRadius.circular(12),\n                                borderSide: BorderSide(color: Colors.red.shade400, width: 2),\n                              ),\n                              filled: true,\n                              fillColor: Colors.grey.shade50,\n                              prefixIcon: Icon(\n                                Icons.lock_outline,\n                                color: Colors.blueAccent,\n                              ),\n                              suffixIcon: IconButton(\n                                icon: Icon(\n                                  _obscurePassword ? Icons.visibility_off_outlined : Icons.visibility_outlined,\n                                  color: Colors.grey.shade500,\n                                ),\n                                onPressed: () {\n                                  setState(() => _obscurePassword = !_obscurePassword);\n                                },\n                              ),\n                              contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),\n                            ),\n                          ),\n                          const SizedBox(height: 8),\n\n                          // Forgot Password\n                          Align(\n                            alignment: Alignment.centerRight,\n                            child: TextButton(\n                              onPressed: _forgotPassword,\n                              style: TextButton.styleFrom(\n                                padding: EdgeInsets.zero,\n                                tapTargetSize: MaterialTapTargetSize.shrinkWrap,\n                              ),\n                              child: Text(\n                                'Forgot Password?',\n                                style: TextStyle(\n                                  color: Colors.blueAccent,\n                                  fontWeight: FontWeight.w500,\n                                ),\n                              ),\n                            ),\n                          ),\n                          const SizedBox(height: 24),\n\n                          // Login Button\n                          _loading\n                              ? Container(\n                                  height: 56,\n                                  decoration: BoxDecoration(\n                                    color: Colors.blueAccent,\n                                    borderRadius: BorderRadius.circular(12),\n                                  ),\n                                  child: const Center(\n                                    child: SizedBox(\n                                      width: 20,\n                                      height: 20,\n                                      child: CircularProgressIndicator(\n                                        strokeWidth: 2,\n                                        valueColor: AlwaysStoppedAnimation<Color>(Colors.white),\n                                      ),\n                                    ),\n                                  ),\n                                )\n                              : ElevatedButton(\n                                  onPressed: _login,\n                                  style: ElevatedButton.styleFrom(\n                                    backgroundColor: Colors.blueAccent,\n                                    padding: const EdgeInsets.symmetric(vertical: 16),\n                                    shape: RoundedRectangleBorder(\n                                      borderRadius: BorderRadius.circular(12),\n                                    ),\n                                    elevation: 2,\n                                    minimumSize: const Size(double.infinity, 56),\n                                  ),\n                                  child: Row(\n                                    mainAxisAlignment: MainAxisAlignment.center,\n                                    children: [\n                                      Text(\n                                        'Sign In as $roleDisplayName',\n                                        style: const TextStyle(\n                                          fontSize: 16,\n                                          fontWeight: FontWeight.w600,\n                                          color: Colors.white,\n                                        ),\n                                      ),\n                                      const SizedBox(width: 8),\n                                      Icon(Icons.arrow_forward, size: 20),\n                                    ],\n                                  ),\n                                ),\n                          const SizedBox(height: 16),\n\n                          // Register Link\n                          if (!isAdmin)\n                            Row(\n                              mainAxisAlignment: MainAxisAlignment.center,\n                              children: [\n                                Text(\n                                  \"Don't have an account?\",\n                                  style: TextStyle(\n                                    color: Colors.grey.shade600,\n                                  ),\n                                ),\n                                const SizedBox(width: 4),\n                                TextButton(\n                                  onPressed: _goToRegister,\n                                  style: TextButton.styleFrom(\n                                    padding: EdgeInsets.zero,\n                                    tapTargetSize: MaterialTapTargetSize.shrinkWrap,\n                                  ),\n                                  child: Text(\n                                    'Sign up here',\n                                    style: TextStyle(\n                                      color: Colors.blueAccent,\n                                      fontWeight: FontWeight.w600,\n                                    ),\n                                  ),\n                                ),\n                              ],\n                            ),\n                        ],\n                      ),\n                    ),\n                  ),\n\n                  // Footer\n                  const SizedBox(height: 32),\n                  Text(\n                    'Secure Login • Protected by Firebase',\n                    style: TextStyle(\n                      fontSize: 12,\n                      color: Colors.white.withOpacity(0.7),\n                    ),\n                  ),\n                ],\n              ),\n            ),\n          ),\n        ),\n      ),\n    );\n  }\n}",
      "_encoding": "utf-8"
    },
    "main.dart": {
      "_text": "import 'package:firebase_auth/firebase_auth.dart';\nimport 'package:firebase_core/firebase_core.dart';\nimport 'package:flutter/material.dart';\nimport 'package:flutter_dotenv/flutter_dotenv.dart';\nimport 'package:flutter_gemini/flutter_gemini.dart';\nimport 'package:onesignal_flutter/onesignal_flutter.dart';\nimport 'package:shared_preferences/shared_preferences.dart';\nimport 'firebase_options.dart';\nimport 'welcome_page.dart';\nimport 'user/user_bottom_nav.dart';\nimport 'careTaker/caretaker_bottom_nav.dart';\nimport 'admin/admin_bottom_nav.dart';\n\nvoid main() async {\n  WidgetsFlutterBinding.ensureInitialized();\n  \n  await dotenv.load(fileName: \".env\");\n  \n  await Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);\n  \n  final oneSignalAppId = \"73673a14-2de9-44c4-a9c5-dd531da39b59\"; \n     OneSignal.initialize(oneSignalAppId);\n     OneSignal.Notifications.requestPermission(true);\n\n  final geminiApiKey = \"hhjkljouhnlj\";\n    Gemini.init(apiKey: geminiApiKey);\n\n  final prefs = await SharedPreferences.getInstance();\n  final user = FirebaseAuth.instance.currentUser;\n  Widget initialScreen = const WelcomePage();\n\n  if (user != null) {\n    try {\n      await OneSignal.login(user.uid);\n    } catch (e) {\n      debugPrint('OneSignal login failed in main: $e');\n    }\n  \n    final role = prefs.getString('lastRole') ?? 'user';\n    if (role == 'user') {\n      initialScreen = const UserBottomNav();\n    } else if (role == 'caretaker') {\n      initialScreen = const CareTaker();\n    } else if (role == 'admin') {\n      initialScreen = const AdminBottomNav();\n    }\n  }\n\n  runApp(MyApp(initialScreen: initialScreen));\n}\n\nclass MyApp extends StatelessWidget {\n  final Widget initialScreen;\n\n  const MyApp({super.key, required this.initialScreen});\n\n  @override\n  Widget build(BuildContext context) {\n    return MaterialApp(\n      title: 'DVMA',\n      debugShowCheckedModeBanner: false,\n      theme: ThemeData(\n        colorScheme: ColorScheme.fromSeed(seedColor: Colors.blueAccent),\n      ),\n      home: initialScreen,\n    );\n  }\n}",
      "_encoding": "utf-8"
    },
    "register_page.dart": {
      "_text": "import 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/material.dart';\nimport 'package:onesignal_flutter/onesignal_flutter.dart';\nimport 'package:image_picker/image_picker.dart';\nimport 'package:flutter_dotenv/flutter_dotenv.dart';\nimport 'dart:convert';\nimport 'package:http/http.dart' as http;\nimport 'package:shared_preferences/shared_preferences.dart';\n\nimport 'careTaker/caretaker_bottom_nav.dart';\nimport 'user/user_bottom_nav.dart';\n\nenum CaregiverType { relative, nurse }\nenum UserGender { male, female, other }\nenum FormSection { personal, address, caretaker, review }\n\nclass RegisterPage extends StatefulWidget {\n  final String role;\n  const RegisterPage({super.key, required this.role});\n\n  @override\n  State<RegisterPage> createState() => _RegisterPageState();\n}\n\nclass _RegisterPageState extends State<RegisterPage> {\n  final TextEditingController nameController = TextEditingController();\n  final TextEditingController usernameController = TextEditingController();\n  final TextEditingController emailController = TextEditingController();\n  final TextEditingController passwordController = TextEditingController();\n  final TextEditingController phoneController = TextEditingController();\n  final TextEditingController bioController = TextEditingController();\n  final TextEditingController localityController = TextEditingController();\n  final TextEditingController cityController = TextEditingController();\n  final TextEditingController stateController = TextEditingController();\n  final TextEditingController experienceYearsController = TextEditingController();\n  final TextEditingController relationController = TextEditingController();\n  final TextEditingController expBioController = TextEditingController();\n  final TextEditingController gradNursingController = TextEditingController();\n\n  final _auth = FirebaseAuth.instance;\n  final _firestore = FirebaseFirestore.instance;\n  bool _loading = false;\n\n  CaregiverType _caregiverType = CaregiverType.relative;\n  UserGender _selectedGender = UserGender.male;\n  DateTime? _selectedDOB;\n  String? _selectedProfileImagePath;\n  String? _selectedCertificatePath;\n\n  FormSection _currentSection = FormSection.personal;\n\n  final ImagePicker _picker = ImagePicker();\n\n  // Default profile image URL\n  static const String defaultProfileImageUrl = \n      'https://res.cloudinary.com/dts8hgf4f/image/upload/v1758882470/user_jvnx80.png';\n\n  @override\n  void dispose() {\n    nameController.dispose();\n    usernameController.dispose();\n    emailController.dispose();\n    passwordController.dispose();\n    phoneController.dispose();\n    experienceYearsController.dispose();\n    relationController.dispose();\n    bioController.dispose();\n    localityController.dispose();\n    cityController.dispose();\n    stateController.dispose();\n    expBioController.dispose();\n    gradNursingController.dispose();\n    super.dispose();\n  }\n\n  void _nextSection() {\n    if (!_validateCurrentSection()) return;\n\n    setState(() {\n      switch (_currentSection) {\n        case FormSection.personal:\n          _currentSection = FormSection.address;\n          break;\n        case FormSection.address:\n          if (widget.role == 'caretaker') {\n            _currentSection = FormSection.caretaker;\n          } else {\n            _currentSection = FormSection.review;\n          }\n          break;\n        case FormSection.caretaker:\n          _currentSection = FormSection.review;\n          break;\n        case FormSection.review:\n          _register();\n          break;\n      }\n    });\n  }\n\n  void _previousSection() {\n    setState(() {\n      switch (_currentSection) {\n        case FormSection.address:\n          _currentSection = FormSection.personal;\n          break;\n        case FormSection.caretaker:\n          _currentSection = FormSection.address;\n          break;\n        case FormSection.review:\n          if (widget.role == 'caretaker') {\n            _currentSection = FormSection.caretaker;\n          } else {\n            _currentSection = FormSection.address;\n          }\n          break;\n        case FormSection.personal:\n          break;\n      }\n    });\n  }\n\n  bool _validateCurrentSection() {\n    switch (_currentSection) {\n      case FormSection.personal:\n        if (nameController.text.trim().isEmpty) {\n          _showErrorDialog('Full Name is required');\n          return false;\n        }\n        if (usernameController.text.trim().isEmpty) {\n          _showErrorDialog('Username is required');\n          return false;\n        }\n        if (emailController.text.trim().isEmpty) {\n          _showErrorDialog('Email is required');\n          return false;\n        }\n        if (!RegExp(r'^[\\w-\\.]+@([\\w-]+\\.)+[\\w-]{2,4}$').hasMatch(emailController.text.trim())) {\n          _showErrorDialog('Please enter a valid email address');\n          return false;\n        }\n        if (passwordController.text.trim().isEmpty) {\n          _showErrorDialog('Password is required');\n          return false;\n        }\n        if (passwordController.text.length < 6) {\n          _showErrorDialog('Password must be at least 6 characters long');\n          return false;\n        }\n        if (phoneController.text.trim().isEmpty) {\n          _showErrorDialog('Phone number is required');\n          return false;\n        }\n        if (_selectedDOB == null) {\n          _showErrorDialog('Date of Birth is required');\n          return false;\n        }\n        return true;\n      case FormSection.address:\n        if (bioController.text.trim().isEmpty) {\n          _showErrorDialog('Bio is required');\n          return false;\n        }\n        if (localityController.text.trim().isEmpty) {\n          _showErrorDialog('Locality is required');\n          return false;\n        }\n        if (cityController.text.trim().isEmpty) {\n          _showErrorDialog('City is required');\n          return false;\n        }\n        if (stateController.text.trim().isEmpty) {\n          _showErrorDialog('State is required');\n          return false;\n        }\n        return true;\n      case FormSection.caretaker:\n        if (_caregiverType == CaregiverType.relative) {\n          if (relationController.text.trim().isEmpty) {\n            _showErrorDialog('Please enter your relation to the patient');\n            return false;\n          }\n        } else if (_caregiverType == CaregiverType.nurse) {\n          if (experienceYearsController.text.trim().isEmpty) {\n            _showErrorDialog('Experience years is required for nurses');\n            return false;\n          }\n          if (expBioController.text.trim().isEmpty) {\n            _showErrorDialog('Experience bio is required for nurses');\n            return false;\n          }\n          if (gradNursingController.text.trim().isEmpty) {\n            _showErrorDialog('Nursing qualification is required for nurses');\n            return false;\n          }\n          // Certificate validation for nurses\n          if (_selectedCertificatePath == null) {\n            _showErrorDialog('Graduation certificate is required for nurse registration');\n            return false;\n          }\n        }\n        return true;\n      case FormSection.review:\n        return true;\n    }\n  }\n\n  void _showErrorDialog(String message) {\n    showDialog(\n      context: context,\n      builder: (context) => AlertDialog(\n        title: const Row(\n          children: [\n            Icon(Icons.error_outline, color: Colors.red),\n            SizedBox(width: 8),\n            Text('Validation Error'),\n          ],\n        ),\n        content: Text(message),\n        actions: [\n          TextButton(\n            onPressed: () => Navigator.pop(context),\n            child: const Text('OK'),\n          ),\n        ],\n      ),\n    );\n  }\n\n  void _showSuccessDialog(String message) {\n    showDialog(\n      context: context,\n      builder: (context) => AlertDialog(\n        title: const Row(\n          children: [\n            Icon(Icons.check_circle, color: Colors.green),\n            SizedBox(width: 8),\n            Text('Success'),\n          ],\n        ),\n        content: Text(message),\n        actions: [\n          TextButton(\n            onPressed: () => Navigator.pop(context),\n            child: const Text('OK'),\n          ),\n        ],\n      ),\n    );\n  }\n\n  Future<void> _selectDate(BuildContext context) async {\n    final DateTime? picked = await showDatePicker(\n      context: context,\n      initialDate: _selectedDOB ?? DateTime(2000),\n      firstDate: DateTime(1900),\n      lastDate: DateTime.now(),\n      builder: (context, child) {\n        return Theme(\n          data: ThemeData.light().copyWith(\n            colorScheme: const ColorScheme.light(\n              primary: Colors.blueAccent,\n              onPrimary: Colors.white,\n              onSurface: Colors.black,\n            ),\n            dialogBackgroundColor: Colors.white,\n          ),\n          child: child!,\n        );\n      },\n    );\n    if (picked != null && picked != _selectedDOB) {\n      setState(() {\n        _selectedDOB = picked;\n      });\n    }\n  }\n\n  void _pickProfileImage() async {\n    final XFile? image = await _picker.pickImage(source: ImageSource.gallery);\n    if (image != null) {\n      setState(() {\n        _selectedProfileImagePath = image.path;\n      });\n    }\n  }\n\n  void _pickCertificate() async {\n    final XFile? image = await _picker.pickImage(source: ImageSource.gallery);\n    if (image != null) {\n      setState(() {\n        _selectedCertificatePath = image.path;\n      });\n    }\n  }\n\n  // Cloudinary upload logic\n  Future<String?> _uploadFile(String? filePath, String preset) async {\n    if (filePath == null) return null;\n\n    final cloudName = dotenv.env['CLOUDINARY_CLOUD_NAME'];\n\n    if (cloudName == null || cloudName.isEmpty) {\n      if (mounted) {\n        _showErrorDialog('Cloudinary configuration error. Please try again later.');\n      }\n      return null;\n    }\n\n    try {\n      final uri = Uri.parse(\n        'https://api.cloudinary.com/v1_1/$cloudName/image/upload',\n      );\n\n      var request = http.MultipartRequest('POST', uri)\n        ..fields['upload_preset'] = preset\n        ..fields['cloud_name'] = cloudName;\n\n      final file = await http.MultipartFile.fromPath('file', filePath);\n      request.files.add(file);\n\n      final streamedResponse = await request.send();\n      final response = await http.Response.fromStream(streamedResponse);\n\n      if (response.statusCode == 200) {\n        final responseData = json.decode(response.body);\n        final secureUrl = responseData['secure_url'];\n\n        if (secureUrl is String && secureUrl.isNotEmpty) return secureUrl;\n        return null;\n      } else {\n        return null;\n      }\n    } catch (e) {\n      return null;\n    }\n  }\n\n  Future<void> _register() async {\n    setState(() => _loading = true);\n    String? profileUrl;\n    String? certificateUrl;\n\n    try {\n      final username = usernameController.text.trim();\n      final email = emailController.text.trim();\n      final phone = phoneController.text.trim();\n\n      // Check for existing username\n      final snapUsername = await _firestore\n          .collection(widget.role)\n          .where('username', isEqualTo: username)\n          .get();\n      if (snapUsername.docs.isNotEmpty) {\n        throw 'Username \"$username\" is already taken. Please choose a different username.';\n      }\n\n      // Check for existing email\n      final snapEmail = await _firestore\n          .collection(widget.role)\n          .where('email', isEqualTo: email)\n          .get();\n      if (snapEmail.docs.isNotEmpty) {\n        throw 'Email \"$email\" is already registered. Please use a different email or try logging in.';\n      }\n\n      // Upload profile image or use default\n      if (_selectedProfileImagePath != null) {\n        profileUrl = await _uploadFile(\n          _selectedProfileImagePath,\n          'care_taker_image',\n        );\n      } else {\n        profileUrl = defaultProfileImageUrl;\n      }\n\n      // Upload certificate for nurses\n      if (widget.role == 'caretaker' && _caregiverType == CaregiverType.nurse) {\n        certificateUrl = await _uploadFile(\n          _selectedCertificatePath,\n          'graduation',\n        );\n        \n        if (certificateUrl == null) {\n          throw 'Failed to upload graduation certificate. Please try again.';\n        }\n      }\n\n      final credential = await _auth.createUserWithEmailAndPassword(\n        email: email,\n        password: passwordController.text.trim(),\n      );\n      final uid = credential.user?.uid;\n\n      if (uid != null) {\n        try {\n          OneSignal.login(uid);\n        } catch (e) {\n          debugPrint('OneSignal login failed during registration: $e');\n        }\n\n        Map<String, dynamic> data = {\n          'uid': uid,\n          'fullName': nameController.text.trim(),\n          'username': username,\n          'email': email,\n          'phoneNo': phone,\n          'createdAt': Timestamp.now(),\n          'gender': _selectedGender.name,\n          'dateOfBirth': Timestamp.fromDate(_selectedDOB!),\n          'bio': bioController.text.trim(),\n          'locality': localityController.text.trim(),\n          'city': cityController.text.trim(),\n          'state': stateController.text.trim(),\n          'profileImageUrl': profileUrl!,\n          'isConnected': false,\n          'currentConnectionId': null,\n          'emergencyContacts': [],\n          'members': [],\n          'reports_sent': [],\n          'playerIds': [],\n          'isBanned': false,\n        };\n\n        if (widget.role == 'caretaker') {\n          data['caregiverType'] = _caregiverType.name;\n\n          if (_caregiverType == CaregiverType.relative) {\n            data['relation'] = relationController.text.trim();\n            data['experienceYears'] = 0;\n            data['experienceBio'] = '';\n            data['graduationOnNursing'] = '';\n            data['graduationCertificateUrl'] = '';\n          } else {\n            data['experienceYears'] =\n                int.tryParse(experienceYearsController.text.trim()) ?? 0;\n            data['relation'] = '';\n            data['experienceBio'] = expBioController.text.trim();\n            data['graduationOnNursing'] = gradNursingController.text.trim();\n            data['graduationCertificateUrl'] = certificateUrl ?? '';\n          }\n\n          data.addAll({'isApprove': false, 'roadmap': []});\n        }\n\n        await _firestore.collection(widget.role).doc(uid).set(data);\n\n        // Add player ID\n        final playerId = OneSignal.User.pushSubscription.id;\n        if (playerId != null) {\n          await _firestore.collection(widget.role).doc(uid).update({\n            'playerIds': FieldValue.arrayUnion([playerId]),\n          });\n        }\n\n        // Save role to shared preferences\n        final prefs = await SharedPreferences.getInstance();\n        await prefs.setString('lastRole', widget.role);\n\n        if (mounted) {\n          _showSuccessDialog('Registration successful! Welcome to DVMA.');\n          \n          Widget targetScreen = const SizedBox(); \n          \n          if (widget.role == 'user') {\n            targetScreen = const UserBottomNav();\n          } else if (widget.role == 'caretaker') {\n            targetScreen = const CareTaker();\n          }\n          \n          Navigator.pushAndRemoveUntil(\n            context,\n            MaterialPageRoute(builder: (context) => targetScreen),\n            (route) => false,\n          );\n        }\n      }\n    } catch (e) {\n      if (mounted) {\n        String message = 'Registration failed. Please try again.';\n        \n        if (e is FirebaseAuthException) {\n          switch (e.code) {\n            case 'email-already-in-use':\n              message = 'This email is already registered. Please use a different email or try logging in.';\n              break;\n            case 'weak-password':\n              message = 'Password is too weak. Please choose a stronger password.';\n              break;\n            case 'invalid-email':\n              message = 'The email address is invalid. Please check and try again.';\n              break;\n            case 'operation-not-allowed':\n              message = 'Email/password accounts are not enabled. Please contact support.';\n              break;\n            default:\n              message = 'Authentication error: ${e.message}';\n          }\n        } else if (e is String) {\n          message = e;\n        }\n        \n        _showErrorDialog(message);\n      }\n    } finally {\n      setState(() => _loading = false);\n    }\n  }\n\n  Widget _buildFilePicker({\n    required String label,\n    required VoidCallback onTap,\n    required bool isSelected,\n    required IconData icon,\n    bool isRequired = false,\n  }) {\n    return Container(\n      margin: const EdgeInsets.only(bottom: 16),\n      decoration: BoxDecoration(\n        borderRadius: BorderRadius.circular(12),\n        border: Border.all(\n          color: isSelected ? Colors.green : Colors.grey.shade300,\n          width: isSelected ? 2 : 1,\n        ),\n        color: isSelected ? Colors.green.withOpacity(0.05) : Colors.white,\n      ),\n      child: InkWell(\n        onTap: onTap,\n        borderRadius: BorderRadius.circular(12),\n        child: Padding(\n          padding: const EdgeInsets.all(16),\n          child: Row(\n            children: [\n              Container(\n                padding: const EdgeInsets.all(8),\n                decoration: BoxDecoration(\n                  color: isSelected ? Colors.green : Colors.blueAccent.withOpacity(0.1),\n                  shape: BoxShape.circle,\n                ),\n                child: Icon(\n                  icon,\n                  color: isSelected ? Colors.white : Colors.blueAccent,\n                  size: 20,\n                ),\n              ),\n              const SizedBox(width: 12),\n              Expanded(\n                child: Column(\n                  crossAxisAlignment: CrossAxisAlignment.start,\n                  children: [\n                    Text(\n                      isRequired ? '$label *' : label,\n                      style: TextStyle(\n                        fontSize: 16,\n                        fontWeight: FontWeight.w500,\n                        color: Colors.grey.shade700,\n                      ),\n                    ),\n                    const SizedBox(height: 4),\n                    Text(\n                      isSelected ? 'File selected ✓' : 'Tap to select file',\n                      style: TextStyle(\n                        fontSize: 14,\n                        color: isSelected ? Colors.green : Colors.grey.shade500,\n                      ),\n                    ),\n                  ],\n                ),\n              ),\n              Icon(\n                isSelected ? Icons.check_circle : Icons.arrow_forward_ios,\n                color: isSelected ? Colors.green : Colors.grey.shade400,\n                size: 20,\n              ),\n            ],\n          ),\n        ),\n      ),\n    );\n  }\n\n  Widget _buildRadio(CaregiverType value, String title, String description) {\n    return Container(\n      margin: const EdgeInsets.only(bottom: 12),\n      decoration: BoxDecoration(\n        borderRadius: BorderRadius.circular(12),\n        border: Border.all(\n          color: _caregiverType == value ? Colors.blueAccent : Colors.grey.shade300,\n          width: _caregiverType == value ? 2 : 1,\n        ),\n        color: _caregiverType == value ? Colors.blueAccent.withOpacity(0.05) : Colors.white,\n      ),\n      child: ListTile(\n        contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),\n        leading: Radio<CaregiverType>(\n          value: value,\n          groupValue: _caregiverType,\n          onChanged: (CaregiverType? selectedValue) {\n            setState(() {\n              _caregiverType = selectedValue!;\n            });\n          },\n          activeColor: Colors.blueAccent,\n        ),\n        title: Text(\n          title,\n          style: TextStyle(\n            fontWeight: FontWeight.w600,\n            color: Colors.grey.shade800,\n          ),\n        ),\n        subtitle: Text(\n          description,\n          style: TextStyle(\n            fontSize: 12,\n            color: Colors.grey.shade600,\n          ),\n        ),\n      ),\n    );\n  }\n\n  Widget _buildGenderChip(UserGender value, String title) {\n    final isSelected = _selectedGender == value;\n    return ChoiceChip(\n      label: Text(title),\n      selected: isSelected,\n      onSelected: (selected) {\n        setState(() {\n          _selectedGender = value;\n        });\n      },\n      selectedColor: Colors.blueAccent,\n      labelStyle: TextStyle(\n        color: isSelected ? Colors.white : Colors.grey.shade700,\n        fontWeight: FontWeight.w500,\n      ),\n      backgroundColor: Colors.grey.shade100,\n      padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 12),\n      shape: RoundedRectangleBorder(\n        borderRadius: BorderRadius.circular(20),\n      ),\n    );\n  }\n\n  // Progress indicator\n  Widget _buildProgressIndicator() {\n    final sections = widget.role == 'caretaker'\n        ? ['Personal', 'Address', 'Caretaker', 'Review']\n        : ['Personal', 'Address', 'Review'];\n    \n    final currentIndex = _currentSection.index;\n    final totalSections = sections.length;\n\n    return Column(\n      children: [\n        // Progress bar with percentage\n        Stack(\n          children: [\n            LinearProgressIndicator(\n              value: (currentIndex + 1) / totalSections,\n              backgroundColor: Colors.grey.shade200,\n              color: Colors.blueAccent,\n              borderRadius: BorderRadius.circular(10),\n              minHeight: 8,\n            ),\n            Positioned(\n              right: 0,\n              child: Text(\n                '${((currentIndex + 1) / totalSections * 100).round()}%',\n                style: const TextStyle(\n                  fontSize: 12,\n                  fontWeight: FontWeight.bold,\n                  color: Colors.blueAccent,\n                ),\n              ),\n            ),\n          ],\n        ),\n        const SizedBox(height: 20),\n        // Section labels\n        Row(\n          mainAxisAlignment: MainAxisAlignment.spaceBetween,\n          children: sections.asMap().entries.map((entry) {\n            final index = entry.key;\n            final section = entry.value;\n            final isActive = index <= currentIndex;\n            final isCurrent = index == currentIndex;\n            \n            return Expanded(\n              child: Column(\n                children: [\n                  Container(\n                    width: 36,\n                    height: 36,\n                    decoration: BoxDecoration(\n                      color: isActive ? Colors.blueAccent : Colors.grey.shade300,\n                      shape: BoxShape.circle,\n                      border: isCurrent ? Border.all(color: Colors.blueAccent, width: 3) : null,\n                    ),\n                    child: Center(\n                      child: Icon(\n                        isActive ? Icons.check : Icons.circle,\n                        color: isActive ? Colors.white : Colors.grey.shade600,\n                        size: isActive ? 18 : 16,\n                      ),\n                    ),\n                  ),\n                  const SizedBox(height: 8),\n                  Text(\n                    section,\n                    textAlign: TextAlign.center,\n                    style: TextStyle(\n                      fontSize: 12,\n                      fontWeight: isCurrent ? FontWeight.bold : FontWeight.normal,\n                      color: isCurrent ? Colors.blueAccent : Colors.grey.shade600,\n                    ),\n                  ),\n                ],\n              ),\n            );\n          }).toList(),\n        ),\n        const SizedBox(height: 24),\n      ],\n    );\n  }\n\n  // Personal Information Section\n  Widget _buildPersonalSection() {\n    return Column(\n      crossAxisAlignment: CrossAxisAlignment.start,\n      children: [\n        _buildSectionHeader(\n          title: 'Personal Information',\n          subtitle: 'Tell us about yourself',\n          icon: Icons.person_outline,\n        ),\n        const SizedBox(height: 24),\n        _buildTextField(nameController, 'Full Name', Icons.person),\n        _buildTextField(usernameController, 'Username', Icons.alternate_email),\n        _buildTextField(emailController, 'Email Address', Icons.email_outlined),\n        _buildTextField(\n          passwordController,\n          'Password',\n          Icons.lock_outline,\n          obscureText: true,\n        ),\n        _buildTextField(\n          phoneController,\n          'Phone Number',\n          Icons.phone_iphone,\n          keyboardType: TextInputType.phone,\n        ),\n\n        // Profile Image Upload\n        _buildFilePicker(\n          label: 'Profile Image',\n          onTap: _pickProfileImage,\n          isSelected: _selectedProfileImagePath != null,\n          icon: Icons.camera_alt,\n        ),\n        Padding(\n          padding: const EdgeInsets.only(bottom: 16),\n          child: Row(\n            children: [\n              Icon(Icons.info_outline, color: Colors.blueAccent, size: 16),\n              const SizedBox(width: 8),\n              Expanded(\n                child: Text(\n                  'Optional - Default image will be used if not selected',\n                  style: TextStyle(\n                    fontSize: 12,\n                    color: Colors.grey.shade600,\n                  ),\n                ),\n              ),\n            ],\n          ),\n        ),\n\n        // Gender Selection\n        const SizedBox(height: 8),\n        Text(\n          'Gender *',\n          style: TextStyle(\n            fontSize: 16,\n            fontWeight: FontWeight.w500,\n            color: Colors.grey.shade700,\n          ),\n        ),\n        const SizedBox(height: 12),\n        Row(\n          mainAxisAlignment: MainAxisAlignment.start,\n          children: [\n            _buildGenderChip(UserGender.male, 'Male'),\n            const SizedBox(width: 12),\n            _buildGenderChip(UserGender.female, 'Female'),\n            const SizedBox(width: 12),\n            _buildGenderChip(UserGender.other, 'Other'),\n          ],\n        ),\n\n        // Date of Birth Picker\n        const SizedBox(height: 16),\n        Text(\n          'Date of Birth *',\n          style: TextStyle(\n            fontSize: 16,\n            fontWeight: FontWeight.w500,\n            color: Colors.grey.shade700,\n          ),\n        ),\n        const SizedBox(height: 8),\n        InkWell(\n          onTap: () => _selectDate(context),\n          borderRadius: BorderRadius.circular(12),\n          child: Container(\n            width: double.infinity,\n            padding: const EdgeInsets.all(16),\n            decoration: BoxDecoration(\n              borderRadius: BorderRadius.circular(12),\n              border: Border.all(color: Colors.grey.shade300),\n              color: Colors.white,\n            ),\n            child: Row(\n              children: [\n                Icon(Icons.calendar_today, color: Colors.blueAccent, size: 20),\n                const SizedBox(width: 12),\n                Text(\n                  _selectedDOB == null\n                      ? 'Select your date of birth'\n                      : '${_selectedDOB!.day}/${_selectedDOB!.month}/${_selectedDOB!.year}',\n                  style: TextStyle(\n                    fontSize: 16,\n                    color: _selectedDOB == null ? Colors.grey.shade500 : Colors.grey.shade800,\n                  ),\n                ),\n                const Spacer(),\n                Icon(Icons.arrow_drop_down, color: Colors.grey.shade500),\n              ],\n            ),\n          ),\n        ),\n      ],\n    );\n  }\n\n  // Address Section\n  Widget _buildAddressSection() {\n    return Column(\n      crossAxisAlignment: CrossAxisAlignment.start,\n      children: [\n        _buildSectionHeader(\n          title: 'Address Information',\n          subtitle: 'Where are you located?',\n          icon: Icons.location_on_outlined,\n        ),\n        const SizedBox(height: 24),\n        _buildTextField(\n          bioController,\n          'Bio',\n          Icons.description_outlined,\n          maxLines: 3,\n        ),\n        _buildTextField(localityController, 'Locality/Area', Icons.location_on_outlined),\n        _buildTextField(cityController, 'City', Icons.location_city_outlined),\n        _buildTextField(stateController, 'State', Icons.public_outlined),\n      ],\n    );\n  }\n\n  // Caretaker Section\n  Widget _buildCaretakerSection() {\n    return Column(\n      crossAxisAlignment: CrossAxisAlignment.start,\n      children: [\n        _buildSectionHeader(\n          title: 'Caretaker Details',\n          subtitle: 'Tell us about your caregiving experience',\n          icon: Icons.medical_services_outlined,\n        ),\n        const SizedBox(height: 24),\n\n        // Caregiver Type Selection\n        Text(\n          'I am registering as a: *',\n          style: TextStyle(\n            fontSize: 16,\n            fontWeight: FontWeight.w500,\n            color: Colors.grey.shade700,\n          ),\n        ),\n        const SizedBox(height: 12),\n        _buildRadio(\n          CaregiverType.relative,\n          'Family Relative',\n          'Caring for a family member or relative',\n        ),\n        _buildRadio(\n          CaregiverType.nurse,\n          'Professional Nurse',\n          'Registered nurse with professional qualifications',\n        ),\n        const SizedBox(height: 16),\n\n        // Conditional Input Fields\n        if (_caregiverType == CaregiverType.relative) ...[\n          _buildTextField(\n            relationController,\n            'Relation to Patient',\n            Icons.family_restroom_outlined,\n          ),\n        ] else ...[\n          _buildTextField(\n            experienceYearsController,\n            'Years of Experience',\n            Icons.work_history_outlined,\n            keyboardType: TextInputType.number,\n          ),\n          _buildTextField(\n            expBioController,\n            'Professional Experience',\n            Icons.description_outlined,\n            maxLines: 3,\n          ),\n          _buildTextField(\n            gradNursingController,\n            'Nursing Qualification',\n            Icons.school_outlined,\n          ),\n          _buildFilePicker(\n            label: 'Graduation Certificate',\n            onTap: _pickCertificate,\n            isSelected: _selectedCertificatePath != null,\n            icon: Icons.assignment_outlined,\n            isRequired: true,\n          ),\n          Padding(\n            padding: const EdgeInsets.only(bottom: 16),\n            child: Row(\n              children: [\n                Icon(Icons.warning_amber_outlined, color: Colors.orange, size: 16),\n                const SizedBox(width: 8),\n                Expanded(\n                  child: Text(\n                    'Graduation certificate is required for nurse registration',\n                    style: TextStyle(\n                      fontSize: 12,\n                      color: Colors.orange.shade700,\n                    ),\n                  ),\n                ),\n              ],\n            ),\n          ),\n        ],\n      ],\n    );\n  }\n\n  // Review Section\n  Widget _buildReviewSection() {\n    return Column(\n      crossAxisAlignment: CrossAxisAlignment.start,\n      children: [\n        _buildSectionHeader(\n          title: 'Review Information',\n          subtitle: 'Please verify all details before submitting',\n          icon: Icons.verified_user_outlined,\n        ),\n        const SizedBox(height: 24),\n        \n        // Personal Info Review\n        _buildReviewSectionTitle('Personal Information'),\n        _buildReviewItem('Full Name', nameController.text),\n        _buildReviewItem('Username', usernameController.text),\n        _buildReviewItem('Email', emailController.text),\n        _buildReviewItem('Phone', phoneController.text),\n        _buildReviewItem('Gender', _selectedGender.name.toUpperCase()),\n        _buildReviewItem('Date of Birth', \n          _selectedDOB != null \n            ? '${_selectedDOB!.day}/${_selectedDOB!.month}/${_selectedDOB!.year}'\n            : 'Not selected'\n        ),\n        _buildReviewItem('Profile Image', \n          _selectedProfileImagePath != null ? 'Uploaded' : 'Default image'\n        ),\n        \n        // Address Info Review\n        _buildReviewSectionTitle('Address Information'),\n        _buildReviewItem('Bio', bioController.text),\n        _buildReviewItem('Locality', localityController.text),\n        _buildReviewItem('City', cityController.text),\n        _buildReviewItem('State', stateController.text),\n        \n        // Caretaker Specific Review\n        if (widget.role == 'caretaker') ...[\n          _buildReviewSectionTitle('Caretaker Details'),\n          _buildReviewItem('Caregiver Type', \n            _caregiverType == CaregiverType.relative ? 'Family Relative' : 'Professional Nurse'\n          ),\n          if (_caregiverType == CaregiverType.relative)\n            _buildReviewItem('Relation to Patient', relationController.text),\n          if (_caregiverType == CaregiverType.nurse) ...[\n            _buildReviewItem('Years of Experience', '${experienceYearsController.text} years'),\n            _buildReviewItem('Professional Experience', expBioController.text),\n            _buildReviewItem('Nursing Qualification', gradNursingController.text),\n            _buildReviewItem('Graduation Certificate', \n              _selectedCertificatePath != null ? 'Uploaded ✓' : 'Not uploaded'\n            ),\n          ]\n        ],\n        \n        const SizedBox(height: 24),\n        Container(\n          padding: const EdgeInsets.all(16),\n          decoration: BoxDecoration(\n            color: Colors.blueAccent.withOpacity(0.05),\n            borderRadius: BorderRadius.circular(12),\n            border: Border.all(color: Colors.blueAccent.withOpacity(0.2)),\n          ),\n          child: Row(\n            children: [\n              Icon(Icons.info_outline, color: Colors.blueAccent, size: 20),\n              const SizedBox(width: 12),\n              Expanded(\n                child: Text(\n                  'By submitting, you agree to our Terms of Service and Privacy Policy',\n                  style: TextStyle(\n                    fontSize: 14,\n                    color: Colors.grey.shade700,\n                  ),\n                ),\n              ),\n            ],\n          ),\n        ),\n      ],\n    );\n  }\n\n  Widget _buildSectionHeader({required String title, required String subtitle, required IconData icon}) {\n    return Row(\n      crossAxisAlignment: CrossAxisAlignment.start,\n      children: [\n        Container(\n          padding: const EdgeInsets.all(8),\n          decoration: BoxDecoration(\n            color: Colors.blueAccent.withOpacity(0.1),\n            shape: BoxShape.circle,\n          ),\n          child: Icon(icon, color: Colors.blueAccent, size: 24),\n        ),\n        const SizedBox(width: 12),\n        Expanded(\n          child: Column(\n            crossAxisAlignment: CrossAxisAlignment.start,\n            children: [\n              Text(\n                title,\n                style: const TextStyle(\n                  fontSize: 22,\n                  fontWeight: FontWeight.bold,\n                  color: Colors.blueAccent,\n                ),\n              ),\n              const SizedBox(height: 4),\n              Text(\n                subtitle,\n                style: TextStyle(\n                  fontSize: 14,\n                  color: Colors.grey.shade600,\n                ),\n              ),\n            ],\n          ),\n        ),\n      ],\n    );\n  }\n\n  Widget _buildReviewSectionTitle(String title) {\n    return Padding(\n      padding: const EdgeInsets.only(top: 16, bottom: 12),\n      child: Text(\n        title,\n        style: const TextStyle(\n          fontSize: 18,\n          fontWeight: FontWeight.w600,\n          color: Colors.blueAccent,\n        ),\n      ),\n    );\n  }\n\n  Widget _buildReviewItem(String label, String value) {\n    return Container(\n      margin: const EdgeInsets.only(bottom: 8),\n      padding: const EdgeInsets.all(12),\n      decoration: BoxDecoration(\n        color: Colors.grey.shade50,\n        borderRadius: BorderRadius.circular(8),\n        border: Border.all(color: Colors.grey.shade200),\n      ),\n      child: Row(\n        crossAxisAlignment: CrossAxisAlignment.start,\n        children: [\n          Expanded(\n            flex: 2,\n            child: Text(\n              '$label:',\n              style: const TextStyle(\n                fontWeight: FontWeight.w500,\n                color: Colors.black87,\n              ),\n            ),\n          ),\n          Expanded(\n            flex: 3,\n            child: Text(\n              value.isEmpty ? 'Not provided' : value,\n              style: TextStyle(\n                color: value.isEmpty ? Colors.grey.shade500 : Colors.grey.shade800,\n              ),\n            ),\n          ),\n        ],\n      ),\n    );\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      resizeToAvoidBottomInset: true,\n      appBar: AppBar(\n        title: Text(\n          'Register as ${widget.role == 'caretaker' ? 'Caregiver' : 'User'}',\n          style: const TextStyle(\n            fontWeight: FontWeight.bold,\n            color: Colors.white,\n          ),\n        ),\n        backgroundColor: Colors.blueAccent,\n        elevation: 0,\n        centerTitle: true,\n        iconTheme: const IconThemeData(color: Colors.white),\n      ),\n      body: Container(\n        decoration: const BoxDecoration(\n          gradient: LinearGradient(\n            begin: Alignment.topCenter,\n            end: Alignment.bottomCenter,\n            colors: [\n              Colors.blueAccent,\n              Color(0xFFE3F2FD),\n              Colors.white,\n            ],\n            stops: [0.0, 0.2, 0.2],\n          ),\n        ),\n        child: Column(\n          children: [\n            // Progress Indicator\n            Container(\n              padding: const EdgeInsets.all(24.0),\n              decoration: BoxDecoration(\n                color: Colors.white,\n                borderRadius: const BorderRadius.only(\n                  bottomLeft: Radius.circular(30),\n                  bottomRight: Radius.circular(30),\n                ),\n                boxShadow: [\n                  BoxShadow(\n                    color: Colors.black.withOpacity(0.1),\n                    blurRadius: 10,\n                    offset: const Offset(0, 2),\n                  ),\n                ],\n              ),\n              child: _buildProgressIndicator(),\n            ),\n\n            // Form Content\n            Expanded(\n              child: Container(\n                margin: const EdgeInsets.all(16),\n                decoration: BoxDecoration(\n                  color: Colors.white,\n                  borderRadius: BorderRadius.circular(20),\n                  boxShadow: [\n                    BoxShadow(\n                      color: Colors.black.withOpacity(0.05),\n                      blurRadius: 20,\n                      offset: const Offset(0, 5),\n                    ),\n                  ],\n                ),\n                child: SingleChildScrollView(\n                  padding: const EdgeInsets.all(24.0),\n                  child: Column(\n                    crossAxisAlignment: CrossAxisAlignment.start,\n                    children: [\n                      if (_currentSection == FormSection.personal)\n                        _buildPersonalSection(),\n                      if (_currentSection == FormSection.address)\n                        _buildAddressSection(),\n                      if (_currentSection == FormSection.caretaker)\n                        _buildCaretakerSection(),\n                      if (_currentSection == FormSection.review)\n                        _buildReviewSection(),\n\n                      const SizedBox(height: 32),\n                    ],\n                  ),\n                ),\n              ),\n            ),\n\n            // Navigation Buttons\n            Container(\n              padding: const EdgeInsets.all(16.0),\n              decoration: BoxDecoration(\n                color: Colors.white,\n                boxShadow: [\n                  BoxShadow(\n                    color: Colors.black.withOpacity(0.1),\n                    blurRadius: 10,\n                    offset: const Offset(0, -2),\n                  ),\n                ],\n              ),\n              child: Row(\n                children: [\n                  // Back Button\n                  if (_currentSection != FormSection.personal)\n                    Expanded(\n                      child: OutlinedButton(\n                        onPressed: _previousSection,\n                        style: OutlinedButton.styleFrom(\n                          padding: const EdgeInsets.symmetric(vertical: 16),\n                          shape: RoundedRectangleBorder(\n                            borderRadius: BorderRadius.circular(12),\n                          ),\n                          side: BorderSide(color: Colors.blueAccent),\n                        ),\n                        child: const Row(\n                          mainAxisAlignment: MainAxisAlignment.center,\n                          children: [\n                            Icon(Icons.arrow_back_ios, size: 16),\n                            SizedBox(width: 8),\n                            Text(\n                              'Back',\n                              style: TextStyle(\n                                fontSize: 16,\n                                color: Colors.blueAccent,\n                              ),\n                            ),\n                          ],\n                        ),\n                      ),\n                    ),\n                  if (_currentSection != FormSection.personal)\n                    const SizedBox(width: 16),\n\n                  // Next/Submit Button\n                  Expanded(\n                    child: _loading\n                        ? Container(\n                            height: 56,\n                            decoration: BoxDecoration(\n                              color: Colors.blueAccent,\n                              borderRadius: BorderRadius.circular(12),\n                            ),\n                            child: const Center(\n                              child: SizedBox(\n                                width: 20,\n                                height: 20,\n                                child: CircularProgressIndicator(\n                                  strokeWidth: 2,\n                                  valueColor: AlwaysStoppedAnimation<Color>(Colors.white),\n                                ),\n                              ),\n                            ),\n                          )\n                        : ElevatedButton(\n                            onPressed: _nextSection,\n                            style: ElevatedButton.styleFrom(\n                              backgroundColor: Colors.blueAccent,\n                              padding: const EdgeInsets.symmetric(vertical: 16),\n                              shape: RoundedRectangleBorder(\n                                borderRadius: BorderRadius.circular(12),\n                              ),\n                              elevation: 2,\n                            ),\n                            child: Row(\n                              mainAxisAlignment: MainAxisAlignment.center,\n                              children: [\n                                Text(\n                                  _currentSection == FormSection.review\n                                      ? 'Complete Registration'\n                                      : 'Continue',\n                                  style: const TextStyle(\n                                    fontSize: 16,\n                                    fontWeight: FontWeight.w600,\n                                    color: Colors.white,\n                                  ),\n                                ),\n                                if (_currentSection != FormSection.review)\n                                  const Row(\n                                    children: [\n                                      SizedBox(width: 8),\n                                      Icon(Icons.arrow_forward_ios, size: 16),\n                                    ],\n                                  ),\n                              ],\n                            ),\n                          ),\n                  ),\n                ],\n              ),\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  Widget _buildTextField(\n    TextEditingController controller,\n    String label,\n    IconData icon, {\n    bool obscureText = false,\n    TextInputType? keyboardType,\n    int maxLines = 1,\n  }) {\n    return Container(\n      margin: const EdgeInsets.only(bottom: 16),\n      child: TextField(\n        controller: controller,\n        maxLines: maxLines,\n        obscureText: obscureText,\n        keyboardType: keyboardType,\n        style: TextStyle(\n          fontSize: 16,\n          color: Colors.grey.shade800,\n        ),\n        decoration: InputDecoration(\n          labelText: label,\n          labelStyle: TextStyle(\n            color: Colors.grey.shade600,\n          ),\n          border: OutlineInputBorder(\n            borderRadius: BorderRadius.circular(12),\n            borderSide: BorderSide(color: Colors.grey.shade300),\n          ),\n          enabledBorder: OutlineInputBorder(\n            borderRadius: BorderRadius.circular(12),\n            borderSide: BorderSide(color: Colors.grey.shade300),\n          ),\n          focusedBorder: OutlineInputBorder(\n            borderRadius: BorderRadius.circular(12),\n            borderSide: const BorderSide(color: Colors.blueAccent, width: 2),\n          ),\n          filled: true,\n          fillColor: Colors.white,\n          prefixIcon: Icon(\n            icon,\n            color: Colors.blueAccent,\n          ),\n          contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),\n        ),\n      ),\n    );\n  }\n}",
      "_encoding": "utf-8"
    },
    "report_page.dart": {
      "_text": "import 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/material.dart';\n\nclass ReportPage extends StatefulWidget {\n  final String reporterRole; // 'user' or 'caretaker'\n  const ReportPage({super.key, required this.reporterRole});\n\n  @override\n  State<ReportPage> createState() => _ReportPageState();\n}\n\nclass _ReportPageState extends State<ReportPage> {\n  final TextEditingController _usernameController = TextEditingController();\n  final TextEditingController _titleController = TextEditingController();\n  final TextEditingController _descriptionController = TextEditingController();\n  bool _userFound = false;\n\n  Future<void> _searchUser() async {\n    final coll = widget.reporterRole == 'user' ? 'caretaker' : 'user';\n    final snap = await FirebaseFirestore.instance\n        .collection(coll)\n        .where('username', isEqualTo: _usernameController.text.trim())\n        .get();\n    setState(() => _userFound = snap.docs.isNotEmpty);\n  }\n\n  Future<void> _submitReport() async {\n    final uid = FirebaseAuth.instance.currentUser?.uid;\n    if (uid == null) return;\n\n    final coll = widget.reporterRole == 'user' ? 'caretaker' : 'user';\n    final snap = await FirebaseFirestore.instance\n        .collection(coll)\n        .where('username', isEqualTo: _usernameController.text.trim())\n        .get();\n\n    if (snap.docs.isEmpty) return;\n\n    final reportedUid = snap.docs.first.id;\n\n    await FirebaseFirestore.instance.collection('reports').add({\n      'sender_uid': uid,\n      'sender_role': widget.reporterRole,\n      'reported_uid': reportedUid,\n      'reported_role': coll,\n      'title': _titleController.text,\n      'description': _descriptionController.text,\n      'created_at': Timestamp.now(),\n      'seen': false,\n    });\n    if (mounted) {\n      ScaffoldMessenger.of(context).showSnackBar(\n        const SnackBar(content: Text('Report submitted')),\n      );\n      Navigator.pop(context);\n    }\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final targetRole = widget.reporterRole == 'user' ? 'Caretaker' : 'User';\n    return Scaffold(\n      appBar: AppBar(title: const Text('Report')),\n      body: Padding(\n        padding: const EdgeInsets.all(16),\n        child: Column(\n          children: [\n            TextField(\n              controller: _usernameController,\n              decoration: InputDecoration(labelText: 'Search $targetRole Username'),\n            ),\n            ElevatedButton(onPressed: _searchUser, child: const Text('Search')),\n            if (_userFound) ...[\n              TextField(\n                controller: _titleController,\n                decoration: const InputDecoration(labelText: 'Title'),\n              ),\n              TextField(\n                controller: _descriptionController,\n                decoration: const InputDecoration(labelText: 'Description'),\n              ),\n              ElevatedButton(onPressed: _submitReport, child: const Text('Submit')),\n            ],\n          ],\n        ),\n      ),\n    );\n  }\n}",
      "_encoding": "utf-8"
    },
    "welcome_page.dart": {
      "_text": "// lib/welcome_page.dart\nimport 'package:flutter/material.dart';\nimport 'package:flutter_animate/flutter_animate.dart';\nimport 'login_page.dart';\n\nclass WelcomePage extends StatelessWidget {\n  const WelcomePage({Key? key}) : super(key: key);\n\n  void _navigateTo(BuildContext context, String role) {\n    Navigator.push(\n      context,\n      MaterialPageRoute(\n        builder: (context) => LoginPage(role: role),\n      ),\n    );\n  }\n\n  void _showAdminDialog(BuildContext context) {\n  showDialog(\n    context: context,\n    builder: (context) => AlertDialog(\n      title: const Text('Admin Login'),\n      content: const Text('Proceed to admin login?'),\n      actions: [\n        TextButton(onPressed: () => Navigator.pop(context), child: const Text('Cancel')),\n        TextButton(onPressed: () {\n          Navigator.pop(context);\n          _navigateTo(context, 'admin');\n        }, child: const Text('Yes')),\n      ],\n    ),\n  );\n}\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      body: Container(\n        decoration: const BoxDecoration(\n          gradient: LinearGradient(\n            colors: [Colors.blueAccent, Colors.lightBlue],\n            begin: Alignment.topCenter,\n            end: Alignment.bottomCenter,\n          ),\n        ),\n        child: SafeArea(\n          child: Center(\n            child: Padding(\n              padding: const EdgeInsets.symmetric(horizontal: 24.0, vertical: 32.0),\n              child: Column(\n                mainAxisAlignment: MainAxisAlignment.center,\n                children: [\n                  GestureDetector(\n                      onLongPress: () => _showAdminDialog(context),\n                      child: const Text(\n                        'Welcome to DVMA',\n                      style: TextStyle(\n                        fontSize: 32,\n                        fontWeight: FontWeight.bold,\n                        color: Colors.white,\n                        letterSpacing: 1.2,\n                        shadows: [\n                          Shadow(\n                            blurRadius: 10.0,\n                            color: Colors.black26,\n                            offset: Offset(2.0, 2.0),\n                          ),\n                        ],\n                      ),\n                      textAlign: TextAlign.center,\n                    ),\n                  ).animate().fadeIn(duration: 800.ms).slideY(begin: -0.2),\n                  const SizedBox(height: 16),\n                  const Text(\n                    'Select your role to continue',\n                    style: TextStyle(\n                      fontSize: 18,\n                      color: Colors.white70,\n                      fontStyle: FontStyle.italic,\n                    ),\n                  ).animate().fadeIn(duration: 1000.ms).slideY(begin: 0.2),\n                  const SizedBox(height: 48),\n                  _buildRoleButton(\n                    context: context,\n                    icon: Icons.person,\n                    label: 'I am a User',\n                    role: 'user',\n                    gradient: const LinearGradient(\n                      colors: [Colors.blue, Colors.blueAccent],\n                    ),\n                  ),\n                  const SizedBox(height: 20),\n                  _buildRoleButton(\n                    context: context,\n                    icon: Icons.volunteer_activism,\n                    label: 'I am a Caretaker',\n                    role: 'caretaker',\n                    gradient: const LinearGradient(\n                      colors: [Colors.green, Colors.greenAccent],\n                    ),\n                  ),\n                ],\n              ),\n            ),\n          ),\n        ),\n      ),\n    );\n  }\n\n  Widget _buildRoleButton({\n    required BuildContext context,\n    required IconData icon,\n    required String label,\n    required String role,\n    required LinearGradient gradient,\n  }) {\n    return Card(\n      elevation: 8,\n      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n      child: InkWell(\n        onTap: () => _navigateTo(context, role),\n        borderRadius: BorderRadius.circular(12),\n        child: Container(\n          decoration: BoxDecoration(\n            gradient: gradient,\n            borderRadius: BorderRadius.circular(12),\n          ),\n          padding: const EdgeInsets.symmetric(vertical: 16, horizontal: 20),\n          child: Row(\n            children: [\n              Icon(icon, size: 30, color: Colors.white),\n              const SizedBox(width: 16),\n              Expanded(\n                child: Text(\n                  label,\n                  style: const TextStyle(\n                    fontSize: 18,\n                    fontWeight: FontWeight.w600,\n                    color: Colors.white,\n                  ),\n                ),\n              ),\n              const Icon(Icons.arrow_forward, color: Colors.white),\n            ],\n          ),\n        ),\n      ),\n    ).animate().scale(duration: 600.ms, delay: 200.ms, curve: Curves.easeOut);\n  }\n}",
      "_encoding": "utf-8"
    }
  }
}