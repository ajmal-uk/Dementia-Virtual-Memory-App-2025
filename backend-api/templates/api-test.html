<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Face Recognition Tester</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; max-width: 700px; }
  input, textarea, button { margin: 5px 0; padding: 8px; width: 100%; }
  label { font-weight: bold; margin-top: 15px; display: block; }
  .member { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; position: relative; }
  .member img { max-height: 80px; max-width: 80px; object-fit: contain; border: 1px solid #999; }
  .delete-btn { position: absolute; right: 10px; top: 10px; background: red; color: white; border: none; cursor: pointer; }
  #response { white-space: pre-wrap; background: #f0f0f0; padding: 10px; margin-top: 15px; }
</style>
</head>
<body>

<h1>Face Recognition Test</h1>

<!-- Form to add member -->
<div>
  <label>Member Name</label>
  <input type="text" id="memberName" placeholder="Enter member name" />
  
  <label>Member Relation</label>
  <input type="text" id="memberRelation" placeholder="Enter member relation" />
  
  <label>Member Image URL</label>
  <input type="text" id="memberImageUrl" placeholder="Enter member image URL" />
  
  <button id="addMemberBtn">Add Member</button>
</div>

<h2>Members</h2>
<div id="membersList"></div>

<hr>

<label>Test Image URL</label>
<input type="text" id="testImageUrl" placeholder="Enter image URL to test" />

<button id="testBtn">Test Recognition</button>

<h2>Response</h2>
<pre id="response">No response yet.</pre>

<script>
  const membersKey = 'faceRecMembers';

  // Load members from localStorage or empty array
  let members = JSON.parse(localStorage.getItem(membersKey) || '[]');

  // Show members in the list
  function renderMembers() {
    const container = document.getElementById('membersList');
    container.innerHTML = '';
    if (members.length === 0) {
      container.innerHTML = '<i>No members added yet.</i>';
      return;
    }
    members.forEach((m, idx) => {
      const div = document.createElement('div');
      div.className = 'member';
      
      // Create image element from base64
      const img = document.createElement('img');
      img.src = `data:image/jpeg;base64,${m.memberImage}`;
      div.appendChild(img);

      // Add member details
      const details = document.createElement('div');
      details.style.marginLeft = '100px';
      details.innerHTML = `
        <strong>${m.memberName}</strong><br/>
        Relation: ${m.memberRelation}<br/>
        URL: ${m.memberImageUrl}
      `;
      div.appendChild(details);

      // Delete button
      const delBtn = document.createElement('button');
      delBtn.className = 'delete-btn';
      delBtn.textContent = 'X';
      delBtn.title = 'Delete member';
      delBtn.onclick = () => {
        if (confirm(`Delete member ${m.memberName}?`)) {
          members.splice(idx, 1);
          saveMembers();
          renderMembers();
        }
      };
      div.appendChild(delBtn);

      container.appendChild(div);
    });
  }

  // Save members to localStorage
  function saveMembers() {
    localStorage.setItem(membersKey, JSON.stringify(members));
  }

  // Convert image URL to base64 string (without prefix)
  async function urlToBase64(url) {
    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error('Failed to fetch image');
      const blob = await response.blob();
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64Img = reader.result;
          const base64Data = base64Img.split(',')[1]; // base64 without prefix
          resolve(base64Data);
        };
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    } catch (err) {
      throw err;
    }
  }

  // Add member button click handler
  document.getElementById('addMemberBtn').addEventListener('click', async () => {
    const name = document.getElementById('memberName').value.trim();
    const relation = document.getElementById('memberRelation').value.trim();
    const imageUrl = document.getElementById('memberImageUrl').value.trim();

    if (!name || !relation || !imageUrl) {
      alert('Please fill all fields.');
      return;
    }

    try {
      const base64Data = await urlToBase64(imageUrl);

      members.push({
        memberName: name,
        memberRelation: relation,
        memberImage: base64Data,
        memberImageUrl: imageUrl  // Store the original URL
      });

      saveMembers();
      renderMembers();

      // Clear inputs
      document.getElementById('memberName').value = '';
      document.getElementById('memberRelation').value = '';
      document.getElementById('memberImageUrl').value = '';

    } catch (err) {
      alert('Failed to load image from URL: ' + err.message);
    }
  });

  // Test recognition button click handler
  document.getElementById('testBtn').addEventListener('click', async () => {
    const url = document.getElementById('testImageUrl').value.trim();
    if (!url) {
      alert('Please enter an imageUrl to test');
      return;
    }
    if (members.length === 0) {
      alert('Please add at least one member before testing');
      return;
    }

    // Prepare form data as per backend expectation
    const formData = new FormData();
    formData.append('imageUrl', url);
    formData.append('members', JSON.stringify(members));

    try {
      const res = await fetch('/recognize', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();
      document.getElementById('response').textContent = JSON.stringify(data, null, 2);
    } catch (err) {
      document.getElementById('response').textContent = 'Error: ' + err.message;
    }
  });

  // Initial render
  renderMembers();
</script>

</body>
</html>